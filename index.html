<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/img/lufei.ico?v=5.1.2" />






<meta name="description" content="世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也">
<meta property="og:type" content="website">
<meta property="og:title" content="Youmai の Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Youmai の Blog">
<meta property="og:description" content="世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Youmai の Blog">
<meta name="twitter:description" content="世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Youmai の Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-63551049-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Youmai の Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/01/真实世界中的WebRTC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/01/真实世界中的WebRTC/" itemprop="url">真实世界中的WebRTC：STUN, TURN and signaling</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-01T10:16:13+08:00">
                2018-08-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebRTC/" itemprop="url" rel="index">
                    <span itemprop="name">WebRTC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>WebRTC使端到端能够通信。</p>
<p>但是…</p>
<p>WebRTC仍然需要服务器：</p>
<ul>
<li>让客户端交换元数据来协调通信：这被称为信令（signaling）</li>
<li>处理网络地址转换（NATs）和防火墙</li>
</ul>
<p>这篇文章将会展示如何搭建一个信令服务</p>
<p>在本文中，我们将向您展示如何构建信令服务，以及如何使用STUN和TURN服务器处理真实连接的难题。 我们还解释了WebRTC应用程序如何处理多方通话以及与VoIP和PSTN（又称电话）等服务进行交互。</p>
<h3 id="什么是信令"><a href="#什么是信令" class="headerlink" title="什么是信令"></a>什么是信令</h3><p>信令是协调通信的过程。 为了使WebRTC应用程序能够建立一个“通话”，其客户端需要交换以下信息：</p>
<ul>
<li>会话控制消息用于打开或关闭通信</li>
<li>错误消息</li>
<li>媒体元数据，如编解码器和编解码器设置，带宽和媒体类型</li>
<li>密钥数据，用于建立安全的连接</li>
<li>网络数据，如：外界看到的主机IP地址和端口</li>
</ul>
<p>此信令过程需要一种方法让客户端来回传递消息。 WebRTC API不实现该机制：你需要自己构建它。 我们在下面描述了构建信令服务的一些方法。 首先，需要一点背景…</p>
<h3 id="为什么信令不是由WebRTC定义的？"><a href="#为什么信令不是由WebRTC定义的？" class="headerlink" title="为什么信令不是由WebRTC定义的？"></a>为什么信令不是由WebRTC定义的？</h3><p>为了避免出现冗余，并最大限度地提高与已有技术的兼容性，WebRTC标准并没有规定信令方法和协议。<a href="http://tools.ietf.org/html/draft-ietf-rtcweb-jsep-03#section-1.1" target="_blank" rel="external">JavaScript会话建立协议</a>JSEP概述了这种方法：</p>
<blockquote>
<p>WebRTC通话建立的思想是完全指定和控制媒体平面，但是尽可能将信令平面留给应用程序。其原理是，不同的应用程序可能更喜欢使用不同的协议，例如现有的SIP或Jingle呼叫信令协议，或者对于特定应用程序定制的东西，可能是针对新颖的用例。在这种方法中，需要交换的关键信息是多媒体会话描述，其指定了建立媒体平面所必需的传输和媒体配置信息。</p>
</blockquote>
<p>JSEP的架构也避免了浏览器不得不保存状态，即作为一个信令状态机。如果信令数据在每次刷新页面的时候都会发生丢失，就会出现问题。相反，信令状态机可以保存在服务器上。</p>
<p><img src="/img/jsep.png" alt="jsep arch"></p>
<p>JSEP要求端之间交换offer和answer：上面提到的媒体元数据。offer和answer以会话描述协议（SDP）的格式传递，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">v=0</div><div class="line">o=- 7614219274584779017 2 IN IP4 127.0.0.1</div><div class="line">s=-</div><div class="line">t=0 0</div><div class="line">a=group:BUNDLE audio video</div><div class="line">a=msid-semantic: WMS</div><div class="line">m=audio 1 RTP/SAVPF 111 103 104 0 8 107 106 105 13 126</div><div class="line">c=IN IP4 0.0.0.0</div><div class="line">a=rtcp:1 IN IP4 0.0.0.0</div><div class="line">a=ice-ufrag:W2TGCZw2NZHuwlnf</div><div class="line">a=ice-pwd:xdQEccP40E+P0L5qTyzDgfmW</div><div class="line">a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level</div><div class="line">a=mid:audio</div><div class="line">a=rtcp-mux</div><div class="line">a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:9c1AHz27dZ9xPI91YNfSlI67/EMkjHHIHORiClQe</div><div class="line">a=rtpmap:111 opus/48000/2</div><div class="line">…</div></pre></td></tr></table></figure>
<p>想知道所有这些SDP gobbledygook实际意味着什么？ 看看<a href="http://datatracker.ietf.org/doc/draft-nandakumar-rtcweb-sdp/?include_text=1" target="_blank" rel="external">IETF的例子</a>。</p>
<p>需要记住的是，WebRTC被设计为在被设置为本地或者远端描述之前，通过编辑SDP文本中的值，可以扭转offer或者answer。例如，<a href="https://appr.tc/" target="_blank" rel="external">apprtc.tc</a>中的preferAudioCodec()函数可用于设置默认编解码器和比特率。使用 JavaScript处理SDP有些困难，有一些关于WebRTC的未来版本中是否应该使用JSON的讨论，但是坚持使用SDP还是有一些<a href="http://tools.ietf.org/html/draft-ietf-rtcweb-jsep-03#section-3.3" target="_blank" rel="external">优势</a>的。</p>
<h3 id="RTCPeerConnection-signaling-offer-answer-and-candidate"><a href="#RTCPeerConnection-signaling-offer-answer-and-candidate" class="headerlink" title="RTCPeerConnection + signaling: offer, answer and candidate"></a>RTCPeerConnection + signaling: offer, answer and candidate</h3><p>RTCPeerConnection是WebRTC应用程序用来创建端对端连接并传输音视频的API。</p>
<p>为初始化这个过程，RTCPeerConnection有两个工作要做：</p>
<ul>
<li>确定本地媒体条件，如分辨率和编解码器功能。这是用于offer和answer机制的元数据。</li>
<li>获取应用程序主机的潜在网络地址，成为候选人（candidates）</li>
</ul>
<p>一旦确定了本地数据，就必须通过信令机制与远端进行交换。</p>
<p>让我们假设一个场景：<a href="https://xkcd.com/177/" target="_blank" rel="external">Alice正在尝试呼叫Eve</a>。下面是完整的offer/answer机制：</p>
<ol>
<li>Alice创建一个RTCPeerConnection对象。</li>
<li>Alice使用RTCPeerConnection createOffer()方法产生一个offer（一个SDP会话描述）。</li>
<li>Alice用他的offer调用setLocalDescription()。</li>
<li>Alice将offer字符串化，并使用信令机制将其发送给Eve。</li>
<li>Eve用Alice的offer调用setRemoteDescription()，以便她的RTCPeerConnection知道Alice的设置。</li>
<li>Eve调用createAnswer()，成功的回调是传入一个本地的会话描述：Eve的answer。</li>
<li>Eve通过调用setLocalDescription()将其answer设置为本地描述。</li>
<li>Eve然后使用信令机制将她的字符串化的answer发回给Alice。</li>
<li>Alice使用setRemoteDescription()将Eve的应答设置为远程会话描述。</li>
</ol>
<p>Alice和Eve也需要交换网络信息。“查找候选人（find candidate）”这个表达是指使用<a href="http://en.wikipedia.org/wiki/Interactive_Connectivity_Establishment" target="_blank" rel="external">ICE框架</a>查找网络接口和端口的过程。</p>
<ol>
<li>Alice使用onicecandidate handler创建一个RTCPeerConnection对象。</li>
<li>handler在网络候选人变得可用时被调用。</li>
<li>在handler中，Alice通过他们的信令通道将字符串化的候选数据发送给Eve。</li>
<li>当Eve从Alice那里获得候选消息时，她调用addIceCandidate()，将候选项添加到远端描述中。</li>
</ol>
<p>JSEP支持<a href="http://tools.ietf.org/html/draft-ietf-rtcweb-jsep-03#section-3.4.1" target="_blank" rel="external">ICE Candidate Trickling</a>，它允许主叫方(caller)在最初的offer之后递增地向被叫方提供候选项（candidates），并使被叫方开始在通话中进行操作并建立连接而不用等所有候选项到达。</p>
<h3 id="WebRTC信令代码"><a href="#WebRTC信令代码" class="headerlink" title="WebRTC信令代码"></a>WebRTC信令代码</h3><p>下面的<a href="https://w3c.github.io/webrtc-pc/#simple-peer-to-peer-example" target="_blank" rel="external">W3C代码示例</a>总结了一个完整的信令过程。该代码假定存在一些信令机制，SignalingChannel。我们会在下文中更详细地讨论信令。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// handles JSON.stringify/parse</span></div><div class="line"><span class="keyword">const</span> signaling = <span class="keyword">new</span> SignalingChannel();</div><div class="line"><span class="keyword">const</span> constraints = &#123;<span class="attr">audio</span>: <span class="literal">true</span>, <span class="attr">video</span>: <span class="literal">true</span>&#125;;</div><div class="line"><span class="keyword">const</span> configuration = &#123;<span class="attr">iceServers</span>: [&#123;<span class="attr">urls</span>: <span class="string">'stuns:stun.example.org'</span>&#125;]&#125;;</div><div class="line"><span class="keyword">const</span> pc = <span class="keyword">new</span> RTCPeerConnection(configuration);</div><div class="line"></div><div class="line"><span class="comment">// send any ice candidates to the other peer</span></div><div class="line">pc.onicecandidate = <span class="function">(<span class="params">&#123;candidate&#125;</span>) =&gt;</span> signaling.send(&#123;candidate&#125;);</div><div class="line"></div><div class="line"><span class="comment">// let the "negotiationneeded" event trigger offer generation</span></div><div class="line">pc.onnegotiationneeded = <span class="keyword">async</span> () =&gt; &#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">await</span> pc.setLocalDescription(<span class="keyword">await</span> pc.createOffer());</div><div class="line">    <span class="comment">// send the offer to the other peer</span></div><div class="line">    signaling.send(&#123;<span class="attr">desc</span>: pc.localDescription&#125;);</div><div class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.error(err);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// once remote track media arrives, show it in remote video element</span></div><div class="line">pc.ontrack = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">// don't set srcObject again if it is already set.</span></div><div class="line">  <span class="keyword">if</span> (remoteView.srcObject) <span class="keyword">return</span>;</div><div class="line">  remoteView.srcObject = event.streams[<span class="number">0</span>];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// call start() to initiate</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// get local stream, show it in self-view and add it to be sent</span></div><div class="line">    <span class="keyword">const</span> stream =</div><div class="line">      <span class="keyword">await</span> navigator.mediaDevices.getUserMedia(constraints);</div><div class="line">    stream.getTracks().forEach(<span class="function">(<span class="params">track</span>) =&gt;</span></div><div class="line">      pc.addTrack(track, stream));</div><div class="line">    selfView.srcObject = stream;</div><div class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.error(err);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">signaling.onmessage = <span class="keyword">async</span> (&#123;desc, candidate&#125;) =&gt; &#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">if</span> (desc) &#123;</div><div class="line">      <span class="comment">// if we get an offer, we need to reply with an answer</span></div><div class="line">      <span class="keyword">if</span> (desc.type === <span class="string">'offer'</span>) &#123;</div><div class="line">        <span class="keyword">await</span> pc.setRemoteDescription(desc);</div><div class="line">        <span class="keyword">const</span> stream =</div><div class="line">          <span class="keyword">await</span> navigator.mediaDevices.getUserMedia(constraints);</div><div class="line">        stream.getTracks().forEach(<span class="function">(<span class="params">track</span>) =&gt;</span></div><div class="line">          pc.addTrack(track, stream));</div><div class="line">        <span class="keyword">await</span> pc.setLocalDescription(<span class="keyword">await</span> pc.createAnswer());</div><div class="line">        signaling.send(&#123;<span class="attr">desc</span>: pc.localDescription&#125;);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (desc.type === <span class="string">'answer'</span>) &#123;</div><div class="line">        <span class="keyword">await</span> pc.setRemoteDescription(desc);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Unsupported SDP type.'</span>);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (candidate) &#123;</div><div class="line">      <span class="keyword">await</span> pc.addIceCandidate(candidate);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.error(err);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>要查看实际offer/answer和候选项的交流过程，请参阅<a href="https://simpl.info/rtcpeerconnection/" target="_blank" rel="external">simpl.info/pc</a>上的“单页”视频聊天示例的控制台日志。如果你想知道更多，请从Chrome的chrome://webrtc-internals页面或者Opera中的opera://webrtc-internals页面下载WebRTC 信令和统计数据的完整转储。</p>
<h3 id="对端发现"><a href="#对端发现" class="headerlink" title="对端发现"></a>对端发现</h3><p>这是“我该如何找到我要交谈的人”的一种高端说法。</p>
<p>对于电话来说，我们有电话号码和目录。对于在线视频聊天和消息发送，我们需要身份和状态管理系统，以及用户启动会话的方式。WebRTC应用程序需要一种方式让客户互相通知他们想要开始或加入一个通话。</p>
<p>端发现机制不是由WebRTC定义的。这个过程可以像发送电子邮件或发送一个URL一样简单：对于视频聊天应用程序，比如talky.io，tawk.com和browsermeeting.com，您可以通过共享自定义链接来邀请人们进行通话。开发人员Chris Ball已经搭建了一个有趣的<a href="https://blog.printf.net/articles/2013/05/17/webrtc-without-a-signaling-server/" target="_blank" rel="external">无服务器的webrtc实验</a>，使WebRTC呼叫参与者能够通过他们喜欢的任何消息服务来交换元数据。</p>
<h3 id="我怎么才能建立一个信令服务？"><a href="#我怎么才能建立一个信令服务？" class="headerlink" title="我怎么才能建立一个信令服务？"></a>我怎么才能建立一个信令服务？</h3><p>重申：信令协议和机制不是由WebRTC标准定义的。无论你选择什么，你都需要一个中间服务器来在客户端之间交换信令消息和应用程序数据。不走运的是，一个网络应用程序不能简单地向互联网喊“连接到我朋友那！”</p>
<p>幸亏信令消息很小，而且大多在通话开始的时候进行交换。在使用<a href="http://appr.tc/" target="_blank" rel="external">appr.tc</a>进行测试时，我们发现对于视频聊天会话，信令服务总共处理了30-45条消息，总共消息的大小大约为10KB。</p>
<p>WebRTC 信令业务在带宽方面的要求相对较低，因为它们只需要中继消息并保留少量的会话状态数据（如连接的客户端），同样不会消耗太多的处理或存储空间。</p>
<blockquote>
<p>小贴士：用于交换会话元数据的信令机制也可用于传送应用程序数据。这只是一个消息服务而已！。</p>
</blockquote>
<h3 id="将消息从服务器推送到客户端"><a href="#将消息从服务器推送到客户端" class="headerlink" title="将消息从服务器推送到客户端"></a>将消息从服务器推送到客户端</h3><p>信令的消息服务需要是双向的：客户端到服务器和服务器到客户端。双向通信违背了HTTP客户端/服务器的请求/响应模型，但是为了将数据从运行在Web服务器上的服务推送到运行在浏览器中的Web应用程序，多年来已经开发了诸如<a href="https://en.wikipedia.org/wiki/Comet_(programming" target="_blank" rel="external">长轮询</a>)之类的各种hac<br>k方法。</p>
<p>最近，<a href="http://www.html5rocks.com/en/tutorials/eventsource/basics/" target="_blank" rel="external">EventSource API</a>已经得到了广泛的实现。这开启了 “服务器发送的事件”：通过HTTP从Web服务器发送到浏览器客户端的数据。在<a href="http://simpl.info/es" target="_blank" rel="external">simpl.info/es</a>上有一个简单的演示。EventSource是为单向消息传递而设计的，但是它可以和XHR结合使用来搭建交换信令消息的服务：信令服务器通过XHR请求传递来自呼叫者的消息，通过EventSource推送给被叫者。</p>
<p><a href="http://www.html5rocks.com/en/tutorials/websockets/basics/" target="_blank" rel="external">WebSocket</a>是一个更自然的解决方案，专为全双工客户端-服务器通信而设计（消息可以同时在两个方向上传输）。使用纯WebSocket或Server-Sent Events（EventSource）构建的信令服务的一个优点是这些API的后端可以在大多数Web托管软件包通用的各种Web框架上实现，比如PHP，Python和Ruby。</p>
<p>大约四分之三的浏览器都<a href="http://caniuse.com/#search=websocket" target="_blank" rel="external">支持WebSocket</a>，更重要的是，所有支持WebRTC的浏览器都支持WebSocket，无论是在台式机还是手机上。应该为所有连接都使用<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="external">TLS</a>，以确保消息不会因为没有加密而被截取，并且<a href="http://www.infoq.com/articles/Web-Sockets-Proxy-Servers" target="_blank" rel="external">减少代理遍历</a>的问题。（有关WebSocket和代理遍历的更多信息，请参阅Ilya Grigorik的高性能浏览器网络中的<a href="http://hpbn.co/webrtc" target="_blank" rel="external">WebRTC章节</a>。Peter Lubber的<a href="http://refcardz.dzone.com/refcardz/html5-websocket" target="_blank" rel="external">WebSocket备忘单</a>提供了有关WebSocket客户端和服务器的更多信息）</p>
<p>用于标准的<a href="http://appr.tc/" target="_blank" rel="external">appr.tc</a> WebRTC视频聊天应用程序的信令通过<a href="https://developers.google.com/appengine/docs/java/channel/" target="_blank" rel="external">Google App Engine Channel API</a>完成，该API使用<a href="http://en.wikipedia.org/wiki/Comet_(programming" target="_blank" rel="external">Comet</a>)技术（长轮询）来启用App Engine后端与Web客户端之间推送通信的信令传输。<a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/" target="_blank" rel="external">HTML5 Rocks WebRTC文章</a>中<a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/#toc-simple" target="_blank" rel="external">详细介绍</a>了该应用程序的代码演示。</p>
<p><img src="/img/apprtc_in_action.jpg" alt="apprtc_in_action"></p>
<p>也可以通过让WebRTC客户端通过Ajax轮询消息服务器来处理信令，但这回导致大量的冗余网络请求，尤其对于移动设备是有问题的。即使在会话建立之后，对端也需要轮询信令消息，以防其他端发生改变或终止会话。<a href="http://webrtcbook.com/" target="_blank" rel="external">WebRTC Book</a> app示例使用此选项，并对轮询频率进行了一些优化。</p>
<h3 id="扩展信令"><a href="#扩展信令" class="headerlink" title="扩展信令"></a>扩展信令</h3><p>尽管信令服务消耗客户端带宽和CPU相对较少，但是一个很受欢迎的应用程序的信令服务器可能需要处理来自不同位置的大量消息，而且并发性较高。有大量流量的WebRTC应用程序需要能够处理相当大负载的信令服务器。</p>
<p>在这里我们不会对其进行详细讨论，但是对于大容量、高性能的消息传递有很多选择，包括：</p>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Xmpp" target="_blank" rel="external">eXtensible Messaging and Presence Protocol</a>（XMPP），最初是叫Jabber：一个为即时消息而开发的可用于信令的协议。服务器实现包括<a href="http://en.wikipedia.org/wiki/Ejabberd" target="_blank" rel="external">ejabberd</a>和<a href="http://en.wikipedia.org/wiki/Openfire" target="_blank" rel="external">Openfire</a>。Strophe.js等 JavaScript等客户端使用BOSH模拟双向流，但由于各种原因，BOSH可能不如WebSocket高效，同样的原因可能导致无法很好地扩展缩放。（跳离正题：Jingle是一个支持语音和视频的XMPP扩展；WebRTC项目使用来自libjingle库，一个Jingle的C++实现，的网络和传输组件。）</li>
<li>开源的库，如<a href="http://zeromq.org/" target="_blank" rel="external">ZeroMQ</a>（TokBox在他们的<a href="http://www.tokbox.com/blog/tokbox-builds-it%E2%80%99s-own-internal-messaging-infrastructure/" target="_blank" rel="external">Rumor</a>服务中使用它）和OpenMQ。NullMQ通过WebSocket使用<a href="http://stomp.github.io/" target="_blank" rel="external">STOMP协议</a>将ZeroMQ概念应用于Web平台。</li>
<li>使用WebSocket的商业云消息平台（尽管可能会回退到长轮询），例如Pusher，Kaazing和PubNub。（PubNub也有WebRTC的API）</li>
<li>像<a href="https://vline.com/" target="_blank" rel="external">vLine</a>这样的商业WebRTC平台。</li>
</ul>
<h3 id="在Node上使用Socket-io构建信令服务"><a href="#在Node上使用Socket-io构建信令服务" class="headerlink" title="在Node上使用Socket.io构建信令服务"></a>在Node上使用Socket.io构建信令服务</h3><p>下面是一个简单的Web应用程序的代码，它使用Node上的Socket.io构建的信令服务。Socket.io的设计使构建服务、交换信息变得简单，而且因为它内置了“房间”的概念，Socket.io特别适用于WebRTC 信令。<em>这个例子不是为了扩大产品级别的信令服务而设计的，但是对于相对较少的用户来说效果很好</em>。</p>
<p>Socket.io使用带有回退的WebSocket：AJAX长轮询，AJAX多部分流，Forever Iframe和JSONP轮询。它已被移植到各种后端，但也许最有名的是它的Node版本，我们将在下面的例子中使用它。</p>
<p>在这个例子中没有WebRTC：它的设计目的只是为了展示如何在一个Web应用程序中构建信令。查看控制台日志以查看客户端加入房间并且交换消息时发生的情况。我们的<a href="https://codelabs.developers.google.com/codelabs/webrtc-web/#0" target="_blank" rel="external">WebRTC codelab</a>提供了分步说明，解释了如何将这个例子集成到一个完整的WebRTC视频聊天应用程序。</p>
<p>下面是客户端, index.html:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebRTC client<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'/socket.io/socket.io.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'js/main.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>以及客户端中引用的JavaScript文件main.js：:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> isInitiator;</div><div class="line"></div><div class="line">room = prompt(<span class="string">'Enter room name:'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> socket = io.connect();</div><div class="line"></div><div class="line"><span class="keyword">if</span> (room !== <span class="string">''</span>) &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Joining room '</span> + room);</div><div class="line">  socket.emit(<span class="string">'create or join'</span>, room);</div><div class="line">&#125;</div><div class="line"></div><div class="line">socket.on(<span class="string">'full'</span>, (room) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Room '</span> + room + <span class="string">' is full'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">socket.on(<span class="string">'empty'</span>, (room) =&gt; &#123;</div><div class="line">  isInitiator = <span class="literal">true</span>;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Room '</span> + room + <span class="string">' is empty'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">socket.on(<span class="string">'join'</span>, (room) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Making request to join room '</span> + room);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'You are the initiator!'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">socket.on(<span class="string">'log'</span>, (array) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log.apply(<span class="built_in">console</span>, array);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>完整的服务端app:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'node-static'</span>);</div><div class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">const</span> file = <span class="keyword">new</span>(<span class="keyword">static</span>.Server)();</div><div class="line"><span class="keyword">const</span> app = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  file.serve(req, res);</div><div class="line">&#125;).listen(<span class="number">2013</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>).listen(app);</div><div class="line"></div><div class="line">io.sockets.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</div><div class="line"></div><div class="line">  <span class="comment">// convenience function to log server messages to the client</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">const</span> array = [<span class="string">'&gt;&gt;&gt; Message from server: '</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</div><div class="line">      array.push(<span class="built_in">arguments</span>[i]);</div><div class="line">    &#125;</div><div class="line">      socket.emit(<span class="string">'log'</span>, array);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  socket.on(<span class="string">'message'</span>, (message) =&gt; &#123;</div><div class="line">    log(<span class="string">'Got message:'</span>, message);</div><div class="line">    <span class="comment">// for a real app, would be room only (not broadcast)</span></div><div class="line">    socket.broadcast.emit(<span class="string">'message'</span>, message);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  socket.on(<span class="string">'create or join'</span>, (room) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> numClients = io.sockets.clients(room).length;</div><div class="line"></div><div class="line">    log(<span class="string">'Room '</span> + room + <span class="string">' has '</span> + numClients + <span class="string">' client(s)'</span>);</div><div class="line">    log(<span class="string">'Request to create or join room '</span> + room);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (numClients === <span class="number">0</span>)&#123;</div><div class="line">      socket.join(room);</div><div class="line">      socket.emit(<span class="string">'created'</span>, room);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (numClients === <span class="number">1</span>) &#123;</div><div class="line">      io.sockets.in(room).emit(<span class="string">'join'</span>, room);</div><div class="line">      socket.join(room);</div><div class="line">      socket.emit(<span class="string">'joined'</span>, room);</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// max two clients</span></div><div class="line">      socket.emit(<span class="string">'full'</span>, room);</div><div class="line">    &#125;</div><div class="line">    socket.emit(<span class="string">'emit(): client '</span> + socket.id +</div><div class="line">      <span class="string">' joined room '</span> + room);</div><div class="line">    socket.broadcast.emit(<span class="string">'broadcast(): client '</span> + socket.id +</div><div class="line">      <span class="string">' joined room '</span> + room);</div><div class="line"></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>（你不需要去学习node-static；它只是碰巧在这个例子里用到）</p>
<p>在localhost上运行这个程序，你需要安装Node，socket.io和node-static。Node可以从nodejs.org下载。要安装socket.io和node-static，请从你的应用程序目录中的终端运行Node Package Manager：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install socket.io</div><div class="line">npm install node-static</div></pre></td></tr></table></figure>
<p>启动服务器，在应用目录下运行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node server.js</div></pre></td></tr></table></figure>
<p>在浏览器中打开localhost:2013。在任何浏览器中打开新的标签页或窗口，然后再次打开localhost:2013。如果想要查看发生了什么，请查看控制台：在Chrome和Opera中，可以通过Command-Option-J或Ctrl-Shift-J通过DevTools访问。</p>
<p>不管你选择使用什么方式进行信号传输，后端和客户端app都至少需要提供类似于此示例的服务。</p>
<h3 id="信令陷阱"><a href="#信令陷阱" class="headerlink" title="信令陷阱"></a>信令陷阱</h3><ul>
<li><p>在setLocalDescription()被调用之前，RTCPeerConnection并不会开始收集候选：这是在<a href="http://tools.ietf.org/html/draft-ietf-rtcweb-jsep-03#section-4.2.4" target="_blank" rel="external">JSEP IETF草案</a>中规定的。</p>
</li>
<li><p>利用Trickle ICE（见上文）：候选到达后立即调用addIceCandidate()。</p>
</li>
</ul>
<h3 id="现成的信令服务器"><a href="#现成的信令服务器" class="headerlink" title="现成的信令服务器"></a>现成的信令服务器</h3><p>如果你不想自己做WebRTC 信令服务器，有一些现成的服务器可用，它们可以使用上面例子中使用Socket.io，并与WebRTC客户端 JavaScript库集成：</p>
<ul>
<li>webRTC.io：WebRTC最先出现的几个抽象库之一。</li>
<li>easyRTC：完整的WebRTC包。</li>
<li>Signalmaster：一个与SimpleWebRTC JavaScript客户端库一起使用的信号服务器。</li>
</ul>
<p>如果你一点代码都不想写的话，还可以从像vLine，OpenTok和Asterisk等公司获得完整的商业WebRTC平台。</p>
<p>爱立信在WebRTC早期的时候建立了一个在Apache上使用PHP的信令服务器。虽说这现在已经过时了，但是如果你正在考虑类似的东西，那么还是值得看一下代码的。</p>
<h3 id="信令安全"><a href="#信令安全" class="headerlink" title="信令安全"></a>信令安全</h3><blockquote>
<p>安全是无所作为的艺术。</p>
<p>— Salman Rushdie</p>
</blockquote>
<p>加密对于所有WebRTC组件来说都是强制性的。</p>
<p>但是信令机制并不是由WebRTC标准定义的，所以保护信令安全的责任就全在你的身上了。如果攻击者设法劫持了信令，他们就可以停止会话，重新定向连接和记录，更改或注入其他内容。</p>
<p>确保信令安全的最重要因素是使用安全协议，即HTTPS和WSS（即TLS），确保消息不会因未加密而截获。另外要小心，不要以可以被其他呼叫方能够获取的方式用同一个信令服务器广播信令消息。</p>
<h3 id="在信令之后：使用-ICE来对付NAT和防火墙"><a href="#在信令之后：使用-ICE来对付NAT和防火墙" class="headerlink" title="在信令之后：使用 ICE来对付NAT和防火墙"></a>在信令之后：使用 ICE来对付NAT和防火墙</h3><p>对于元数据信令，WebRTC应用程序使用中介服务器，但对于实际的媒体和数据流，一旦建立对话的话，RTCPeerConnection就会尝试点对点地直接连接客户端。</p>
<p>在简单的情况中，每个WebRTC端点都有一个唯一的地址，可以与其他端进行交换以便直接通信。</p>
<p><img src="/img/without_nat.png" alt="world without nat"></p>
<p>实际上大多数设备都是处在一层或者多层NAT之后的，其中有一些包含可以阻挡某些端口和协议的防病毒软件，还有很多设备是在代理和公司防火墙之后的。防火墙和NAT实际上可以由相同的设备实现，比如说家庭WiFi路由器。</p>
<p><img src="/img/nat_real_world.png" alt="nat_real_world"></p>
<p>WebRTC应用程序可以使用ICE框架来消除实际网络的复杂性。为了实现这一点，你的应用程序必须将 ICE服务器的URL传递给RTCPeerConnection，就像下面所描述的那样。</p>
<p>ICE试图找到连接对方的最佳途径。它会并行地尝试所有可能性，并选择最有效的选项。 ICE首先尝试使用从设备操作系统和网卡获取的主机地址进行连接；如果不成功的话（对于NAT后面的设备就会失败）， ICE会使用 STUN服务器获取外部地址，如果还是失败的话，则通过 TURN中继服务器路由数据。</p>
<p>换句话说：</p>
<ul>
<li><p>STUN服务器是用来获取外部地址的。</p>
</li>
<li><p>TURN服务器是用来在直接连接（点到点）失败的情况下进行中继数据流量的</p>
</li>
</ul>
<p>每个 TURN服务器都支持 STUN： TURN服务器也是一个增加了内置中继功能的 STUN服务器。 ICE还可以应付NAT设置的复杂性：实际上，NAT“打孔”可能不仅仅需要一个公共IP:端口地址。</p>
<p>STUN 和/或 TURN服务器的URL（可选择地）由iceServers配置对象中的WebRTC应用程序指定，该配置对象是RTCPeerConnection构造函数的第一个参数。对于<a href="http://appr.tc/" target="_blank" rel="external">appr.tc</a>来说，值看起来是这样的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  'iceServers': [</div><div class="line">    &#123;</div><div class="line">      'urls': 'stun:stun.l.google.com:19302'</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      'urls': 'turn:192.158.29.39:3478?transport=udp',</div><div class="line">      'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',</div><div class="line">      'username': '28224511:1379330808'</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      'urls': 'turn:192.158.29.39:3478?transport=tcp',</div><div class="line">      'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',</div><div class="line">      'username': '28224511:1379330808'</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意：上面显示的 TURN 证书是有时间限制的，在2013年9月到期。 TURN服务器运行起来很昂贵，你需要为自己的服务器付费或者找一个服务提供商。要测试证书，你可以使用候选收集样本，并检查是否获得了类型为中继的候选。</p>
<p>一旦RTCPeerConnection具有该信息， ICE的作用就会自动发生：RTCPeerConnection使用 ICE框架 来计算到对端之间的最佳路径，并根据需要使用 STUN和 TURN服务器。</p>
<h3 id="STUN"><a href="#STUN" class="headerlink" title="STUN"></a>STUN</h3><p>NAT给设备提供了一个IP地址以使用专用局域网，但是这个地址不能在外部使用。由于没有公用地址，WebRTC端对端就无法进行通信。而WebRTC使用STUN来解决这个问题。</p>
<p>STUN服务器位于公共网络上，并且有一个简单的任务：检查传入请求的IP地址（来自运行在NAT后面的应用程序），并将该地址作为响应发送回去。换句话说，应用程序使用 STUN服务器从公共角度发现其IP:端口。这个过程使得WebRTC一端为自己获得一个可公开访问的地址，然后通过信令机制将其传递给另一端以建立直接连接。（实际上不同NAT工作方式都有所不同，可能有多个NAT层，但是原理是一样的）。</p>
<p>因为 STUN服务器不需要做太多的工作或者记特别多的东西，所以相对低规格的 STUN服务器就可以处理大量的请求。</p>
<p>根据<a href="http://webrtcstats.com/" target="_blank" rel="external">webrtcstats.com</a>的统计（2013年），大多数WebRTC通话都成功地使用 STUN进行连接，有86%。尽管对于防火墙之后的两端之间的呼叫以及复杂的NAT配置，成功通话量会更少一些。</p>
<p><img src="/img/stun.png" alt="stun"></p>
<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>RTCPeerConnection尝试通过UDP建立对等端之间的直接通信。如果失败的话，RTCPeerConnection就会使用TCP进行连接。如果使用TCP还失败的话，可以用 TURN服务器作为后备，在终端之间转发数据。</p>
<p>重申： TURN用于中继对等端之间的音频/视频/数据流，而不是信令数据。</p>
<p>TURN服务器具有公共地址，因此即使对等端位于防火墙或代理之后也可以与其他人联系。 TURN服务器有一个概念上来讲简单的任务—中继数据流—但是与 STUN服务器不同的是，他们会消耗大量的带宽。换句话说， TURN服务器需要更加的强大。</p>
<p><img src="/img/turn.png" alt="turn"></p>
<p>上图显示了 TURN的作用：单纯的 STUN没有成功建立连接，所以每个对等端还需要使用 TURN服务器。</p>
<h3 id="部署-STUN和-TURN服务器"><a href="#部署-STUN和-TURN服务器" class="headerlink" title="部署 STUN和 TURN服务器"></a>部署 STUN和 TURN服务器</h3><p>为了进行测试，Google运行了一个公共 STUN服务器 stun.l.google.com:19302，就是<a href="http://appr.tc/" target="_blank" rel="external">appr.tc</a>所使用的那样。对于产品的 STUN/ TURN服务，我们推荐使用rfc5766-turn-server； STUN和 TURN服务器的源代码可从<a href="https://code.google.com/p/rfc5766-turn-server/" target="_blank" rel="external">code.google.com/p/rfc5766-turn-server</a>获得，该代码还提供了有关服务器安装的多个信息源的链接。<a href="https://groups.google.com/forum/#!msg/discuss-webrtc/X-OeIUC0efs/XW5Wf7Tt1vMJ" target="_blank" rel="external">Amazon Web Services的VM映像</a>也可用。</p>
<p>另一个 TURN服务器是restund，提供<a href="http://www.creytiv.com/restund.html" target="_blank" rel="external">源代码</a>，也有AWS服务。以下是如何在Google Compute Engine上设置restund的说明。</p>
<ol>
<li>根据需要打开防火墙，对于tcp = 443，udp/tcp = 3478</li>
<li>创建四个实例，每个公共IP标准一个，Standard Ubuntu 12.06映像</li>
<li>设置本地防火墙配置</li>
<li><p>安装工具</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install make</div><div class="line">sudo apt-get install gcc</div></pre></td></tr></table></figure>
</li>
<li><p>从creytiv.com/re.html安装libre</p>
</li>
<li>从creytiv.com/restund.html获取并解压缩restund</li>
<li>wget hancke.name/restund-auth.patch并且使用patch – p1</li>
<li>对libre和restund运行make, sudo make install</li>
<li>根据你的需要（替换IP地址并确保它包含相同的共享密钥）对restund.conf进行调整，并复制到/etc</li>
<li>复制restund/etc/restund到/etc/init.d/</li>
<li>配置restund：<ul>
<li>设置LD_LIBRARY_PATH</li>
<li>复制restund.conf到/etc/restund.conf</li>
<li>设置restund.conf以使用正确的 10. IP地址</li>
</ul>
</li>
<li>运行restund</li>
<li>从远端机上使用社团的客户端进行测试：./client IP:port</li>
</ol>
<h3 id="多方WebRTC"><a href="#多方WebRTC" class="headerlink" title="多方WebRTC"></a>多方WebRTC</h3><p>你可能还想查看一下Justin Uberti提出的用于访问TURN服务的<a href="http://tools.ietf.org/html/draft-uberti-rtcweb-turn-rest-00" target="_blank" rel="external">REST API的IETF标准</a>。</p>
<p>很容易想象媒体流的使用情况超出了简单的一对一呼叫：例如，一组同事之间的视频会议，或一个发言者和数百（数百万）个观众的公共事件。</p>
<p>WebRTC应用程序可以使用多个RTCPeerConnection，以便每个端点都可以连接到网格配置中的每个其他端点。这是<a href="http://talky.io/" target="_blank" rel="external">talky.io</a>等应用程序所采取的方法，对于只有少数几个对等端的情况来说可以很好的工作。除此之外，处理和带宽会过度消耗，对于移动客户端来说尤其是这样。</p>
<p><img src="/img/mesh_topo.png" alt="mesh_topo"></p>
<p>或者，WebRTC应用程序可以选择一个端点以星形配置将流分配给所有其他端点。也可以在服务器上运行WebRTC端点并构建自己的重新分配机制。（<a href="https://code.google.com/p/webrtc/source/browse/#svn%2Ftrunk%2Ftalk" target="_blank" rel="external">webrtc.org</a>提供了一个客户端应用示例）</p>
<p>从Chrome 31和Opera 18开始，来自一个RTCPeerConnection的MediaStream可以用作另一个的输入：在<a href="http://simpl.info/rtcpeerconnection/multi" target="_blank" rel="external">simpl.info/multi</a>上有一个演示。这可以启用更灵活的体系结构，因为它使Web应用程序能够通过选择要连接的其他对等端来处理呼叫路由。</p>
<h3 id="多点控制单元"><a href="#多点控制单元" class="headerlink" title="多点控制单元"></a>多点控制单元</h3><p>大量endpoint情况的更好选择是使用多点控制单元（Multipoint Control Unit，MCU）。它是一个服务器，可以作为在大量参与者之间分发媒体的桥。MCU可以处理视频会议中的不同分辨率，编解码器和帧速率，处理转码，选择性流转发，混音或录制音频和视频。对于多方通话，需要考虑许多问题：特别是如何显示多个视频输入并混合来自多个来源的音频。</p>
<p>你可以购买一个完整的MCU硬件包，或者建立自己的MCU。</p>
<p><img src="/img/mcu.jpg" alt="mcu"></p>
<p>有几个开源的MCU软件可供选择。比如说，<a href="http://lynckia.com/" target="_blank" rel="external">Licode</a>为WebRTC做了一个开源MCU；OpenTok也有Mantis。<br>Several open source MCU software options are available. For example, Licode (previously know as Lynckia) produces an open source MCU for WebRTC; OpenTok has <a href="http://www.tokbox.com/blog/mantis-next-generation-cloud-technology-for-webrtc/" target="_blank" rel="external">Mantis</a>.</p>
<h3 id="除了浏览器以外还有：VoIP，电话和消息"><a href="#除了浏览器以外还有：VoIP，电话和消息" class="headerlink" title="除了浏览器以外还有：VoIP，电话和消息"></a>除了浏览器以外还有：VoIP，电话和消息</h3><p>WebRTC的标准化特性使得在浏览器中运行的WebRTC应用程序与另一个通信平台运行的设备或停牌（例如电话或视频会议系统）之间建立通信成为可能。</p>
<p>SIP是VoIP和视频会议系统使用的信令协议。为了实现WebRTC应用程序与视频会议系统等SIP客户端之间的通信，WebRTC需要代理服务器来调解信令。信令必须通过网关流动，但一旦通信建立，SRTP流量（视频和音频）就可以直接流向对等端。</p>
<p>公共交换电话网（PSTN）是所有“普通老式”模拟电话的电路交换网络。对于WebRTC应用程序和电话之间的通话，通信必须通过PSTN网关。同样，WebRTC应用程序需要中间的XMPP服务器来与Jingle端点（如IM客户端）进行通信。Jingle由Google开发，作为XMPP的扩展，为语音和视频提供消息传递服务：当前的WebRTC实现是基于C++ libjingle库的，这是一个最初为Google Talk开发的Jingle实现。</p>
<p>许多应用程序，库，和平台利用WebRTC与外部世界的沟通能力：sipML5，jsSIP，Phono，Zingaya，Twilio和Uberconference等等。</p>
<p>sipML5开发者也构建了webrtc2sip网关。Tethr和Tropo展示了一个在灾难通信框架，使用OpenBTS单元通过WebRTC实现手机和计算机之间的通信。这是一个没有运营商在中间的电话通信！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/19/使用一个新的hash一致性算法提升负载均衡/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/19/使用一个新的hash一致性算法提升负载均衡/" itemprop="url">[翻译]使用一个新的hash一致性算法提升负载均衡</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-19T21:29:01+08:00">
                2018-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://medium.com/vimeo-engineering-blog/improving-load-balancing-with-a-new-consistent-hashing-algorithm-9f1bd75709ed" target="_blank" rel="external">原文: Improving load balancing with a new consistent-hashing algorithm</a></p>
<p>我们在云上运行Vimeo的动态视频打包器<code>Skyfire</code>，每天服务近<strong>10亿</strong>个DASH和HLS请求。 这个请求量是非常大的！ 我们对它的表现非常满意，但将其扩展到适应今天的流量以及更高的流量是一个有趣的挑战。 今天我想谈谈一个新的算法，有限负载一致性哈希（bounded-load consistent hashing），以及它是如何消除我们视频传输的瓶颈的。</p>
<h3 id="动态打包"><a href="#动态打包" class="headerlink" title="动态打包"></a>动态打包</h3><p>Vimeo的视频文件存储为MP4文件，与浏览器中用于下载或“渐进式”播放的格式相同。但是，DASH和HLS不使用单个文件 - 它们使用单​​独的视频短片段。当播放器请求某个片段时，Skyfire会动态处理该请求。它仅获取MP4文件的必要部分，针对DASH或HLS格式进行一些调整，并将结果发送回用户。 </p>
<p>但是，当播放器请求（例如，文件的第37段）时，Skyfire如何知道需要获取哪些字节？它需要查看一个索引，该索引知道所有关键帧的位置以及文件中的所有数据包。在索引可以被查询之前，你需要生成它。这需要至少一个HTTP请求和一点CPU时间 - 或者，对于很长的视频，需要大量的CPU时间。由于我们对同一视频文件的请求很多，因此缓存索引并在以后重复使用是有意义的。 </p>
<p>当我们第一次在现实世界中开始测试Skyfire时，我们采用了一种简单的缓存方法：我们将索引缓存在生成它们的云服务器的内存中，并在HAProxy中使用一致性哈希将相同视频文件的请求发送到相同的云服务器。这样，我们可以重用缓存的数据。</p>
<h3 id="理解一致性哈希"><a href="#理解一致性哈希" class="headerlink" title="理解一致性哈希"></a>理解一致性哈希</h3><p>在继续前进之前，让我们深入研究一下一致性哈希，这是一种在多个服务器之间分配负载的技术。如果你已经熟悉一致性哈希，请随时跳转到下一部分。</p>
<p>要使用一致性哈希在服务器之间分发请求，HAProxy会获取<em>部分请求</em>的哈希值（我们使用的是包含视频ID的URL的一部分），并使用该哈希值来选择可用的后端服务器。使用传统的“模状哈希”，您只需将请求哈希值视为一个非常大的数字。如果以可用服务器数量为模数，则获取的是要使用的服务器的索引。这很简单，只要服务器列表稳定，它就能很好地工作。但是，当添加或删除服务器时，会出现问题：大多数请求将散列到与之前不同的服务器。如果你有九台服务器并且添加了十分之一，那么只有十分之一的请求会（通过运气）散列到与之前相同的服务器。</p>
<p>所以有了一致性哈希。一致性哈希使用更复杂的方案，其中每个服务器根据其名称或ID分配多个哈希值，并且每个请求都根据“最近”哈希值分配给服务器。这种增加的复杂性的好处是，当添加或删除服务器时，大多数请求将映射到他们之前执行的相同服务器。因此，如果您有九台服务器并添加十分之一，则大约1/10的请求将落在新添加的服务器哈希值附近，而另外9/10将落到与之前相同的最近服务器。好多了！因此，一致性哈希使我们可以添加和删除服务器，而不会完全干扰每个服务器所拥有的缓存。当这些服务器在云中运行时，这是一个非常重要的属性。</p>
<h3 id="一致性哈希-不理想的负载均衡"><a href="#一致性哈希-不理想的负载均衡" class="headerlink" title="一致性哈希 - 不理想的负载均衡"></a>一致性哈希 - 不理想的负载均衡</h3><p>但是，一致性哈希有其自身的问题：请求分布不均匀。由于其数学属性，当请求的分布均匀时，一致性哈希仅平衡负载以及为每个请求随机选择服务器。但是，如果某些内容比其他内容（互联网中很常见）更受欢迎，那可能会很糟糕。一致性哈希会将该流行内容的所有请求发送到相同的服务器，比其他服务器接收更多流量。这可能导致服务器过载，视频播放效果不佳以及用户不满意。</p>
<p>到2015年11月，由于Vimeo已经准备好向一群精心挑选的成员推出Skyfire，我们认为这个超载问题太严重，不容忽视，所以我们改变了缓存使用方法。我们在HAProxy中使用了“least connections”的负载均衡策略，而不是基于一致性哈希的均衡，因此负载将在服务器之间均匀分配。我们使用memcache添加了一个二级缓存，在服务器之间共享，这样一个服务器生成的索引可以被另一个服务器检索。共享缓存需要一些额外的带宽，但负载在服务器之间更均衡地平衡。这就是我们第二年愉快运行的方式。</p>
<h3 id="两者都有不是更好吗？"><a href="#两者都有不是更好吗？" class="headerlink" title="两者都有不是更好吗？"></a>两者都有不是更好吗？</h3><p>为什么没有办法说“使用一致性哈希，但请不要超载任何服务器”？早在2015年8月，我就试图提出一种算法，该算法基于两个随机选择的功能，这样做可以做到这一点，但是一些模拟表明它不起作用。向非理想服务器发送了太多请求。我很失望，但是我们没有浪费时间去拯救它，而是采用了上面最少的连接和共享缓存方法。</p>
<p>快进到2016年8月。我注意到不可估量的Damian Gryski推文中的一个URL，这是一篇名为Consistent Hashing with Bounded Loads的arXiv论文。我阅读了摘要，它似乎正是我想要的：一种算法，它将一致性哈希与任何一台服务器负载的上限相结合，相对于整个池的平均负载。我读了这篇论文，算法非常简单。实际上，该论文表示：</p>
<blockquote>
<p>虽然一致性哈希搭配转发来满足容量限制的想法似乎非常明显，但似乎以前没有被考虑过。</p>
</blockquote>
<h3 id="有界负载算法（The-bounded-load-algorithm）"><a href="#有界负载算法（The-bounded-load-algorithm）" class="headerlink" title="有界负载算法（The bounded-load algorithm）"></a>有界负载算法（The bounded-load algorithm）</h3><p>这是算法的简化草图。遗漏了一些细节，如果你打算自己实现它，你一定要去原始论文获取信息。</p>
<p>首先，定义一个大于1的平衡因子c。c控制服务器之间允许的不平衡程度。例如，如果c = 1.25，则服务器不应超过平均负载的125％。在c增加到∞的极限中，算法变得等效于普通一致性哈希，没有平衡；当c减小到接近1时，它变得更像是最少连接策略，并且哈希变得不那么重要。根据我的经验，1.25和2之间的值更适用于实际场景。</p>
<p>当请求到达时，计算平均负载（未完成请求的数量，m，包括刚刚到达的请求数除以可用服务器数n）。将平均负载乘以c得到“目标负载”，t。在原始论文中，将容量分配给服务器，以便每个服务器的容量为⌊t⌋或⌈t⌉，总容量为⌈cm⌉。因此，服务器的最大容量为⌈cm/n⌉，大于平均负载的c倍，小于1个请求。为了支持给服务器不同的“权重”，正如HAProxy所做的那样，算法必须略有改变，但精神是相同的 - 没有服务器可以超过负载份额1个请求。</p>
<p>分发一个请求时，像往常一样计算其哈希值和最近的服务器。如果该服务器负载低于其容量，则将请求分配给该服务器。否则，转到哈希环中的下一个服务器并检查其负载，继续，直到找到有剩余容量的服务器。肯定有一个服务器符合条件，因为最高容量高于平均负载，并且每个服务器的负载不可能高于平均值。这保证了一些不错的东西：</p>
<ol>
<li>不允许服务器负载超过（平均负载 * c 加 1） 个请求。</li>
<li>只要服务器未过载，请求的分配策略与一致性哈希相同。</li>
<li>如果服务器过载，则所选择的回退服务器列表对于相同的请求哈希将是相同的 - 即，相同的服务器将始终是流行的内容的“第二选择”。这对缓存很有用。</li>
<li>如果服务器过载，则回退服务器列表对于不同的请求哈希值通常会有所不同 - 即，过载服务器的溢出负载将在可用服务器之间分配，而不是全部落到某个服务器上。这取决于每个服务器在一致性哈希环中分配多少个点。</li>
</ol>
<h3 id="实际应用的结果"><a href="#实际应用的结果" class="headerlink" title="实际应用的结果"></a>实际应用的结果</h3><p>在模拟器中测试算法并获得比我的简单算法更积极的结果后，我开始搞清楚如何将其hack到HAProxy。向HAProxy添加代码并不算太糟糕。HAProxy代码非常干净，组织良好，经过几天的工作，我得到了一些运行良好的程序，我可以通过它重放一些流量，观察算法的作用。它奏效了！数学证明和模拟是很好的，但是直到你看到真正的流量击中正确的服务器才能真正相信。</p>
<p>有了这个成功，我在9月份向HAProxy发送了一个概念验证补丁。 HAProxy维护者Willy Tarreau（非常高兴能与之合作），认识到算法的价值。他并没有告诉我我的补丁有多糟糕。他做了彻底的代码审查，并提供了一些非常有价值的反馈。我花了一点时间来处理这些建议并把事情搞定了，几周之后我就有了一个精美的版本准备发送到列表中。还有一些小的调整，它在10月26日发布的HAProxy 1.7.0-dev5及时被接受。11月25日，HAProxy 1.7.0被指定为稳定版本，因此现在普遍可以使用有限负载一致性哈希。</p>
<p>但我确定你想知道的是，我们从这一切中获得了什么？</p>
<p>这是更改HAProxy配置之前和之后的缓存行为图。</p>
<p><img src="/img/cache_hit.png" alt="haproxy conf"></p>
<p>每日变化是由弹性伸缩引起的：在白天，流量会增加，因此我们启动更多服务器来处理它，本地缓存只能解决更少的请求。在晚上，流量较少，因此关闭服务器，本地缓存性能有所提升。切换到有界负载算法后，无论运行多少台服务器，都会有更大比例的请求到达本地缓存。</p>
<p>下面是共享缓存带宽在同一时间的图表：在更改之前，每个memcache服务器在高峰时段的出站带宽达到400到500 Mbit / s（总共大约8Gbit / s）。改进算法之后，变化较小，服务器带宽保持在100 Mbit / s以下。</p>
<p><img src="/img/bandwidth.png" alt="bandwidth"></p>
<p>从响应时间的角度来看，我们没有画出性能提升的图。为什么？因为他们保持几乎完全相同。最少连接策略在保持服务器不会过载方面做得很好，从memcache中获取内容的速度足够快，以至于它对响应时间没有可测量的影响。但是现在更少部分的请求会依赖于共享缓存，并且由于该部分不依赖于我们运行的服务器数量，因此我们可以期待在不使memcached服务器饱和的情况下处理更多流量。此外，如果memcache服务器出现故障，它对Skyfire的整体影响将会大大降低。</p>
<p>总而言之，很高兴看到一点算法工作将单点问题变得更好。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/15/翻译-不使用第三方库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/15/翻译-不使用第三方库/" itemprop="url">[翻译]不使用第三方库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-15T22:04:24+08:00">
                2018-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://blog.gopheracademy.com/advent-2014/case-against-3pl/" target="_blank" rel="external">原文</a></p>
<p>译者：不少golang开源项目的Contrib Guidelines里会表示在提交PR时尽量不要引入第三方的包，这篇文章正是阐述了这样一个观点。原文标题下还有一行是：”我如何不再担心包管理并开始喜欢上无版本的包管理”，可以作为本文的另一个标题。也许很多人并不认同本文的观点，甚至认为是胡说八道，但是确实有很多项目在使用这样一个规则：<code>influxdb</code>的<a href="https://github.com/influxdata/influxdb/blob/master/CODING_GUIDELINES.md#try-not-to-use-third-party-libraries" target="_blank" rel="external">coding guidlines</a>明确表示<em>Try not to use third-party libraries</em>，web框架<a href="https://github.com/gin-gonic/gin" target="_blank" rel="external">gin</a>的router实现copy了<a href="https://github.com/julienschmidt/httprouter" target="_blank" rel="external">github.com/julienschmidt/httprouter</a>的代码实现并做了少量更改，几乎所有的大型golang程序都会自己实现一些通用的函数，例如slice的union、unique等操作，自己扩展log的程序也有很多，比如nsq。</p>
<hr>
<p>如果你看过<a href="https://groups.google.com/forum/#!forum/golang-nuts" target="_blank" rel="external">golang-nuts</a>邮件列表，会发现包管理比任何其他话题都容易引起争论。在我刚开始写Go的时候同样认为缺少一个<code>真正的</code>包管理是一个明显的失误，但是，当我写的Go代码越多我越是开始欣赏<code>go get</code>的简单易用。</p>
<p>版本化软件包的好处很明显。它使团队中的每个人都有一份一致的代码，并且大多数时候包的版本号采用固定的模式(<a href="https://semver.org/" target="_blank" rel="external">语义化版本</a>)，可以传达API的变更信息。但是包版本控制并非没有缺点。</p>
<p>在这篇文章中，我们将来探讨应用程序开发人员可用的选项，库开发人员的职责以及无版本包管理的副作用。</p>
<h3 id="只使用标准库"><a href="#只使用标准库" class="headerlink" title="只使用标准库"></a>只使用标准库</h3><p>许多第三方Go库试图提供较现有的标准库Package更丰富的实现。然而，很多时候，他们的功能集变得太大而无法正确测试，并且需要新的开发人员了解额外的框架，从而增加了项目的认知开销。</p>
<p>在GitHub上有<a href="https://github.com/search?l=Go&amp;p=3&amp;q=web+framework&amp;type=Repositories" target="_blank" rel="external">200多个Go Web框架</a>，我一个都没用过。基于HTTP的项目有这样一系列的要求和权衡，我很欣赏<code>net/http</code>提供的功能和实用性的平衡。如果我的应用程序需要中间件，那么写一个适合我的项目的<code>http.Handler</code>是很简单的。没有万能的Web框架。</p>
<p>日志记录(Logging)是另一个<code>少即是多(less is more)</code>的领域。 GitHub上有<a href="https://github.com/search?l=Go&amp;p=3&amp;q=logging&amp;type=Repositories" target="_blank" rel="external">超过500多个Go日志库</a>，但我更喜欢标准日志包(<strong>log</strong>)的简单。它提供了一个小型的、固定范围的库，将时间戳信息打印到标准错误。这就是我需要的。添加其他功能，如日志等级，让开发人员选择何时使用DEBUG而不是INFO级别，会增加剩余代码的复杂性。如果足够重要，那就应该记录日志。</p>
<h3 id="Ctrl-C-Ctrl-V"><a href="#Ctrl-C-Ctrl-V" class="headerlink" title="Ctrl-C, Ctrl-V"></a>Ctrl-C, Ctrl-V</h3><p><a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="external">DRY</a>的坚定支持者可能会对此建议感到畏缩，但多次将小部分代码复制到项目中可能是导入整个库的更好选择。 如果需要，将小功能复制过来使你可以根据自己的特定需求对其进行调整，并随时扩展它们。 它们还限制了项目中其他开发人员所需的知识，因为他们不需要读取另一个库的完整文档来了解依赖关系。</p>
<p>几个月前，我发布了一个没有<code>.go</code>文件的Go<a href="https://github.com/benbjohnson/testing" target="_blank" rel="external">测试库</a>，因为它足够小，我希望用户只需复制他们需要的功能。 另一个很好的例子是使用一些简单的算法，如<a href="https://github.com/benbjohnson/jmphash" target="_blank" rel="external">一致的哈希</a>。 很多时候他们少于50行代码。 在复制任何代码之前，请查看包的证书。</p>
<h3 id="固定范围的库"><a href="#固定范围的库" class="headerlink" title="固定范围的库"></a>固定范围的库</h3><p>尽管我试图坚持使用标准库，但有时候我还是需要使用第三方库。因为<code>go get</code>不提供版本控制，所以与使用像<a href="http://rubygems.org/" target="_blank" rel="external">rubygems</a>等工具时相比，我对第三方库的看法非常不同。</p>
<p>在Ruby中，在引用程序中肆意添加第三方库很常见。一个三年的Rails项目很容易在其<code>Gemfile</code>中拥有50个依赖项。随着时间的推移，我需要升级库，毫无疑问，它们的功能或API会改变，并与我使用的其他库冲突。所以我将不得不升级那些可能导致更多冲突的其他库。</p>
<p>那时我意识到一个有30个版本的库实际上是30个独立的库。</p>
<p>在Go中，我尝试编写和使用具有固定范围的库，因此他们只需要一个版本。例如，<a href="https://github.com/benbjohnson/css" target="_blank" rel="external">css</a>库实现了<a href="http://www.w3.org/TR/css3-syntax/" target="_blank" rel="external">W3C的CSS语法模块级别3</a>规范，因此其范围是固定的。一旦实施和测试，变更和bug修复都会很小。</p>
<p>另一个例子是<a href="https://github.com/boltdb/bolt" target="_blank" rel="external">Bolt</a>库。它的目标是提供一个简单，快速的事务密钥/值存储。通过限制它的问题空间，Bolt能够保持最小的API并经过良好测试。经过近六个月的各种生产系统运行没有问题，Bolt升级到了1.0版并停止了开发。该项目不会被放弃 - 它只是已经完成了。添加功能会影响项目的稳定性。 Bolt的下一个版本不会是2.0，它会被简单地称为别的东西。</p>
<h3 id="高质量建立信任-amp-信任建立社区"><a href="#高质量建立信任-amp-信任建立社区" class="headerlink" title="高质量建立信任&amp;信任建立社区"></a>高质量建立信任&amp;信任建立社区</h3><p>无版本软件包管理的一个意想不到的副作用是，我现在需要知道并信任编写我使用的库的开发人员。 正因为如此，我在Go社区的参与度比我在任何其他语言社区的参与度都要高。</p>
<p>我定期阅读我使用的项目源代码，看看Package维护人员的风格和项目质量是否与我期望的一致。它让我对社区中的开发者更加赞赏。了解某人的代码是非常个人化的事，我相信这是Go社区蓬勃发展的一个小原因。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>Go语言提供了惊人的高质量和深思熟虑的通用库的实现。很多时候，这是项目所需的一切。 很多时候你也会需要超出标准库范围的功能。在这些情况下，我希望你能花时间了解一下你使用的库的代码和开发人员。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/27/nsqd源码分析和代码流程图/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/27/nsqd源码分析和代码流程图/" itemprop="url">nsqd源码分析和代码流程图</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-27T21:38:06+08:00">
                2018-04-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>nsqd的代码量在1w行左右，包含了项目下的nsqd，internal目录，以及<a href="https://github.com/nsqio/go-diskqueue" target="_blank" rel="external">go-diskqueue</a>项目，代码量虽然不大，但是开启了各种goroutine，有各种channel用于通信，应该算得上有点复杂了。</p>
<p>看源码的时候建议分模块来看，topic的功能，channel的功能，延迟消息，超时重传，写入磁盘，与nsqlookdup的通信等。可以从入口函数先了解个大概，不建议一开始就一行行细看，goroutine和channel很多，非常容易绕进去。</p>
<p>我画了一张代码的流程图（图在最下面），供大家参考，图中的节点是我觉得比较重要的地方。这张图本身就有点乱（一方面我水平有限，另一方面代码确实略复杂），看上去各种线飞来飞去，但是我私认为还是反映了nsqd的代码流程的，图中的线确实代表了节点之间的一些关系，如果去掉，反而可能会有误导。</p>
<p>流程图只是一个辅助工具，觉得不好的同学大可以不看，这并不会妨碍你对代码的理解。详细的对于代码的注释参考<a href="https://github.com/michaelyou/nsq/tree/feature-comment/nsqd" target="_blank" rel="external">这里</a>，网上有不少对于源码的分析，但大多只是某一个模块的，这应该算是一个比较全面的注释了。</p>
<p>有问题欢迎提出:-D</p>
<p><img src="/img/nsq.png" alt="nsqd流程图"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/30/database-sql-一点深入理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/30/database-sql-一点深入理解/" itemprop="url">database/sql 一点深入理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-30T22:04:27+08:00">
                2018-03-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们主要来分析一下查询的实现，涉及的是<code>database/sql</code>和<code>go-sql-driver/mysql</code>的部分源码。<code>database/sql</code>是go对于db抽象出的一个标准库，<code>go-sql-driver/mysql</code>是实现了<code>database/sql</code>驱动接口的mysql驱动。</p>
<blockquote>
<p>什么是数据库驱动？</p>
<p>简单来讲，数据库驱动实现了mysql协议，比如连接数据库，驱动会给数据库服务器发送<code>握手初始化报文</code>和<code>登陆认证报文</code>，拼出报文头，将username，password放在报文的固定位置，将[]byte数据写入到socket，这就是驱动的主要功能，他给我们（这里指database/sql）完成了底层的操作</p>
</blockquote>
<p>查询的接口主要有两个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">执行一个查询并返回多个数据行， 这个查询通常是一个 SELECT 。 方法的 arg 部分用于填写查询语句中包含的占位符的实际参数。</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">Query</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*Rows, error)</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">/*</span></div><div class="line"><span class="function">执行一个预期最多只会返回一个数据行的查询。</span></div><div class="line"><span class="function">这个方法总是会返回一个非空的值， 而它引起的错误则会被推延到数据行的 <span class="title">Scan</span> 方法被调用为止。</span></div><div class="line"><span class="function">*/</span></div><div class="line"><span class="function"><span class="title">func</span> <span class="params">(db *DB)</span> <span class="title">QueryRow</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Row</span></span></div></pre></td></tr></table></figure>
<p>再来看看返回值的结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Rows <span class="keyword">struct</span> &#123;</div><div class="line">    dc          *driverConn <span class="comment">// owned; must call releaseConn when closed to release</span></div><div class="line">    releaseConn <span class="function"><span class="keyword">func</span><span class="params">(error)</span></span></div><div class="line"><span class="function">    <span class="title">rowsi</span>       <span class="title">driver</span>.<span class="title">Rows</span></span></div><div class="line"><span class="function">    <span class="title">cancel</span>      <span class="title">func</span><span class="params">()</span>      // <span class="title">called</span> <span class="title">when</span> <span class="title">Rows</span> <span class="title">is</span> <span class="title">closed</span>, <span class="title">may</span> <span class="title">be</span> <span class="title">nil</span>.</span></div><div class="line"><span class="function">    <span class="title">closeStmt</span>   *<span class="title">driverStmt</span> // <span class="title">if</span> <span class="title">non</span>-<span class="title">nil</span>, <span class="title">statement</span> <span class="title">to</span> <span class="title">Close</span> <span class="title">on</span> <span class="title">close</span></span></div><div class="line"><span class="function">    <span class="title">closemu</span> <span class="title">sync</span>.<span class="title">RWMutex</span></span></div><div class="line"><span class="function">    <span class="title">closed</span>  <span class="title">bool</span></span></div><div class="line"><span class="function">    <span class="title">lasterr</span> <span class="title">error</span> // <span class="title">non</span>-<span class="title">nil</span> <span class="title">only</span> <span class="title">if</span> <span class="title">closed</span> <span class="title">is</span> <span class="title">true</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">    // <span class="title">lastcols</span> <span class="title">is</span> <span class="title">only</span> <span class="title">used</span> <span class="title">in</span> <span class="title">Scan</span>, <span class="title">Next</span>, <span class="title">and</span> <span class="title">NextResultSet</span> <span class="title">which</span> <span class="title">are</span> <span class="title">expected</span></span></div><div class="line"><span class="function">    // <span class="title">not</span> <span class="title">to</span> <span class="title">be</span> <span class="title">called</span> <span class="title">concurrently</span>.</span></div><div class="line"><span class="function">    <span class="title">lastcols</span> []<span class="title">driver</span>.<span class="title">Value</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">// <span class="title">Row</span> <span class="title">is</span> <span class="title">the</span> <span class="title">result</span> <span class="title">of</span> <span class="title">calling</span> <span class="title">QueryRow</span> <span class="title">to</span> <span class="title">select</span> <span class="title">a</span> <span class="title">single</span> <span class="title">row</span>.</span></div><div class="line"><span class="function"><span class="title">type</span> <span class="title">Row</span> <span class="title">struct</span></span> &#123;</div><div class="line">    <span class="comment">// One of these two will be non-nil:</span></div><div class="line">    err  error <span class="comment">// deferred error for easy chaining</span></div><div class="line">    rows *Rows</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以明显地看到Row将Rows包了一层，加了一个err字段，上面注释中说的<strong>而它引起的错误则会被推延到数据行的 Scan 方法被调用为止</strong>也就可以理解了，错误在error上而没有直接返回。</p>
<p>个人认为看源码最好带着问题看，有目的往往更能坚持。我们先来看一段最基本的调用代码，看看能不能找出几个我们感兴趣的问题：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">rows, err := db.Query(<span class="string">"SELECT * FROM User WHERE id=?"</span>, id_param)</div><div class="line">...</div><div class="line"><span class="keyword">defer</span> rows.Close()</div><div class="line"><span class="keyword">for</span> rows.Next() &#123;</div><div class="line">    <span class="keyword">var</span> id <span class="keyword">int</span></div><div class="line">    <span class="keyword">var</span> name <span class="keyword">string</span></div><div class="line">    err = rows.Scan(&amp;id, &amp;name)</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我的问题来了:</p>
<ol>
<li><p>这里query用的sql格式<strong>看上去是</strong><code>prepared statement</code>，我们知道<code>prepared statement</code>是可以防注入的。我们也知道不能够直接拼接字符串，直接拼接定会引入注入问题。那么问题来了，<code>prepared statement</code>会增加与服务器的交互，影响性能，是否能不使用<code>prepared statement</code>，如果不使用，像上面这样的query能否防注入呢？另外上面我们也只是说了<code>看上去是</code>，底层是否真的在使用<code>prepared statement</code>？</p>
<blockquote>
<p>要想使用<code>prepared statement</code>在数据库提前编译，复用的特性需要在客户端做很多事，比如JDBC就实现了一整套方案。目前看来database/sql没有这样的实现，所以这里可以忽略编译的优势。</p>
</blockquote>
</li>
<li><p>这个for的写法真是奇怪，简直看不懂到底在遍历什么，每次都是<code>rows.Scan</code>, <code>rows</code>里面到底存了些什么可以这么玩</p>
</li>
</ol>
<p>下面我们从这些问题出发来研究一下实现，我们会忽略掉与问题无关的部分（比如连接池），只关注我们需要的链路。</p>
<h3 id="Prepared-Statement-amp-防注入"><a href="#Prepared-Statement-amp-防注入" class="headerlink" title="Prepared Statement &amp; 防注入"></a>Prepared Statement &amp; 防注入</h3><p>Query之后还有几个函数调用才能到下面的函数，包括了取连接和错误处理的逻辑，这些对我们的问题没有影响，暂且忽略它们。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">queryDC</span><span class="params">(ctx, txctx context.Context, dc *driverConn, releaseConn <span class="keyword">func</span>(error)</span>, <span class="title">query</span> <span class="title">string</span>, <span class="title">args</span> []<span class="title">interface</span></span>&#123;&#125;) (*Rows, error) &#123;</div><div class="line">    <span class="comment">// 我们的driver实现了这个接口，这里可以走进去</span></div><div class="line">    <span class="keyword">if</span> queryer, ok := dc.ci.(driver.Queryer); ok &#123;</div><div class="line">        dargs, err := driverArgs(dc.ci, <span class="literal">nil</span>, args)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            releaseConn(err)</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> rowsi driver.Rows</div><div class="line">        withLock(dc, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            rowsi, err = ctxDriverQuery(ctx, queryer, query, dargs)  <span class="comment">// 尝试不使用`Prepared Statement`来执行</span></div><div class="line">        &#125;)</div><div class="line">        <span class="comment">// 这个错误非常重要，不想使用`Prepared Statement`，上面就不能返回这个错误</span></div><div class="line">        <span class="keyword">if</span> err != driver.ErrSkip &#123;</div><div class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                releaseConn(err)</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Note: ownership of dc passes to the *Rows, to be freed</span></div><div class="line">            <span class="comment">// with releaseConn.</span></div><div class="line">            rows := &amp;Rows&#123;</div><div class="line">                dc:          dc,</div><div class="line">                releaseConn: releaseConn,</div><div class="line">                rowsi:       rowsi,</div><div class="line">            &#125;</div><div class="line">            rows.initContextClose(ctx, txctx)</div><div class="line">            <span class="keyword">return</span> rows, <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 下面将会使用Prepared Statement，如果不想使用就要保证上面的代码能顺利return</span></div><div class="line">    <span class="keyword">var</span> si driver.Stmt</div><div class="line">    <span class="keyword">var</span> err error</div><div class="line">    withLock(dc, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        si, err = ctxDriverPrepare(ctx, dc.ci, query)</div><div class="line">    &#125;)</div><div class="line">    .....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的注释可以看到，Query默认不使用<code>prepared statement</code>，但是要保证正常查询不返回<code>driver.ErrSkip</code>，一旦返回这个错误，则会使用<code>prepared statement</code>继续查询。再往下跟我们将会走到driver中，我们来看看真实的query，在<code>go-sql-driver/mysql</code>的<code>connection.go</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mc *mysqlConn)</span> <span class="title">query</span><span class="params">(query <span class="keyword">string</span>, args []driver.Value)</span> <span class="params">(*textRows, error)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> mc.closed.IsSet() &#123;</div><div class="line">        errLog.Print(ErrInvalidConn)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, driver.ErrBadConn</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 考虑到注入问题所以一定有args，将会走进if</span></div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">0</span> &#123;</div><div class="line">        <span class="keyword">if</span> !mc.cfg.InterpolateParams &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, driver.ErrSkip  <span class="comment">// 我们就是不想返回这个错误，所以要保证mc.cfg.InterpolateParams为true</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// try client-side prepare to reduce roundtrip</span></div><div class="line">        prepared, err := mc.interpolateParams(query, args)  <span class="comment">// 这里将进行插值，能不能防注入就看这里了</span></div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">        &#125;</div><div class="line">        query = prepared</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Send command</span></div><div class="line">    err := mc.writeCommandPacketStr(comQuery, query)</div><div class="line">    ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InterpolateParams从字面上看意思是是否可以插值，它其实是dsn的一个参数，见<code>dsn.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Enable client side placeholder substitution</span></div><div class="line"><span class="keyword">case</span> <span class="string">"interpolateParams"</span>:</div><div class="line">    <span class="keyword">var</span> isBool <span class="keyword">bool</span></div><div class="line">    cfg.InterpolateParams, isBool = readBool(value)</div><div class="line">    <span class="keyword">if</span> !isBool &#123;</div><div class="line">        <span class="keyword">return</span> errors.New(<span class="string">"invalid bool value: "</span> + value)</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里我们就清楚了，如果不想使用<code>prepared statement</code>，就要在<code>dsn</code>中加入<code>interpolateParams=true</code>，允许驱动进行对sql进行插值。下一个问题，这里的插值能不能防注入？我们来看<code>interpolateParams</code>方法，我们只看参数为string的情况：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">'\''</span>)</div><div class="line">    <span class="keyword">if</span> mc.status&amp;statusNoBackslashEscapes == <span class="number">0</span> &#123;</div><div class="line">        buf = escapeStringBackslash(buf, v)  <span class="comment">// 将会走到这里</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        buf = escapeStringQuotes(buf, v)</div><div class="line">    &#125;</div><div class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">'\''</span>)</div></pre></td></tr></table></figure>
<p>从函数名我相信大家已经知道了，我们将会对字符串参数进行转义，而转义特殊字符是可以防止注入的，不妨再看看<code>escapeStringBackslash</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">func escapeBytesBackslash(buf, v []byte) []byte &#123;</div><div class="line">    pos := len(buf)</div><div class="line">    buf = reserveBuffer(buf, len(v)*2)</div><div class="line"></div><div class="line">    for _, c := range v &#123;</div><div class="line">        switch c &#123;</div><div class="line">        case &apos;\x00&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;0&apos;</div><div class="line">            pos += 2</div><div class="line">        case &apos;\n&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;n&apos;</div><div class="line">            pos += 2</div><div class="line">        case &apos;\r&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;r&apos;</div><div class="line">            pos += 2</div><div class="line">        case &apos;\x1a&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;Z&apos;</div><div class="line">            pos += 2</div><div class="line">        case &apos;\&apos;&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;\&apos;&apos;</div><div class="line">            pos += 2</div><div class="line">        case &apos;&quot;&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;&quot;&apos;</div><div class="line">            pos += 2</div><div class="line">        case &apos;\\&apos;:</div><div class="line">            buf[pos] = &apos;\\&apos;</div><div class="line">            buf[pos+1] = &apos;\\&apos;</div><div class="line">            pos += 2</div><div class="line">        default:</div><div class="line">            buf[pos] = c</div><div class="line">            pos++</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return buf[:pos]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一目了然。上面的分析基本解决了我们的第一个问题：dsn中加入<code>interpolateParams=true</code>可以不使用<code>prepared statement</code>，将sql的参数传入Query方法可以防止注入，防注入是驱动通过转义特殊字符来实现的。</p>
<p>第二个问题我们可以接着第一个问题的代码往下看，上面我们看了拼接好sql，下面就是真正的查询了，代码在<code>statement.go</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">func (stmt *mysqlStmt) query(args []driver.Value) (*binaryRows, error) &#123;</div><div class="line">    if stmt.mc.closed.IsSet() &#123;</div><div class="line">        errLog.Print(ErrInvalidConn)</div><div class="line">        return nil, driver.ErrBadConn</div><div class="line">    &#125;</div><div class="line">    // Send command</div><div class="line">    // 这个方法背后就是实现了`客户端命令请求报文`，非常值得一看，但是我们这里关心的是返回值，暂且跳过</div><div class="line">    err := stmt.writeExecutePacket(args)</div><div class="line">    if err != nil &#123;</div><div class="line">        return nil, stmt.mc.markBadConn(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mc := stmt.mc</div><div class="line"></div><div class="line">    // Read Result</div><div class="line">    // 这里虽然说是read result，但是只是根据协议读出了列的数量，用于下面的readColumns</div><div class="line">    // 注意，即使数据库中没有找到对应的记录，数据库仍然会将字段的信息返回，只是在返回的报文中</div><div class="line">    // Row Data没有数据</div><div class="line">    resLen, err := mc.readResultSetHeaderPacket()</div><div class="line">    if err != nil &#123;</div><div class="line">        return nil, err</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    rows := new(binaryRows)</div><div class="line"></div><div class="line">    if resLen &gt; 0 &#123;</div><div class="line">        rows.mc = mc</div><div class="line">        rows.rs.columns, err = mc.readColumns(resLen)  // 这里会将字段名（列名）读出然后存起来</div><div class="line">    &#125; else &#123;</div><div class="line">        rows.rs.done = true</div><div class="line"></div><div class="line">        switch err := rows.NextResultSet(); err &#123;</div><div class="line">        case nil, io.EOF:</div><div class="line">            return rows, nil</div><div class="line">        default:</div><div class="line">            return nil, err</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 竟然就这么返回了</div><div class="line">    return rows, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到了吗，query最后返回的时候，只是把字段名读出来了而已，根本没有读到我们需要的数据库中的记录。不妨大胆猜测：for Next将会每次从buffer中读出一条记录，将其赋值给某个变量，Scan就是在解析这个变量。让我们回到<code>database/sql</code>，在sql.go中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">func (rs *Rows) nextLocked() (doClose, ok bool) &#123;</div><div class="line">    if rs.closed &#123;</div><div class="line">        return false, false</div><div class="line">    &#125;</div><div class="line">    if rs.lastcols == nil &#123;</div><div class="line">        rs.lastcols = make([]driver.Value, len(rs.rowsi.Columns()))  // 哇哈哈，我想就是存在这里了</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Lock the driver connection before calling the driver interface</div><div class="line">    // rowsi to prevent a Tx from rolling back the connection at the same time.</div><div class="line">    rs.dc.Lock()</div><div class="line">    defer rs.dc.Unlock()</div><div class="line"></div><div class="line">    rs.lasterr = rs.rowsi.Next(rs.lastcols)  // 这里应该就是在读数据然后存到rs.lastcols</div><div class="line">    if rs.lasterr != nil &#123;</div><div class="line">	     ......</div><div class="line">    &#125;</div><div class="line">    return false, true</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再回到<code>go-sql-driver/mysql</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// rows.go</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rows *binaryRows)</span> <span class="title">Next</span><span class="params">(dest []driver.Value)</span> <span class="title">error</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> mc := rows.mc; mc != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">if</span> err := mc.error(); err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fetch next row from stream</span></div><div class="line">        <span class="comment">// 读数据并存到dest中，readRow中实现了针对Row Data 结构的解析</span></div><div class="line">        <span class="comment">// 复杂但真的值得一看</span></div><div class="line">        <span class="keyword">return</span> rows.readRow(dest)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> io.EOF</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>来来回回啊，再看<code>database/sql</code>的sql.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span> <span class="title">Scan</span><span class="params">(dest ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">    ......</div><div class="line">    <span class="comment">// 看到了吧，就是lastcols，遍历lastcols，将字段值放入到dest中</span></div><div class="line">    <span class="keyword">for</span> i, sv := <span class="keyword">range</span> rs.lastcols &#123;</div><div class="line">        err := convertAssign(dest[i], sv)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">"sql: Scan error on column index %d: %v"</span>, i, err)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此我们的第二个问题也解决了，Query返回的时候只是取出了字段信息，真实的数据库记录还留在buffer中，for循环Next，每次从buffer中读取一条记录，存在rows结构体的lastcols字段中，调用Scan的时候就是从lastcols取出值。</p>
<p>上面只是对大致流程的分析，里面还有大量的细节没有涉及到，特别是对于协议的实现，非常值得一看。</p>
<p>本文如有错误，欢迎联系O(∩_∩)O</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/10/路由查找之Radix-Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/10/路由查找之Radix-Tree/" itemprop="url">路由查找之Radix Tree</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-10T18:50:34+08:00">
                2018-02-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是Radix-Tree"><a href="#什么是Radix-Tree" class="headerlink" title="什么是Radix Tree"></a>什么是Radix Tree</h2><blockquote>
<p>在计算机科学中，基数树，或称Patricia trie/tree，或crit bit tree，压缩前缀树，是一种更节省空间的Trie（前缀树）。对于基数树的每个节点，如果该节点是唯一的子树的话，就和父节点合并。</p>
</blockquote>
<p><img src="/img/radix_tree.png" alt=""></p>
<p>golang的web框架<a href="https://github.com/labstack/echo" target="_blank" rel="external">echo</a>和<a href="https://github.com/gin-gonic/gin" target="_blank" rel="external">gin</a>都使用了<code>radix tree</code>作为路由查找的算法，我们以gin的实现来分析一下。</p>
<p>在gin的路由中，每一个<code>Http Method</code>(GET, PUT, POST…)都对应了一棵 <code>radix tree</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">func (engine *Engine) addRoute(method, path string, handlers HandlersChain) &#123;</div><div class="line">    // ...</div><div class="line">    </div><div class="line">    // 获取method对应的树，如果没有就创建</div><div class="line">    root := engine.trees.get(method)</div><div class="line">    if root == nil &#123;</div><div class="line">        // 创建radix tree，只有根节点</div><div class="line">        root = new(node)</div><div class="line">        engine.trees = append(engine.trees, methodTree&#123;method: method, root: root&#125;)</div><div class="line">    &#125;</div><div class="line">    root.addRoute(path, handlers)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>radix tree</code>可以被认为是一棵简洁版的前缀树。拥有共同前缀的节点也共享同一个父节点。下面是一个<code>GET</code>方法对应的路由树的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Priority   Path             Handle</div><div class="line">9          \                *&lt;1&gt;</div><div class="line">3          ├s               nil</div><div class="line">2          |├earch\         *&lt;2&gt;</div><div class="line">1          |└upport\        *&lt;3&gt;</div><div class="line">2          ├blog\           *&lt;4&gt;</div><div class="line">1          |    └:post      nil</div><div class="line">1          |         └\     *&lt;5&gt;</div><div class="line">2          ├about-us\       *&lt;6&gt;</div><div class="line">1          |        └team\  *&lt;7&gt;</div><div class="line">1          └contact\        *&lt;8&gt;</div></pre></td></tr></table></figure>
<p><code>*&lt;num&gt;</code>是方法（handler）对应的指针，从根节点遍历到叶子节点我们就能得到完整的路由表，图中的示例实现了以下路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET(&quot;/&quot;, func1)</div><div class="line">GET(&quot;/search/&quot;, func2)</div><div class="line">GET(&quot;/support/&quot;, func3)</div><div class="line">GET(&quot;/blog/&quot;, func4)</div><div class="line">GET(&quot;/blog/:post/&quot;, func5)</div><div class="line">GET(&quot;/about-us/&quot;, func6)</div><div class="line">GET(&quot;/about-us/team/&quot;, func7)</div><div class="line">GET(&quot;/contact/&quot;, func8)</div></pre></td></tr></table></figure>
<p><code>:post</code>是真实的<code>post name</code>的一个占位符（就是一个参数）。这里体现了radix tree相较于hash-map的一个优点，树结构允许我们的路径中存在动态的部分（参数）,因为我们匹配的是路由的模式而不是hash值</p>
<p>为了更具扩展性，每一层的节点按照priority排序，priority是节点的子节点（儿子节点，孙子节点等）注册的handler的数量，这样做有两个好处：</p>
<ol>
<li>被最多路径包含的节点会被最先评估。这样可以让尽量多的路由快速被定位。</li>
<li>有点像成本补偿。最长的路径可以被最先评估，补偿体现在最长的路径需要花费更长的时间来定位，如果最长路径的节点能被优先评估（即每次拿子节点都命中），那么所花时间不一定比短路径的路由长。下面展示了节点（每个<code>-</code>可以看做一个节点）评估的路径：从左到右，从上到下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">├------------</div><div class="line">├---------</div><div class="line">├-----</div><div class="line">├----</div><div class="line">├--</div><div class="line">├--</div><div class="line">└-</div></pre></td></tr></table></figure>
<h2 id="节点数据结构"><a href="#节点数据结构" class="headerlink" title="节点数据结构"></a>节点数据结构</h2><p>节点的数据结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">type node struct &#123;</div><div class="line">    // 节点路径，比如上面的s，earch，和upport</div><div class="line">    path      string</div><div class="line">    // 节点是否是参数节点，比如上面的:post</div><div class="line">    wildChild bool</div><div class="line">    // 节点类型，包括static, root, param, catchAll</div><div class="line">    // static: 静态节点，比如上面的s，earch等节点</div><div class="line">    // root: 树的根节点</div><div class="line">    // catchAll: 有*匹配的节点</div><div class="line">    // param: 参数节点</div><div class="line">    nType     nodeType</div><div class="line">    // 路径上最大参数个数</div><div class="line">    maxParams uint8</div><div class="line">    // 和children字段对应, 保存的是分裂的分支的第一个字符</div><div class="line">    // 例如search和support, 那么s节点的indices对应的&quot;eu&quot;</div><div class="line">    // 代表有两个分支, 分支的首字母分别是e和u</div><div class="line">    indices   string</div><div class="line">    // 儿子节点</div><div class="line">    children  []*node</div><div class="line">    // 处理函数</div><div class="line">    handlers  HandlersChain</div><div class="line">    // 优先级，子节点注册的handler数量</div><div class="line">    priority  uint32</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line">func (n *node) addRoute(path string, handlers HandlersChain) &#123;</div><div class="line">    fullPath := path</div><div class="line">    n.priority++</div><div class="line">    numParams := countParams(path)</div><div class="line"></div><div class="line">    // non-empty tree</div><div class="line">    if len(n.path) &gt; 0 || len(n.children) &gt; 0 &#123;</div><div class="line">    walk:</div><div class="line">        for &#123;</div><div class="line">            // Update maxParams of the current node</div><div class="line">            if numParams &gt; n.maxParams &#123;</div><div class="line">                n.maxParams = numParams</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Find the longest common prefix.</div><div class="line">            // This also implies that the common prefix contains no &apos;:&apos; or &apos;*&apos;</div><div class="line">            // since the existing key can&apos;t contain those chars.</div><div class="line">            i := 0</div><div class="line">            max := min(len(path), len(n.path))</div><div class="line">            for i &lt; max &amp;&amp; path[i] == n.path[i] &#123;</div><div class="line">                i++</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Split edge</div><div class="line">            // 开始分裂，比如一开始path是search，新来了support，s是他们匹配的部分，</div><div class="line">            // 那么会将s拿出来作为parent节点，增加earch和upport作为child节点</div><div class="line">            if i &lt; len(n.path) &#123;</div><div class="line">                child := node&#123;</div><div class="line">                    path:      n.path[i:],  // 不匹配的部分作为child节点</div><div class="line">                    wildChild: n.wildChild,</div><div class="line">                    indices:   n.indices,</div><div class="line">                    children:  n.children,</div><div class="line">                    handlers:  n.handlers,</div><div class="line">                    priority:  n.priority - 1,  // 降级成子节点，priority减1</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Update maxParams (max of all children)</div><div class="line">                for i := range child.children &#123;</div><div class="line">                    if child.children[i].maxParams &gt; child.maxParams &#123;</div><div class="line">                        child.maxParams = child.children[i].maxParams</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                // 当前节点的子节点变成刚刚分裂的出来的节点</div><div class="line">                n.children = []*node&#123;&amp;child&#125;</div><div class="line">                // []byte for proper unicode char conversion, see #65</div><div class="line">                n.indices = string([]byte&#123;n.path[i]&#125;)</div><div class="line">                n.path = path[:i]</div><div class="line">                n.handlers = nil</div><div class="line">                n.wildChild = false</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Make new node a child of this node</div><div class="line">            // 将新来的节点插入新的parent节点作为子节点</div><div class="line">            if i &lt; len(path) &#123;</div><div class="line">                path = path[i:]</div><div class="line"></div><div class="line">					// 如果是参数节点（包含:或*）</div><div class="line">                if n.wildChild &#123;</div><div class="line">                    n = n.children[0]</div><div class="line">                    n.priority++</div><div class="line"></div><div class="line">                    // Update maxParams of the child node</div><div class="line">                    if numParams &gt; n.maxParams &#123;</div><div class="line">                        n.maxParams = numParams</div><div class="line">                    &#125;</div><div class="line">                    numParams--</div><div class="line"></div><div class="line">                    // Check if the wildcard matches</div><div class="line">                    // 例如：/blog/:pp 和 /blog/:ppp，需要检查更长的通配符</div><div class="line">                    if len(path) &gt;= len(n.path) &amp;&amp; n.path == path[:len(n.path)] &#123;</div><div class="line">                        // check for longer wildcard, e.g. :name and :names</div><div class="line">                        if len(n.path) &gt;= len(path) || path[len(n.path)] == &apos;/&apos; &#123;</div><div class="line">                            continue walk</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    panic(&quot;path segment &apos;&quot; + path +</div><div class="line">                        &quot;&apos; conflicts with existing wildcard &apos;&quot; + n.path +</div><div class="line">                        &quot;&apos; in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">                &#125;</div><div class="line"></div><div class="line">					// 首字母，用来与indices做比较</div><div class="line">                c := path[0]</div><div class="line"></div><div class="line">                // slash after param</div><div class="line">                if n.nType == param &amp;&amp; c == &apos;/&apos; &amp;&amp; len(n.children) == 1 &#123;</div><div class="line">                    n = n.children[0]</div><div class="line">                    n.priority++</div><div class="line">                    continue walk</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Check if a child with the next path byte exists</div><div class="line">                // 判断子节点中是否有和当前path有匹配的，只需要查看子节点path的第一个字母即可，即indices</div><div class="line">                // 比如s的子节点现在是earch和upport，indices为eu</div><div class="line">                // 如果新来的路由为super，那么就是和upport有匹配的部分u，将继续分类现在的upport节点</div><div class="line">                for i := 0; i &lt; len(n.indices); i++ &#123;</div><div class="line">                    if c == n.indices[i] &#123;</div><div class="line">                        i = n.incrementChildPrio(i)</div><div class="line">                        n = n.children[i]</div><div class="line">                        continue walk</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Otherwise insert it</div><div class="line">                if c != &apos;:&apos; &amp;&amp; c != &apos;*&apos; &#123;</div><div class="line">                    // []byte for proper unicode char conversion, see #65</div><div class="line">                    // 记录第一个字符，放在indices中</div><div class="line">                    n.indices += string([]byte&#123;c&#125;)</div><div class="line">                    child := &amp;node&#123;</div><div class="line">                        maxParams: numParams,</div><div class="line">                    &#125;</div><div class="line">                    // 增加子节点</div><div class="line">                    n.children = append(n.children, child)</div><div class="line">                    n.incrementChildPrio(len(n.indices) - 1)</div><div class="line">                    n = child</div><div class="line">                &#125;</div><div class="line">                n.insertChild(numParams, path, fullPath, handlers)</div><div class="line">                return</div><div class="line"></div><div class="line">            &#125; else if i == len(path) &#123; // Make node a (in-path) leaf</div><div class="line">                // 路径相同，如果已有handler就报错，没有就赋值</div><div class="line">                if n.handlers != nil &#123;</div><div class="line">                    panic(&quot;handlers are already registered for path &apos;&apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">                &#125;</div><div class="line">                n.handlers = handlers</div><div class="line">            &#125;</div><div class="line">            return</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123; // Empty tree，空树，插入节点，节点种类是root</div><div class="line">        n.insertChild(numParams, path, fullPath, handlers)</div><div class="line">        n.nType = root</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此函数的主要目的是找到插入节点的位置，如果和现有节点存在相同的前缀，那么要将现有节点进行分裂，然后再插入，下面是<code>insertChild</code>函数</p>
<h2 id="插入子节点"><a href="#插入子节点" class="headerlink" title="插入子节点"></a>插入子节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line">// @1: 参数个数</div><div class="line">// @2: 路径</div><div class="line">// @3: 完整路径</div><div class="line">// @4: 处理函数</div><div class="line">func (n *node) insertChild(numParams uint8, path string, fullPath string, handlers HandlersChain) &#123;</div><div class="line">    var offset int // already handled bytes of the path</div><div class="line"></div><div class="line">    // find prefix until first wildcard (beginning with &apos;:&apos;&apos; or &apos;*&apos;&apos;)</div><div class="line">    // 找到前缀，只要匹配到wildcard</div><div class="line">    for i, max := 0, len(path); numParams &gt; 0; i++ &#123;</div><div class="line">        c := path[i]</div><div class="line">        if c != &apos;:&apos; &amp;&amp; c != &apos;*&apos; &#123;</div><div class="line">            continue</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // find wildcard end (either &apos;/&apos; or path end)</div><div class="line">        end := i + 1</div><div class="line">        for end &lt; max &amp;&amp; path[end] != &apos;/&apos; &#123;</div><div class="line">            switch path[end] &#123;</div><div class="line">            // the wildcard name must not contain &apos;:&apos; and &apos;*&apos;</div><div class="line">            case &apos;:&apos;, &apos;*&apos;:</div><div class="line">                panic(&quot;only one wildcard per path segment is allowed, has: &apos;&quot; +</div><div class="line">                    path[i:] + &quot;&apos; in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">            default:</div><div class="line">                end++</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // check if this Node existing children which would be</div><div class="line">        // unreachable if we insert the wildcard here</div><div class="line">        if len(n.children) &gt; 0 &#123;</div><div class="line">            panic(&quot;wildcard route &apos;&quot; + path[i:end] +</div><div class="line">                &quot;&apos; conflicts with existing children in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // check if the wildcard has a name</div><div class="line">        if end-i &lt; 2 &#123;</div><div class="line">            panic(&quot;wildcards must be named with a non-empty name in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if c == &apos;:&apos; &#123; // param</div><div class="line">            // split path at the beginning of the wildcard</div><div class="line">            if i &gt; 0 &#123;</div><div class="line">                n.path = path[offset:i]</div><div class="line">                offset = i</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            child := &amp;node&#123;</div><div class="line">                nType:     param,</div><div class="line">                maxParams: numParams,</div><div class="line">            &#125;</div><div class="line">            n.children = []*node&#123;child&#125;</div><div class="line">            n.wildChild = true</div><div class="line">            n = child</div><div class="line">            n.priority++</div><div class="line">            numParams--</div><div class="line"></div><div class="line">            // if the path doesn&apos;t end with the wildcard, then there</div><div class="line">            // will be another non-wildcard subpath starting with &apos;/&apos;</div><div class="line">            if end &lt; max &#123;</div><div class="line">                n.path = path[offset:end]</div><div class="line">                offset = end</div><div class="line">                </div><div class="line">                child := &amp;node&#123;</div><div class="line">                    maxParams: numParams,</div><div class="line">                    priority:  1,</div><div class="line">                &#125;</div><div class="line">                n.children = []*node&#123;child&#125;</div><div class="line">                // 下次循环这个新的child节点</div><div class="line">                n = child</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; else &#123; // catchAll</div><div class="line">            if end != max || numParams &gt; 1 &#123;</div><div class="line">                panic(&quot;catch-all routes are only allowed at the end of the path in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if len(n.path) &gt; 0 &amp;&amp; n.path[len(n.path)-1] == &apos;/&apos; &#123;</div><div class="line">                panic(&quot;catch-all conflicts with existing handle for the path segment root in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // currently fixed width 1 for &apos;/&apos;</div><div class="line">            i--</div><div class="line">            if path[i] != &apos;/&apos; &#123;</div><div class="line">                panic(&quot;no / before catch-all in path &apos;&quot; + fullPath + &quot;&apos;&quot;)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            n.path = path[offset:i]</div><div class="line"></div><div class="line">            // first node: catchAll node with empty path</div><div class="line">            child := &amp;node&#123;</div><div class="line">                wildChild: true,</div><div class="line">                nType:     catchAll,</div><div class="line">                maxParams: 1,</div><div class="line">            &#125;</div><div class="line">            n.children = []*node&#123;child&#125;</div><div class="line">            n.indices = string(path[i])</div><div class="line">            n = child</div><div class="line">            n.priority++</div><div class="line"></div><div class="line">            // second node: node holding the variable</div><div class="line">            child = &amp;node&#123;</div><div class="line">                path:      path[i:],</div><div class="line">                nType:     catchAll,</div><div class="line">                maxParams: 1,</div><div class="line">                handlers:  handlers,</div><div class="line">                priority:  1,</div><div class="line">            &#125;</div><div class="line">            n.children = []*node&#123;child&#125;</div><div class="line"></div><div class="line">            return</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // insert remaining path part and handle to the leaf</div><div class="line">    n.path = path[offset:]</div><div class="line">    n.handlers = handlers</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>insertChild</code>函数是根据<code>path</code>本身进行分割, 将<code>/</code>分开的部分分别作为节点保存, 形成一棵树结构. 注意参数匹配中的<code>:</code>和<code>*</code>的区别, 前者是匹配一个字段, 后者是匹配后面所有的路径</p>
<h2 id="路径查找"><a href="#路径查找" class="headerlink" title="路径查找"></a>路径查找</h2><p>匹配每个children的path，最长匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line">// Returns the handle registered with the given path (key). The values of</div><div class="line">// wildcards are saved to a map.</div><div class="line">// If no handle can be found, a TSR (trailing slash redirect) recommendation is</div><div class="line">// made if a handle exists with an extra (without the) trailing slash for the</div><div class="line">// given path.</div><div class="line">func (n *node) getValue(path string, po Params, unescape bool) (handlers HandlersChain, p Params, tsr bool) &#123;</div><div class="line">    p = po</div><div class="line">walk: // Outer loop for walking the tree</div><div class="line">    for &#123;</div><div class="line">        // 尚未到达path的终点</div><div class="line">        if len(path) &gt; len(n.path) &#123;</div><div class="line">            // 前面一段需要一致</div><div class="line">            if path[:len(n.path)] == n.path &#123;</div><div class="line">                path = path[len(n.path):]</div><div class="line">                // If this node does not have a wildcard (param or catchAll)</div><div class="line">                // child,  we can just look up the next child node and continue</div><div class="line">                // to walk down the tree</div><div class="line">                if !n.wildChild &#123;</div><div class="line">                    c := path[0]</div><div class="line">                    for i := 0; i &lt; len(n.indices); i++ &#123;</div><div class="line">                        if c == n.indices[i] &#123;</div><div class="line">                            n = n.children[i]</div><div class="line">                            continue walk</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    // Nothing found.</div><div class="line">                    // We can recommend to redirect to the same URL without a</div><div class="line">                    // trailing slash if a leaf exists for that path.</div><div class="line">                    tsr = (path == &quot;/&quot; &amp;&amp; n.handlers != nil)</div><div class="line">                    return</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // handle wildcard child</div><div class="line">                n = n.children[0]</div><div class="line">                switch n.nType &#123;</div><div class="line">                case param:</div><div class="line">                    // find param end (either &apos;/&apos; or path end)</div><div class="line">                    end := 0</div><div class="line">                    for end &lt; len(path) &amp;&amp; path[end] != &apos;/&apos; &#123;</div><div class="line">                        end++</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    // save param value</div><div class="line">                    if cap(p) &lt; int(n.maxParams) &#123;</div><div class="line">                        p = make(Params, 0, n.maxParams)</div><div class="line">                    &#125;</div><div class="line">                    i := len(p)</div><div class="line">                    p = p[:i+1] // expand slice within preallocated capacity</div><div class="line">                    p[i].Key = n.path[1:]</div><div class="line">                    val := path[:end]</div><div class="line">                    if unescape &#123;</div><div class="line">                        var err error</div><div class="line">                        if p[i].Value, err = url.QueryUnescape(val); err != nil &#123;</div><div class="line">                            p[i].Value = val // fallback, in case of error</div><div class="line">                        &#125;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        p[i].Value = val</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    // we need to go deeper!</div><div class="line">                                        if end &lt; len(path) &#123;</div><div class="line">                        if len(n.children) &gt; 0 &#123;</div><div class="line">                            path = path[end:]</div><div class="line">                            n = n.children[0]</div><div class="line">                            continue walk</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        // ... but we can&apos;t</div><div class="line">                        tsr = (len(path) == end+1)</div><div class="line">                        return</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    if handlers = n.handlers; handlers != nil &#123;</div><div class="line">                        return</div><div class="line">                    &#125;</div><div class="line">                    if len(n.children) == 1 &#123;</div><div class="line">                        // No handle found. Check if a handle for this path + a</div><div class="line">                        // trailing slash exists for TSR recommendation</div><div class="line">                        n = n.children[0]</div><div class="line">                        tsr = (n.path == &quot;/&quot; &amp;&amp; n.handlers != nil)</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    return</div><div class="line"></div><div class="line">                case catchAll:</div><div class="line">                    // save param value</div><div class="line">                    if cap(p) &lt; int(n.maxParams) &#123;</div><div class="line">                        p = make(Params, 0, n.maxParams)</div><div class="line">                    &#125;</div><div class="line">                    i := len(p)</div><div class="line">                    p = p[:i+1] // expand slice within preallocated capacity</div><div class="line">                    p[i].Key = n.path[2:]</div><div class="line">                    if unescape &#123;</div><div class="line">                        var err error</div><div class="line">                        if p[i].Value, err = url.QueryUnescape(path); err != nil &#123;</div><div class="line">                            p[i].Value = path // fallback, in case of error</div><div class="line">                        &#125;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        p[i].Value = path</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    handlers = n.handlers</div><div class="line">                    return</div><div class="line"></div><div class="line">                default:</div><div class="line">                    panic(&quot;invalid node type&quot;)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; else if path == n.path &#123;</div><div class="line">            // We should have reached the node containing the handle.</div><div class="line">            // Check if this node has a handle registered.</div><div class="line">            if handlers = n.handlers; handlers != nil &#123;</div><div class="line">                return</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if path == &quot;/&quot; &amp;&amp; n.wildChild &amp;&amp; n.nType != root &#123;</div><div class="line">                tsr = true</div><div class="line">                return</div><div class="line">            &#125;</div><div class="line">            // No handle found. Check if a handle for this path + a</div><div class="line">            // trailing slash exists for trailing slash recommendation</div><div class="line">            for i := 0; i &lt; len(n.indices); i++ &#123;</div><div class="line">                if n.indices[i] == &apos;/&apos; &#123;</div><div class="line">                    n = n.children[i]</div><div class="line">                    tsr = (len(n.path) == 1 &amp;&amp; n.handlers != nil) ||</div><div class="line">                        (n.nType == catchAll &amp;&amp; n.children[0].handlers != nil)</div><div class="line">                    return</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Nothing found. We can recommend to redirect to the same URL with an</div><div class="line">        // extra trailing slash if a leaf exists for that path</div><div class="line">        tsr = (path == &quot;/&quot;) ||</div><div class="line">            (len(n.path) == len(path)+1 &amp;&amp; n.path[len(path)] == &apos;/&apos; &amp;&amp;</div><div class="line">                path == n.path[:len(n.path)-1] &amp;&amp; n.handlers != nil)</div><div class="line">        return</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之前总听大家说数据结构与算法有什么用，工作中又用不到，上面就是一个很好的示例。我们平时还是要多关注底层原理，做后端的同学多看看框架的代码，一定受益匪浅~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/06/go-pprof-采样何时进行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/06/go-pprof-采样何时进行/" itemprop="url">go pprof 采样何时进行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-06T15:20:36+08:00">
                2017-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> (</div><div class="line">	_ <span class="string">"net/http/pprof"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		log.Println(http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>))</div><div class="line">	&#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码大家应该都很熟悉，<code>go tool pprof</code>工具的通用代码，用来做性能等分析。我这两天尝试用了一下，不免有了一个疑问：<code>pprof</code>是要采样的，这个采样是何时进行的？是程序启动就开始采样还是当我<code>curl localhost:$PORT/debug/pprof/$PROFILE_TYPE</code>开始？</p>
<p>为什么会考虑这个呢，主要是在看的框架里集成了<code>pprof</code>，默认打开，如果是程序一开始就采样，那对于性能是有损耗的。这种问题别人回答你，你也不一定相信，我们还是来看看<code>pprof</code>的代码吧。</p>
<p>标准库的代码是在<code>$GOROOT/src</code>下面，我们找一下<code>pprof</code>，在我的mac上路径是<code>/usr/local/Cellar/go/1.9.2/libexec/src/net/http/pprof/pprof.go</code></p>
<p>首先是<code>init</code>函数，注册了我们用到的分析urls：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/"</span>, http.HandlerFunc(Index))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/cmdline"</span>, http.HandlerFunc(Cmdline))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/profile"</span>, http.HandlerFunc(Profile))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/symbol"</span>, http.HandlerFunc(Symbol))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/trace"</span>, http.HandlerFunc(Trace))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是在程序启动就执行的，这也是我们感觉只要import就万事大吉的原因。其实看到这里应该就明白了，profile只是普通的函数调用而已，程序启动只是注册了handler，真正的采样应该是在请求之后执行的。</p>
<p>但是来都来了，我们不妨往下看看，毕竟需要看标准库的机会不多。我们来看一下<code>cpu profile</code>，也就是<code>Profile</code>函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Profile responds with the pprof-formatted cpu profile.</span></div><div class="line"><span class="comment">// The package initialization registers it as /debug/pprof/profile.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Profile</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">    sec, _ := strconv.ParseInt(r.FormValue(<span class="string">"seconds"</span>), <span class="number">10</span>, <span class="number">64</span>)</div><div class="line">    <span class="keyword">if</span> sec == <span class="number">0</span> &#123;</div><div class="line">        sec = <span class="number">30</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> durationExceedsWriteTimeout(r, <span class="keyword">float64</span>(sec)) &#123;</div><div class="line">        w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain; charset=utf-8"</span>)</div><div class="line">        w.Header().Set(<span class="string">"X-Go-Pprof"</span>, <span class="string">"1"</span>)</div><div class="line">        w.WriteHeader(http.StatusBadRequest)</div><div class="line">        fmt.Fprintln(w, <span class="string">"profile duration exceeds server's WriteTimeout"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set Content Type assuming StartCPUProfile will work,</span></div><div class="line">    <span class="comment">// because if it does it starts writing.</span></div><div class="line">    w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/octet-stream"</span>)</div><div class="line">    <span class="keyword">if</span> err := pprof.StartCPUProfile(w); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="comment">// StartCPUProfile failed, so no writes yet.</span></div><div class="line">        <span class="comment">// Can change header back to text content</span></div><div class="line">        <span class="comment">// and send error code.</span></div><div class="line">        w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain; charset=utf-8"</span>)</div><div class="line">        w.Header().Set(<span class="string">"X-Go-Pprof"</span>, <span class="string">"1"</span>)</div><div class="line">        w.WriteHeader(http.StatusInternalServerError)</div><div class="line">        fmt.Fprintf(w, <span class="string">"Could not enable CPU profiling: %s\n"</span>, err)</div><div class="line">                <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    sleep(w, time.Duration(sec)*time.Second)</div><div class="line">    pprof.StopCPUProfile()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取了一个默认30秒的时间，执行<code>StartCPUProfile</code>，里面应该是个<code>goroutine</code>，调用返回后sleep了一下，结束<code>cpu profile</code>。采样应该是在<code>StartCPUProfile</code>，执行seconds时间。</p>
<p>再来看看<code>StartCPUProfile</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartCPUProfile</span><span class="params">(w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">    <span class="comment">// The runtime routines allow a variable profiling rate,</span></div><div class="line">    <span class="comment">// but in practice operating systems cannot trigger signals</span></div><div class="line">    <span class="comment">// at more than about 500 Hz, and our processing of the</span></div><div class="line">    <span class="comment">// signal is not cheap (mostly getting the stack trace).</span></div><div class="line">    <span class="comment">// 100 Hz is a reasonable choice: it is frequent enough to</span></div><div class="line">    <span class="comment">// produce useful data, rare enough not to bog down the</span></div><div class="line">    <span class="comment">// system, and a nice round number to make it easy to</span></div><div class="line">    <span class="comment">// convert sample counts to seconds. Instead of requiring</span></div><div class="line">    <span class="comment">// each client to specify the frequency, we hard code it.</span></div><div class="line">    <span class="keyword">const</span> hz = <span class="number">100</span></div><div class="line"></div><div class="line">    cpu.Lock()</div><div class="line">    <span class="keyword">defer</span> cpu.Unlock()</div><div class="line">    <span class="keyword">if</span> cpu.done == <span class="literal">nil</span> &#123;</div><div class="line">        cpu.done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Double-check.</span></div><div class="line">    <span class="keyword">if</span> cpu.profiling &#123;</div><div class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"cpu profiling already in use"</span>)</div><div class="line">    &#125;</div><div class="line">    cpu.profiling = <span class="literal">true</span></div><div class="line">    runtime.SetCPUProfileRate(hz)</div><div class="line">    <span class="keyword">go</span> profileWriter(w)</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注释解释了取样频率的由来，我们先看一下CPU主频的概念：</p>
<blockquote>
<p>CPU的主频，即CPU内核工作的时钟频率（CPU Clock Speed）。CPU的主频的基本单位是赫兹（Hz），但更多的是以兆赫兹（MHz）或吉赫兹（GHz）为单位。时钟频率的倒数即为时钟周期。时钟周期的基本单位为秒（s），但更多的是以毫秒（ms）、微妙（us）或纳秒（ns）为单位。在一个时钟周期内，CPU执行一条运算指令。也就是说，在1000 Hz的CPU主频下，每1毫秒可以执行一条CPU运算指令。在1 MHz的CPU主频下，每1微妙可以执行一条CPU运算指令。而在1 GHz的CPU主频下，每1纳秒可以执行一条CPU运算指令。</p>
</blockquote>
<p>在默认情况下，Go语言的运行时系统会以100 Hz的的频率对CPU使用情况进行取样。也就是说每秒取样100次，即每10毫秒会取样一次。为什么使用这个频率呢？因为100 Hz既足够产生有用的数据，又不至于让系统产生停顿。并且100这个数上也很容易做换算，比如把总取样计数换算为每秒的取样数。实际上，这里所说的对CPU使用情况的取样就是对当前的Goroutine的堆栈上的程序计数器的取样。由此，我们就可以从样本记录中分析出哪些代码是计算时间最长或者说最耗CPU资源的部分了。</p>
<p>代码很容易理解，锁住cpu，设置runtime的采样频率，<code>profileWriter</code>就是实际采样了。</p>
<p>所以结论是，采样在请求之后才会进行，线上打开采样的接口没有问题。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="external">Profiling Go Programs</a></li>
<li><a href="https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/" target="_blank" rel="external">Profiling Go programs with pprof</a></li>
<li><a href="http://wiki.jikexueyuan.com/project/go-command-tutorial/0.12.html" target="_blank" rel="external">go tool pprof</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/05/go语言死循环分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/05/go语言死循环分析/" itemprop="url">go语言死循环分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-05T12:18:55+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近看了一篇文章，<a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a>，里面有这样一段代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"io"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(runtime.NumCPU())</div><div class="line">    <span class="keyword">go</span> server()</div><div class="line">    <span class="keyword">go</span> printNum()</div><div class="line">    <span class="keyword">var</span> i = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="comment">// will block here, and never go out</span></div><div class="line">        i++</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"for loop end"</span>)</div><div class="line">    time.Sleep(time.Second * <span class="number">3600</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printNum</span><span class="params">()</span></span> &#123;</div><div class="line">    i := <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(i)</div><div class="line">        i++</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"hello world"</span>)</div><div class="line">    io.WriteString(w, <span class="string">"hello, world!\n"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">()</span></span> &#123;</div><div class="line">    http.HandleFunc(<span class="string">"/"</span>, HelloServer)</div><div class="line">    err := http.ListenAndServe(<span class="string">":12345"</span>, <span class="literal">nil</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"ListenAndServe: "</span>, err)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行，会发现打印一会儿数字后停了，我们执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl localhost:12345</div></pre></td></tr></table></figure>
<p>程序卡死。关于程序挂在哪里借助<code>dlv</code>是很好定位的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dlv debug hang.go</div></pre></td></tr></table></figure>
<p>进去之后运行程序，打印停止进入卡死状态，我们执行<code>ctrl C</code>，<code>dlv</code>会显示断开的地方：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">received SIGINT, stopping process (will not forward signal)&gt; main.main() ./hang.<span class="keyword">go</span>:<span class="number">17</span> (PC: <span class="number">0x12dd</span>7c8)</div><div class="line">    <span class="number">12</span>: <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="number">13</span>:         runtime.GOMAXPROCS(runtime.NumCPU())</div><div class="line">    <span class="number">14</span>:         <span class="keyword">go</span> server()</div><div class="line">    <span class="number">15</span>:         <span class="keyword">go</span> printNum()</div><div class="line">    <span class="number">16</span>:         <span class="keyword">var</span> i = <span class="number">1</span></div><div class="line">=&gt;  <span class="number">17</span>:         <span class="keyword">for</span> &#123;</div><div class="line">    <span class="number">18</span>:                 <span class="comment">// will block here, and never go out</span></div><div class="line">    <span class="number">19</span>:                 i++</div><div class="line">    <span class="number">20</span>:         &#125;</div><div class="line">    <span class="number">21</span>:         fmt.Println(<span class="string">"for loop end"</span>)</div><div class="line">    <span class="number">22</span>:         time.Sleep(time.Second * <span class="number">3600</span>)</div><div class="line">(dlv)</div></pre></td></tr></table></figure>
<p>但是我还是不明白，不明白的地方主要是因为：</p>
<ul>
<li>我又看了两篇文章<a href="http://tonybai.com/2017/11/23/the-simple-analysis-of-goroutine-schedule-examples/" target="_blank" rel="external">Goroutine调度实例简要分析</a>和<a href="http://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/" target="_blank" rel="external">也谈goroutine调度器</a>，是同一位作者Tony Bai写的，写得非常好。第二篇文章解释了goroutine的调度和cpu数量的关系（不多加解释，建议大家看看），我的mac是双核四线程（这里不明白的同学自行google cpu 超线程），go版本是1.9，理论上讲可以跑4个goroutine而不用考虑死循环，一个死循环最多把一个cpu打死，上面的代码中只有3个goroutine，而且他们看上去都挂住了。</li>
<li>上面说的理论上讲，不是我主观臆测的，我跑了<code>1</code>中<a href="http://tonybai.com/2017/11/23/the-simple-analysis-of-goroutine-schedule-examples/" target="_blank" rel="external">第一篇文章</a>中的一个例子:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">deadloop</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> deadloop()</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        time.Sleep(time.Second * <span class="number">1</span>)</div><div class="line">        fmt.Println(<span class="string">"I got scheduled!"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码有两个goroutine，一个是<code>main goroutine</code>，一个是<code>deadloop goroutine</code>，跑得时候<code>deadloop gouroutine</code>不会对<code>main goroutine</code>造成影响，打印一直在持续，作者的文章解释了原因。</p>
<ul>
<li><a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a>这篇文章提到了<code>gcwaiting</code>，然而没有解释。</li>
</ul>
<p>在<a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a>有这样一段话：</p>
<blockquote>
<p>因为在 for 循环中没有函数调用的话，编译器不会插入调度代码，所以这个执行 for 循环的 goroutine 没有办法被调出，而在循环期间碰到 gc，那么就会卡在 gcwaiting 阶段，并且整个进程永远 hang 死在这个循环上。并不再对外响应。</p>
</blockquote>
<p>这个其实就是我们的第一段代码卡死的原因，也是我们第二段代码没有卡死的原因，就是在<code>gc</code>上！</p>
<p>我们再看一篇文章，<a href="https://studygolang.com/articles/9004" target="_blank" rel="external">golang的垃圾回收（GC）机制</a>，这篇文章很短，但每句话都很重要：</p>
<blockquote>
<ol>
<li>设置gcwaiting=1，这个在每一个G任务之前会检查一次这个状态，如是，则会将当前M 休眠；</li>
<li>如果这个M里面正在运行一个长时间的G任务，咋办呢，难道会等待这个G任务自己切换吗？这样的话可要等10ms啊，不能等！坚决不能等！<br>所以会主动发出抢占标记（类似于上一篇），让当前G任务中断，再运行下一个G任务的时候，就会走到第1步</li>
</ol>
</blockquote>
<p>那么如果这时候运行的是没有函数调用的死循环呢，gc也发出了抢占标记，但是如果死循环没有函数调用，就没有地方被标记，无法被抢占，那就只能设置<code>gcwaiting=1</code>，而<strong>M没有休眠</strong>，<code>stop the world</code>卡住了（死锁），<code>gcwaiting</code>一直是1，整个程序都卡住了！</p>
<p>这里其实已经解释了第一份代码的现象，第二份代码为什么没有hang住相信大家也能猜到了：代码里没有触发gc！我们来手动触发一下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    _ <span class="string">"net/http/pprof"</span></div><div class="line">    <span class="comment">// "runtime"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">deadloop</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>))</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">go</span> deadloop()</div><div class="line">    i := <span class="number">3</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        time.Sleep(time.Second * <span class="number">1</span>)</div><div class="line">        i--</div><div class="line">        fmt.Println(<span class="string">"I got scheduled!"</span>)</div><div class="line">        <span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">            runtime.GC()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会发现打印了3行之后，程序也卡死了，bingo🎉</p>
<p>我们来看看<code>gcwaiting</code>是不是等于1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> go build hang2.go</div><div class="line"></div><div class="line"><span class="meta">$</span> GODEBUG="schedtrace=300,scheddetail=1" ./hang2</div><div class="line"></div><div class="line">SCHED 2443ms: gomaxprocs=4 idleprocs=3 threads=7 spinningthreads=0 idlethreads=2 runqueue=0 gcwaiting=0 nmidlelocked=0 stopwait=0 sysmonwait=0</div><div class="line">  P0: status=1 schedtick=4 syscalltick=5 m=5 runqsize=0 gfreecnt=1</div><div class="line">  P1: status=0 schedtick=14 syscalltick=0 m=-1 runqsize=0 gfreecnt=0</div><div class="line">  P2: status=0 schedtick=3 syscalltick=4 m=-1 runqsize=0 gfreecnt=0</div><div class="line">......  </div><div class="line">SCHED 2751ms: gomaxprocs=4 idleprocs=0 threads=7 spinningthreads=0 idlethreads=2 runqueue=0 gcwaiting=1 nmidlelocked=0 stopwait=1 sysmonwait=0</div><div class="line">  P0: status=1 schedtick=4 syscalltick=5 m=5 runqsize=0 gfreecnt=1</div><div class="line">  P1: status=3 schedtick=14 syscalltick=0 m=-1 runqsize=0 gfreecnt=0</div><div class="line">  P2: status=3 schedtick=3 syscalltick=10 m=-1 runqsize=0 gfreecnt=0</div><div class="line">  P3: status=3 schedtick=1 syscalltick=26 m=0 runqsize=0 gfreecnt=0</div><div class="line">  M6: p=-1 curg=-1 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 helpgc=0 spinning=false blocked=false lockedg=-1</div><div class="line">  M5: p=0 curg=19 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 helpg</div></pre></td></tr></table></figure>
<p>代码诚不欺我也！</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a></li>
<li><a href="http://tonybai.com/2017/11/23/the-simple-analysis-of-goroutine-schedule-examples/" target="_blank" rel="external">Goroutine调度实例简要分析</a></li>
<li><a href="http://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/" target="_blank" rel="external">也谈goroutine调度器</a></li>
<li><a href="https://studygolang.com/articles/9004" target="_blank" rel="external">golang的垃圾回收（GC）机制</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/27/hystrix-go简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/27/hystrix-go简介/" itemprop="url">hystrix-go简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-27T17:45:44+08:00">
                2017-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/afex/hystrix-go" target="_blank" rel="external">hystrix</a>是一个容错库，旨在隔离指向远程系统，服务和第三方库的请求，杜绝级联故障，并在复杂的分布式系统中实现弹性，毕竟在分布式系统中，故障是不可避免的。</p>
<p>此项目脱胎于由Netflix开源的同名java项目。<a href="https://github.com/Netflix/Hystrix" target="_blank" rel="external">https://github.com/Netflix/Hystrix</a></p>
<h3 id="像Hystrix命令一样执行代码"><a href="#像Hystrix命令一样执行代码" class="headerlink" title="像Hystrix命令一样执行代码"></a>像Hystrix命令一样执行代码</h3><p>定义依赖于外部系统的应用逻辑，将函数传给<code>Go</code>。当外部系统处于健康状态，这个函数将是唯一被执行的代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hystrix.Go(<span class="string">"my_command"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// talk to other services</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;, <span class="literal">nil</span>)</div></pre></td></tr></table></figure>
<h3 id="定义fallback行为"><a href="#定义fallback行为" class="headerlink" title="定义fallback行为"></a>定义fallback行为</h3><p>如果希望外部系统挂了的时候执行一些动作，可以给<code>Go</code>传递第二个函数。理想情况下，这里的逻辑可以让你的应用优雅地处理外部系统不可用的情况。</p>
<p>当第一个函数返回error，或者在一系列健康检查的情况下函数无法运行结束，都会触发fallback。更详细的<a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works" target="_blank" rel="external">参考在这里</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">hystrix.Go(<span class="string">"my_command"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// talk to other services</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;, <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// do this when services are down</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="等待输出"><a href="#等待输出" class="headerlink" title="等待输出"></a>等待输出</h3><p>调用<code>Go</code>就像执行了一个goroutine，除了你能获取到一个error的channel并且监控它。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">output := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line">errors := hystrix.Go(<span class="string">"my_command"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// talk to other services</span></div><div class="line">	output &lt;- <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;, <span class="literal">nil</span>)</div><div class="line"></div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line"><span class="keyword">case</span> out := &lt;-output:</div><div class="line">	<span class="comment">// success</span></div><div class="line"><span class="keyword">case</span> err := &lt;-errors:</div><div class="line">	<span class="comment">// failure</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="同步API"><a href="#同步API" class="headerlink" title="同步API"></a>同步API</h3><p>调用一个借口并且等待返回是一个常见的场景（对应于goroutine），Hystrix提供了一个<code>Do</code>函数，返回一个error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">err := hystrix.Do(&quot;my_command&quot;, func() error &#123;</div><div class="line">	// talk to other services</div><div class="line">	return nil</div><div class="line">&#125;, nil)</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在应用启动期间，你可以调用<code>ConfigureCommand</code>来为每个command添加配置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">hystrix.ConfigureCommand(<span class="string">"my_command"</span>, hystrix.CommandConfig&#123;</div><div class="line">	Timeout:               <span class="number">1000</span>,</div><div class="line">	MaxConcurrentRequests: <span class="number">100</span>,</div><div class="line">	ErrorPercentThreshold: <span class="number">25</span>,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>也有别的配置方法，更详细的介绍请参考官方文档。</p>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>最后给大家举个例子</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"github.com/afex/hystrix-go/hystrix"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	hystrix.Go(<span class="string">"get_baidu"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="comment">// talk to other services</span></div><div class="line">		_, err := http.Get(<span class="string">"https://www.baidu.com/"</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Println(<span class="string">"get error"</span>)</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;, <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"get an error, handle it"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line"> </div><div class="line">	time.Sleep(<span class="number">2</span> * time.Second)  <span class="comment">// 调用Go方法就是起了一个goroutine，这里要sleep一下，不然看不到效果</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>网络请求，大家把网络断开后就能够模拟外部服务挂掉的情况。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>熔断机制在分布式系统中几乎是必备的组件，下面总结一下：</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ol>
<li><p>hystrix作用在客户端，客户端程序依赖hystrix相关的第三方包，使得客户端与所依赖的服务，形成隔离(goroutine的隔离)。依赖服务的延迟与失败变的可控。保护调用者goroutine的执行。</p>
</li>
<li><p>避免了分布式系统中，单个组件的失败导致的级联影响。</p>
</li>
<li><p>快速失败，迅速恢复。  hystrix有快速失败机制，单个组件服务失败率到一定程度后，再请求，会直接响应失败。再这之后，会有重试机制。减少系统在错误服务调用上的开销。</p>
</li>
<li><p>降级应用</p>
</li>
</ol>
<h4 id="hystrix的设计原则"><a href="#hystrix的设计原则" class="headerlink" title="hystrix的设计原则"></a>hystrix的设计原则</h4><ol>
<li><p>防止任何单个依赖服务耗尽所有用户线程</p>
</li>
<li><p>直接响应失败，而不是一直等待</p>
</li>
<li><p>提供错误返回接口，而不是让用户线程直接处理依赖服务抛出的异常</p>
</li>
<li><p>使用隔离或熔断技术来降低并限制单个依赖对整个系统造成的影响</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/15/golang数据库相关的几个package的关系/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/15/golang数据库相关的几个package的关系/" itemprop="url">golang数据库相关的几个package的关系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-15T19:45:04+08:00">
                2017-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>挑orm的过程中不知不觉被搞晕了，怎么那么多相关的package，下面我们来理一理这些package的关系</p>
<ul>
<li>database/sql</li>
<li><a href="https://github.com/go-sql-driver/mysql/" target="_blank" rel="external">https://github.com/go-sql-driver/mysql/</a></li>
<li><a href="https://github.com/jmoiron/sqlx" target="_blank" rel="external">https://github.com/jmoiron/sqlx</a></li>
</ul>
<h3 id="database-sql"><a href="#database-sql" class="headerlink" title="database/sql"></a>database/sql</h3><p><code>database/sql</code>是go的一个标准库，提供了一些sql数据库的通用接口。它需要和数据库驱动一起使用，<a href="https://github.com/golang/go/wiki/SQLDrivers" target="_blank" rel="external">这里</a>是一个数据库驱动的列表。</p>
<p>对于mysql而言，我们最常用的是<a href="https://github.com/go-sql-driver/mysql/" target="_blank" rel="external">https://github.com/go-sql-driver/mysql/</a></p>
<h3 id="driver数据库驱动"><a href="#driver数据库驱动" class="headerlink" title="driver数据库驱动"></a>driver数据库驱动</h3><p>数据库驱动具体是什么呢？</p>
<p>每一个数据库都有一套客户端-服务端的通信协议。作为客户端，如果要从数据库中查询/插入数据，就要遵循这套协议，按照协议格式发送请求。显然，让每个用户实现协议非常浪费而不切实际。所以数据库作者提供了一个软件（或者说package），这个软件实现了协议，并且暴露出了一些API接口供客户端与数据库交互，这个软件就是数据库驱动。</p>
<p>驱动有标准，比如ODBC和JDBC，符合标准的驱动会实现一套相同的API接口，这样即使更换了数据库，客户端也不需要变更。</p>
<p>另外显而易见的是，驱动是语言相关的，不同的编程语言操作数据库需要对应语言实现的数据库驱动。所以驱动主要就是实现了与数据库交互的协议，当我们使用时，一般会这么写：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">        <span class="string">"database/sql"</span></div><div class="line"></div><div class="line">        _ <span class="string">"github.com/go-sql-driver/mysql"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">// mysql是驱动的名字</span></div><div class="line">        db, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"username:passwd@/test?charset=utf8"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> (</div><div class="line">		  _ <span class="string">"github.com/go-sql-driver/mysql"</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>会执行init函数，将mysql驱动注册到<code>database/sql</code>中的<code>drivers</code>中去，drivers是一个map：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">drivers = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]driver.Driver)</div></pre></td></tr></table></figure>
<p>显然，我们可以注册多个驱动，如果我们后端使用了不同的数据库的话，比如同时使用了<code>mysql</code>和<code>postgresql</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">        <span class="string">"database/sql"</span></div><div class="line"></div><div class="line">        _ <span class="string">"github.com/go-sql-driver/mysql"</span></div><div class="line">        _ <span class="string">"github.com/lib/pq"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">// mysql和postgres是驱动的名字</span></div><div class="line">        my_db, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"username:passwd@/test?charset=utf8"</span>)</div><div class="line">        postgre_db, err := sql.Open(<span class="string">"postgres"</span>, <span class="string">"username:passwd@/test?charset=utf8"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="sqlx"><a href="#sqlx" class="headerlink" title="sqlx"></a>sqlx</h3><p>sql是标准库<code>database/sql</code>的一个扩展，提供了一些更友好的接口，但是并没有过度封装，很多人放弃使用各种orm转而使用了<code>sqlx</code>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/lufei.jpeg"
               alt="You Wangqiu" />
          <p class="site-author-name" itemprop="name">You Wangqiu</p>
           
              <p class="site-description motion-element" itemprop="description">世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">170</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/michaelyou" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/zhi-yu-65-2" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      知乎
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="michaelseu2011@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">You Wangqiu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
