<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/img/lufei.ico?v=5.1.2" />






<meta name="description" content="世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也">
<meta property="og:type" content="website">
<meta property="og:title" content="Youmai の Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Youmai の Blog">
<meta property="og:description" content="世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Youmai の Blog">
<meta name="twitter:description" content="世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Youmai の Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-63551049-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Youmai の Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/06/go-pprof-采样何时进行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/06/go-pprof-采样何时进行/" itemprop="url">go pprof 采样何时进行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-06T15:20:36+08:00">
                2017-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> (</div><div class="line">	_ <span class="string">"net/http/pprof"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		log.Println(http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>))</div><div class="line">	&#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码大家应该都很熟悉，<code>go tool pprof</code>工具的通用代码，用来做性能等分析。我这两天尝试用了一下，不免有了一个疑问：<code>pprof</code>是要采样的，这个采样是何时进行的？是程序启动就开始采样还是当我<code>curl localhost:$PORT/debug/pprof/$PROFILE_TYPE</code>开始？</p>
<p>为什么会考虑这个呢，主要是在看的框架里集成了<code>pprof</code>，默认打开，如果是程序一开始就采样，那对于性能是有损耗的。这种问题别人回答你，你也不一定相信，我们还是来看看<code>pprof</code>的代码吧。</p>
<p>标准库的代码是在<code>$GOROOT/src</code>下面，我们找一下<code>pprof</code>，在我的mac上路径是<code>/usr/local/Cellar/go/1.9.2/libexec/src/net/http/pprof/pprof.go</code></p>
<p>首先是<code>init</code>函数，注册了我们用到的分析urls：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/"</span>, http.HandlerFunc(Index))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/cmdline"</span>, http.HandlerFunc(Cmdline))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/profile"</span>, http.HandlerFunc(Profile))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/symbol"</span>, http.HandlerFunc(Symbol))</div><div class="line">    http.Handle(<span class="string">"/debug/pprof/trace"</span>, http.HandlerFunc(Trace))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是在程序启动就执行的，这也是我们感觉只要import就万事大吉的原因。其实看到这里应该就明白了，profile只是普通的函数调用而已，程序启动只是注册了handler，真正的采样应该是在请求之后执行的。</p>
<p>但是来都来了，我们不妨往下看看，毕竟需要看标准库的机会不多。我们来看一下<code>cpu profile</code>，也就是<code>Profile</code>函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Profile responds with the pprof-formatted cpu profile.</span></div><div class="line"><span class="comment">// The package initialization registers it as /debug/pprof/profile.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Profile</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">    sec, _ := strconv.ParseInt(r.FormValue(<span class="string">"seconds"</span>), <span class="number">10</span>, <span class="number">64</span>)</div><div class="line">    <span class="keyword">if</span> sec == <span class="number">0</span> &#123;</div><div class="line">        sec = <span class="number">30</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> durationExceedsWriteTimeout(r, <span class="keyword">float64</span>(sec)) &#123;</div><div class="line">        w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain; charset=utf-8"</span>)</div><div class="line">        w.Header().Set(<span class="string">"X-Go-Pprof"</span>, <span class="string">"1"</span>)</div><div class="line">        w.WriteHeader(http.StatusBadRequest)</div><div class="line">        fmt.Fprintln(w, <span class="string">"profile duration exceeds server's WriteTimeout"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Set Content Type assuming StartCPUProfile will work,</span></div><div class="line">    <span class="comment">// because if it does it starts writing.</span></div><div class="line">    w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/octet-stream"</span>)</div><div class="line">    <span class="keyword">if</span> err := pprof.StartCPUProfile(w); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="comment">// StartCPUProfile failed, so no writes yet.</span></div><div class="line">        <span class="comment">// Can change header back to text content</span></div><div class="line">        <span class="comment">// and send error code.</span></div><div class="line">        w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain; charset=utf-8"</span>)</div><div class="line">        w.Header().Set(<span class="string">"X-Go-Pprof"</span>, <span class="string">"1"</span>)</div><div class="line">        w.WriteHeader(http.StatusInternalServerError)</div><div class="line">        fmt.Fprintf(w, <span class="string">"Could not enable CPU profiling: %s\n"</span>, err)</div><div class="line">                <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    sleep(w, time.Duration(sec)*time.Second)</div><div class="line">    pprof.StopCPUProfile()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取了一个默认30秒的时间，执行<code>StartCPUProfile</code>，里面应该是个<code>goroutine</code>，调用返回后sleep了一下，结束<code>cpu profile</code>。采样应该是在<code>StartCPUProfile</code>，执行seconds时间。</p>
<p>再来看看<code>StartCPUProfile</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartCPUProfile</span><span class="params">(w io.Writer)</span> <span class="title">error</span></span> &#123;</div><div class="line">    <span class="comment">// The runtime routines allow a variable profiling rate,</span></div><div class="line">    <span class="comment">// but in practice operating systems cannot trigger signals</span></div><div class="line">    <span class="comment">// at more than about 500 Hz, and our processing of the</span></div><div class="line">    <span class="comment">// signal is not cheap (mostly getting the stack trace).</span></div><div class="line">    <span class="comment">// 100 Hz is a reasonable choice: it is frequent enough to</span></div><div class="line">    <span class="comment">// produce useful data, rare enough not to bog down the</span></div><div class="line">    <span class="comment">// system, and a nice round number to make it easy to</span></div><div class="line">    <span class="comment">// convert sample counts to seconds. Instead of requiring</span></div><div class="line">    <span class="comment">// each client to specify the frequency, we hard code it.</span></div><div class="line">    <span class="keyword">const</span> hz = <span class="number">100</span></div><div class="line"></div><div class="line">    cpu.Lock()</div><div class="line">    <span class="keyword">defer</span> cpu.Unlock()</div><div class="line">    <span class="keyword">if</span> cpu.done == <span class="literal">nil</span> &#123;</div><div class="line">        cpu.done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Double-check.</span></div><div class="line">    <span class="keyword">if</span> cpu.profiling &#123;</div><div class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"cpu profiling already in use"</span>)</div><div class="line">    &#125;</div><div class="line">    cpu.profiling = <span class="literal">true</span></div><div class="line">    runtime.SetCPUProfileRate(hz)</div><div class="line">    <span class="keyword">go</span> profileWriter(w)</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注释解释了取样频率的由来，我们先看一下CPU主频的概念：</p>
<blockquote>
<p>CPU的主频，即CPU内核工作的时钟频率（CPU Clock Speed）。CPU的主频的基本单位是赫兹（Hz），但更多的是以兆赫兹（MHz）或吉赫兹（GHz）为单位。时钟频率的倒数即为时钟周期。时钟周期的基本单位为秒（s），但更多的是以毫秒（ms）、微妙（us）或纳秒（ns）为单位。在一个时钟周期内，CPU执行一条运算指令。也就是说，在1000 Hz的CPU主频下，每1毫秒可以执行一条CPU运算指令。在1 MHz的CPU主频下，每1微妙可以执行一条CPU运算指令。而在1 GHz的CPU主频下，每1纳秒可以执行一条CPU运算指令。</p>
</blockquote>
<p>在默认情况下，Go语言的运行时系统会以100 Hz的的频率对CPU使用情况进行取样。也就是说每秒取样100次，即每10毫秒会取样一次。为什么使用这个频率呢？因为100 Hz既足够产生有用的数据，又不至于让系统产生停顿。并且100这个数上也很容易做换算，比如把总取样计数换算为每秒的取样数。实际上，这里所说的对CPU使用情况的取样就是对当前的Goroutine的堆栈上的程序计数器的取样。由此，我们就可以从样本记录中分析出哪些代码是计算时间最长或者说最耗CPU资源的部分了。</p>
<p>代码很容易理解，锁住cpu，设置runtime的采样频率，<code>profileWriter</code>就是实际采样了。</p>
<p>所以结论是，采样在请求之后才会进行，线上打开采样的接口没有问题。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="external">Profiling Go Programs</a></li>
<li><a href="https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/" target="_blank" rel="external">Profiling Go programs with pprof</a></li>
<li><a href="http://wiki.jikexueyuan.com/project/go-command-tutorial/0.12.html" target="_blank" rel="external">go tool pprof</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/05/go语言死循环分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/05/go语言死循环分析/" itemprop="url">go语言死循环分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-05T12:18:55+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近看了一篇文章，<a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a>，里面有这样一段代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"io"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(runtime.NumCPU())</div><div class="line">    <span class="keyword">go</span> server()</div><div class="line">    <span class="keyword">go</span> printNum()</div><div class="line">    <span class="keyword">var</span> i = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="comment">// will block here, and never go out</span></div><div class="line">        i++</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"for loop end"</span>)</div><div class="line">    time.Sleep(time.Second * <span class="number">3600</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printNum</span><span class="params">()</span></span> &#123;</div><div class="line">    i := <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(i)</div><div class="line">        i++</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"hello world"</span>)</div><div class="line">    io.WriteString(w, <span class="string">"hello, world!\n"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">()</span></span> &#123;</div><div class="line">    http.HandleFunc(<span class="string">"/"</span>, HelloServer)</div><div class="line">    err := http.ListenAndServe(<span class="string">":12345"</span>, <span class="literal">nil</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"ListenAndServe: "</span>, err)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行，会发现打印一会儿数字后停了，我们执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl localhost:12345</div></pre></td></tr></table></figure>
<p>程序卡死。关于程序挂在哪里借助<code>dlv</code>是很好定位的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dlv debug hang.go</div></pre></td></tr></table></figure>
<p>进去之后运行程序，打印停止进入卡死状态，我们执行<code>ctrl C</code>，<code>dlv</code>会显示断开的地方：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">received SIGINT, stopping process (will not forward signal)&gt; main.main() ./hang.<span class="keyword">go</span>:<span class="number">17</span> (PC: <span class="number">0x12dd</span>7c8)</div><div class="line">    <span class="number">12</span>: <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="number">13</span>:         runtime.GOMAXPROCS(runtime.NumCPU())</div><div class="line">    <span class="number">14</span>:         <span class="keyword">go</span> server()</div><div class="line">    <span class="number">15</span>:         <span class="keyword">go</span> printNum()</div><div class="line">    <span class="number">16</span>:         <span class="keyword">var</span> i = <span class="number">1</span></div><div class="line">=&gt;  <span class="number">17</span>:         <span class="keyword">for</span> &#123;</div><div class="line">    <span class="number">18</span>:                 <span class="comment">// will block here, and never go out</span></div><div class="line">    <span class="number">19</span>:                 i++</div><div class="line">    <span class="number">20</span>:         &#125;</div><div class="line">    <span class="number">21</span>:         fmt.Println(<span class="string">"for loop end"</span>)</div><div class="line">    <span class="number">22</span>:         time.Sleep(time.Second * <span class="number">3600</span>)</div><div class="line">(dlv)</div></pre></td></tr></table></figure>
<p>但是我还是不明白，不明白的地方主要是因为：</p>
<ul>
<li>我又看了两篇文章<a href="http://tonybai.com/2017/11/23/the-simple-analysis-of-goroutine-schedule-examples/" target="_blank" rel="external">Goroutine调度实例简要分析</a>和<a href="http://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/" target="_blank" rel="external">也谈goroutine调度器</a>，是同一位作者Tony Bai写的，写得非常好。第二篇文章解释了goroutine的调度和cpu数量的关系（不多加解释，建议大家看看），我的mac是双核四线程（这里不明白的同学自行google cpu 超线程），go版本是1.9，理论上讲可以跑4个goroutine而不用考虑死循环，一个死循环最多把一个cpu打死，上面的代码中只有3个goroutine，而且他们看上去都挂住了。</li>
<li>上面说的理论上讲，不是我主观臆测的，我跑了<code>1</code>中<a href="http://tonybai.com/2017/11/23/the-simple-analysis-of-goroutine-schedule-examples/" target="_blank" rel="external">第一篇文章</a>中的一个例子:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">deadloop</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> deadloop()</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        time.Sleep(time.Second * <span class="number">1</span>)</div><div class="line">        fmt.Println(<span class="string">"I got scheduled!"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码有两个goroutine，一个是<code>main goroutine</code>，一个是<code>deadloop goroutine</code>，跑得时候<code>deadloop gouroutine</code>不会对<code>main goroutine</code>造成影响，打印一直在持续，作者的文章解释了原因。</p>
<ul>
<li><a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a>这篇文章提到了<code>gcwaiting</code>，然而没有解释。</li>
</ul>
<p>在<a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a>有这样一段话：</p>
<blockquote>
<p>因为在 for 循环中没有函数调用的话，编译器不会插入调度代码，所以这个执行 for 循环的 goroutine 没有办法被调出，而在循环期间碰到 gc，那么就会卡在 gcwaiting 阶段，并且整个进程永远 hang 死在这个循环上。并不再对外响应。</p>
</blockquote>
<p>这个其实就是我们的第一段代码卡死的原因，也是我们第二段代码没有卡死的原因，就是在<code>gc</code>上！</p>
<p>我们再看一篇文章，<a href="https://studygolang.com/articles/9004" target="_blank" rel="external">golang的垃圾回收（GC）机制</a>，这篇文章很短，但每句话都很重要：</p>
<blockquote>
<ol>
<li>设置gcwaiting=1，这个在每一个G任务之前会检查一次这个状态，如是，则会将当前M 休眠；</li>
<li>如果这个M里面正在运行一个长时间的G任务，咋办呢，难道会等待这个G任务自己切换吗？这样的话可要等10ms啊，不能等！坚决不能等！<br>所以会主动发出抢占标记（类似于上一篇），让当前G任务中断，再运行下一个G任务的时候，就会走到第1步</li>
</ol>
</blockquote>
<p>那么如果这时候运行的是没有函数调用的死循环呢，gc也发出了抢占标记，但是如果死循环没有函数调用，就没有地方被标记，无法被抢占，那就只能设置<code>gcwaiting=1</code>，而<strong>M没有休眠</strong>，<code>stop the world</code>卡住了（死锁），<code>gcwaiting</code>一直是1，整个程序都卡住了！</p>
<p>这里其实已经解释了第一份代码的现象，第二份代码为什么没有hang住相信大家也能猜到了：代码里没有触发gc！我们来手动触发一下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    _ <span class="string">"net/http/pprof"</span></div><div class="line">    <span class="comment">// "runtime"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">deadloop</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>))</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">go</span> deadloop()</div><div class="line">    i := <span class="number">3</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        time.Sleep(time.Second * <span class="number">1</span>)</div><div class="line">        i--</div><div class="line">        fmt.Println(<span class="string">"I got scheduled!"</span>)</div><div class="line">        <span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">            runtime.GC()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会发现打印了3行之后，程序也卡死了，bingo🎉</p>
<p>我们来看看<code>gcwaiting</code>是不是等于1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> go build hang2.go</div><div class="line"></div><div class="line"><span class="meta">$</span> GODEBUG="schedtrace=300,scheddetail=1" ./hang2</div><div class="line"></div><div class="line">SCHED 2443ms: gomaxprocs=4 idleprocs=3 threads=7 spinningthreads=0 idlethreads=2 runqueue=0 gcwaiting=0 nmidlelocked=0 stopwait=0 sysmonwait=0</div><div class="line">  P0: status=1 schedtick=4 syscalltick=5 m=5 runqsize=0 gfreecnt=1</div><div class="line">  P1: status=0 schedtick=14 syscalltick=0 m=-1 runqsize=0 gfreecnt=0</div><div class="line">  P2: status=0 schedtick=3 syscalltick=4 m=-1 runqsize=0 gfreecnt=0</div><div class="line">......  </div><div class="line">SCHED 2751ms: gomaxprocs=4 idleprocs=0 threads=7 spinningthreads=0 idlethreads=2 runqueue=0 gcwaiting=1 nmidlelocked=0 stopwait=1 sysmonwait=0</div><div class="line">  P0: status=1 schedtick=4 syscalltick=5 m=5 runqsize=0 gfreecnt=1</div><div class="line">  P1: status=3 schedtick=14 syscalltick=0 m=-1 runqsize=0 gfreecnt=0</div><div class="line">  P2: status=3 schedtick=3 syscalltick=10 m=-1 runqsize=0 gfreecnt=0</div><div class="line">  P3: status=3 schedtick=1 syscalltick=26 m=0 runqsize=0 gfreecnt=0</div><div class="line">  M6: p=-1 curg=-1 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 helpgc=0 spinning=false blocked=false lockedg=-1</div><div class="line">  M5: p=0 curg=19 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 helpg</div></pre></td></tr></table></figure>
<p>代码诚不欺我也！</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://gocn.io/article/441" target="_blank" rel="external">如何定位 golang 进程 hang 死的 bug</a></li>
<li><a href="http://tonybai.com/2017/11/23/the-simple-analysis-of-goroutine-schedule-examples/" target="_blank" rel="external">Goroutine调度实例简要分析</a></li>
<li><a href="http://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/" target="_blank" rel="external">也谈goroutine调度器</a></li>
<li><a href="https://studygolang.com/articles/9004" target="_blank" rel="external">golang的垃圾回收（GC）机制</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/27/hystrix-go简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/27/hystrix-go简介/" itemprop="url">hystrix-go简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-27T17:45:44+08:00">
                2017-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/afex/hystrix-go" target="_blank" rel="external">hystrix</a>是一个容错库，旨在隔离指向远程系统，服务和第三方库的请求，杜绝级联故障，并在复杂的分布式系统中实现弹性，毕竟在分布式系统中，故障是不可避免的。</p>
<p>此项目脱胎于由Netflix开源的同名java项目。<a href="https://github.com/Netflix/Hystrix" target="_blank" rel="external">https://github.com/Netflix/Hystrix</a></p>
<h3 id="像Hystrix命令一样执行代码"><a href="#像Hystrix命令一样执行代码" class="headerlink" title="像Hystrix命令一样执行代码"></a>像Hystrix命令一样执行代码</h3><p>定义依赖于外部系统的应用逻辑，将函数传给<code>Go</code>。当外部系统处于健康状态，这个函数将是唯一被执行的代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hystrix.Go(<span class="string">"my_command"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// talk to other services</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;, <span class="literal">nil</span>)</div></pre></td></tr></table></figure>
<h3 id="定义fallback行为"><a href="#定义fallback行为" class="headerlink" title="定义fallback行为"></a>定义fallback行为</h3><p>如果希望外部系统挂了的时候执行一些动作，可以给<code>Go</code>传递第二个函数。理想情况下，这里的逻辑可以让你的应用优雅地处理外部系统不可用的情况。</p>
<p>当第一个函数返回error，或者在一系列健康检查的情况下函数无法运行结束，都会触发fallback。更详细的<a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works" target="_blank" rel="external">参考在这里</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">hystrix.Go(<span class="string">"my_command"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// talk to other services</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;, <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// do this when services are down</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="等待输出"><a href="#等待输出" class="headerlink" title="等待输出"></a>等待输出</h3><p>调用<code>Go</code>就像执行了一个goroutine，除了你能获取到一个error的channel并且监控它。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">output := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line">errors := hystrix.Go(<span class="string">"my_command"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="comment">// talk to other services</span></div><div class="line">	output &lt;- <span class="literal">true</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;, <span class="literal">nil</span>)</div><div class="line"></div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line"><span class="keyword">case</span> out := &lt;-output:</div><div class="line">	<span class="comment">// success</span></div><div class="line"><span class="keyword">case</span> err := &lt;-errors:</div><div class="line">	<span class="comment">// failure</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="同步API"><a href="#同步API" class="headerlink" title="同步API"></a>同步API</h3><p>调用一个借口并且等待返回是一个常见的场景（对应于goroutine），Hystrix提供了一个<code>Do</code>函数，返回一个error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">err := hystrix.Do(&quot;my_command&quot;, func() error &#123;</div><div class="line">	// talk to other services</div><div class="line">	return nil</div><div class="line">&#125;, nil)</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在应用启动期间，你可以调用<code>ConfigureCommand</code>来为每个command添加配置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">hystrix.ConfigureCommand(<span class="string">"my_command"</span>, hystrix.CommandConfig&#123;</div><div class="line">	Timeout:               <span class="number">1000</span>,</div><div class="line">	MaxConcurrentRequests: <span class="number">100</span>,</div><div class="line">	ErrorPercentThreshold: <span class="number">25</span>,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>也有别的配置方法，更详细的介绍请参考官方文档。</p>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>最后给大家举个例子</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"github.com/afex/hystrix-go/hystrix"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	hystrix.Go(<span class="string">"get_baidu"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">		<span class="comment">// talk to other services</span></div><div class="line">		_, err := http.Get(<span class="string">"https://www.baidu.com/"</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Println(<span class="string">"get error"</span>)</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;, <span class="function"><span class="keyword">func</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">		fmt.Println(<span class="string">"get an error, handle it"</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line"> </div><div class="line">	time.Sleep(<span class="number">2</span> * time.Second)  <span class="comment">// 调用Go方法就是起了一个goroutine，这里要sleep一下，不然看不到效果</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>网络请求，大家把网络断开后就能够模拟外部服务挂掉的情况。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>熔断机制在分布式系统中几乎是必备的组件，下面总结一下：</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ol>
<li><p>hystrix作用在客户端，客户端程序依赖hystrix相关的第三方包，使得客户端与所依赖的服务，形成隔离(goroutine的隔离)。依赖服务的延迟与失败变的可控。保护调用者goroutine的执行。</p>
</li>
<li><p>避免了分布式系统中，单个组件的失败导致的级联影响。</p>
</li>
<li><p>快速失败，迅速恢复。  hystrix有快速失败机制，单个组件服务失败率到一定程度后，再请求，会直接响应失败。再这之后，会有重试机制。减少系统在错误服务调用上的开销。</p>
</li>
<li><p>降级应用</p>
</li>
</ol>
<h4 id="hystrix的设计原则"><a href="#hystrix的设计原则" class="headerlink" title="hystrix的设计原则"></a>hystrix的设计原则</h4><ol>
<li><p>防止任何单个依赖服务耗尽所有用户线程</p>
</li>
<li><p>直接响应失败，而不是一直等待</p>
</li>
<li><p>提供错误返回接口，而不是让用户线程直接处理依赖服务抛出的异常</p>
</li>
<li><p>使用隔离或熔断技术来降低并限制单个依赖对整个系统造成的影响</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/03/go-scope/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/03/go-scope/" itemprop="url">go语言作用域踩坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-03T20:15:38+08:00">
                2017-11-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天饭饭给我出了个题目，下面这段代码为什么报错，怎么改？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> A <span class="keyword">struct</span> &#123;</div><div class="line">    s <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> a *A</div><div class="line"></div><div class="line">    <span class="keyword">if</span> check(a) &#123;</div><div class="line">        a, err := generate()</div><div class="line">        fmt.Println(a.s, err)</div><div class="line">    &#125;</div><div class="line">    fmt.Println(a.s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">generate</span><span class="params">()</span> <span class="params">(*A, error)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> &amp;A&#123;s: <span class="string">"b"</span>&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">check</span><span class="params">(a *A)</span> <span class="title">bool</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行一下，发现报错如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">panic: runtime error: invalid memory address or nil pointer dereference</div><div class="line">[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x1095520]</div><div class="line"></div><div class="line">goroutine 1 [running]:</div><div class="line">main.main()</div><div class="line">        /go_code/src/go_examples/go_scope.go:18 +0x280</div><div class="line">exit status 2</div></pre></td></tr></table></figure>
<p>18行，也就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fmt.Println(a.s)</div></pre></td></tr></table></figure>
<p>报错了，报错没法提供更多信息（go新手，老鸟可能能看出端倪），我们加一些打印</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> a *A</div><div class="line">    fmt.Printf(<span class="string">"%p\n"</span>, &amp;a)      <span class="comment">// 1</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> check(a) &#123;</div><div class="line">        a, err := generate()</div><div class="line">        fmt.Printf(<span class="string">"%p\n"</span>, &amp;a)  <span class="comment">// 2</span></div><div class="line">        fmt.Println(a.s, err)   <span class="comment">// 3</span></div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"%p\n"</span>, &amp;a)      <span class="comment">// 4</span></div><div class="line">    fmt.Println(a.s)            </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0xc42000c028   // 1</div><div class="line">0xc42000c038   // 2</div><div class="line">b &lt;nil&gt;        // 3</div><div class="line">0xc42000c028   // 4</div></pre></td></tr></table></figure>
<p>我们发现，2处的<code>a</code>竟然不是我们定义的（1处）<code>a</code>，发生了什么！</p>
<p>其实看到这里很多人可能都明白了，其实是<code>a, err := generate()</code>里面<code>:=</code>的问题，我们最初的设想是golang会定义新变量<code>err</code>，而<code>a</code>为初始定义的那个变量（1处）。但实际情况是，对于使用<code>:=</code>定义的变量，如果新变量与那个同名已定义变量 (这里就是1处的变量<code>a</code>)不在一个作用域中时，那么golang会重新定义这个变量，这就是导致这个问题的真凶。</p>
<p>怎么改呢，我们重写一下<code>main</code>函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> a *A</div><div class="line">    <span class="keyword">var</span> err error</div><div class="line"></div><div class="line">    <span class="keyword">if</span> check(a) &#123;</div><div class="line">        a, err = generate()</div><div class="line">        fmt.Println(a.s, err)</div><div class="line">    &#125;</div><div class="line">    fmt.Println(a.s)            </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如此即可~</p>
<p>这个坑真的非常容易踩，而且不太好发现，感谢饭饭🙏</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/17/Docker数据管理-Volume，-bind-mount和tmpfs-mount/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/17/Docker数据管理-Volume，-bind-mount和tmpfs-mount/" itemprop="url">Docker数据管理-Volume， bind mount和tmpfs mount</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-17T20:52:02+08:00">
                2017-09-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们可以将数据写到容器的可写入层，但是这种写入是有缺点的：</p>
<ul>
<li>当容器停止运行时，写入的数据会丢失。你也很难将这些数据从容器中取出来给另外的应用程序使用。</li>
<li>容器的可写入层与宿主机是紧密耦合的。这些写入的数据在可以轻易地被删掉。</li>
<li>写入容器的可写入层需要一个<a href="https://docs.docker.com/engine/userguide/storagedriver/" target="_blank" rel="external">存储驱动</a>（<code>storage driver</code>）来管理文件系统。这个存储驱动通过linux内核提供了一个<code>union filesystem</code>。相比于数据卷（<code>data volume</code>），这种额外的抽象会降低性能。</li>
</ul>
<p>Docker提供了3种方法将数据从Docker宿主机挂载（mount）到容器：<code>volumes</code>，<code>bind mounts</code>和<code>tmpfs mounts</code>。一般来说，<code>volumes</code>总是最好的选择。</p>
<p>##选择合适的挂载方式</p>
<p>不管你选择哪种挂载方式，从容器中看都是一样的。数据在容器的文件系统中被展示为一个目录或者一个单独的文件。</p>
<p>一个简单区分<code>volumes</code>，<code>bind mounts</code>和<code>tmpfs mounts</code>不同点的方法是：思考数据在宿主机上是如何存在的。</p>
<p><img src="/img/types-of-mounts.png" alt="different mount"></p>
<ul>
<li><strong>Volumes</strong>由Docker管理，存储在宿主机的某个地方（在linux上是<code>/var/lib/docker/volumes/</code>）。非Docker应用程序不能改动这一位置的数据。Volumes是Docker最好的数据持久化方法。</li>
<li><strong>Bind mounts</strong>的数据可以存放在宿主机的任何地方。数据甚至可以是重要的系统文件或目录。非Docker应用程序可以改变这些数据。</li>
<li><strong>tmpfs mounts</strong>的数据只存储在宿主机的内存中，不会写入到宿主机的文件系统。</li>
</ul>
<h2 id="更详细的Diff"><a href="#更详细的Diff" class="headerlink" title="更详细的Diff"></a>更详细的Diff</h2><ul>
<li><p><strong>Volumes</strong>：由Docker创建和管理。你可以通过<code>docker volume create</code>命令显式地创建<code>volume</code>，Docker也可以在创建容器或服务是自己创建volume。</p>
<p>当你创建了一个volume，它会被存放在宿主机的一个目录下。当你将这个volume挂载到某个容器时，这个目录就是挂载到容器的东西。这一点和<code>bind mounts</code>类似，除了volumes是由Docker创建的，和宿主机的核心（<code>core functionality</code>）隔离。</p>
<p>一个volume可以同时被挂载到几个容器中。即使没有正在运行的容器使用这个volume，volume依然存在，不会被自动清除。可以通过<code>docker volume prune</code>清除不再使用的volumes。</p>
<p>volumes也支持<code>volume driver</code>，可以将数据存放在另外的机器或者云上。</p>
</li>
<li><p><strong>Bind mounts</strong>：Docker早期就支持这个特性。与volumes相比，<code>Bind mounts</code>支持的功能有限。使用<code>bind mounts</code>时，宿主机上的一个文件或目录被挂载到容器上。</p>
<blockquote>
<p>警告：使用<code>Bind mounts</code>的一个副作用是，容器中运行的程序可以修改宿主机的文件系统，包括创建，修改，删除重要的系统文件或目录。这个功能可能会有安全问题。</p>
</blockquote>
</li>
<li><p><strong>tmpfs mounts</strong>：<code>tmpfs mounts</code>的数据不会落盘。在容器的生命周期内，它可以被用来存储一些不需要持久化的状态或敏感数据。例如，<code>swarm</code>服务通过<code>tmpfs mounts</code>来将<a href="https://docs.docker.com/engine/swarm/secrets/" target="_blank" rel="external">secrets</a>挂载到一个服务的容器中去。</p>
</li>
</ul>
<h2 id="适合Volumes的场景"><a href="#适合Volumes的场景" class="headerlink" title="适合Volumes的场景"></a>适合Volumes的场景</h2><ul>
<li>在不同的容器中共享数据。If you don’t explicitly create it, a volume is created the first time it is mounted into a container. When that container stops or is removed, the volume still exists. Multiple containers can mount the same volume simultaneously, either read-write or read-only. <strong>Volumes are only removed when you explicitly remove them</strong>.</li>
<li>When the Docker host is not guaranteed to have a given directory or file structure. Volumes help you decouple the configuration of the Docker host from the container runtime.</li>
<li>When you want to store your container’s data on a remote host or a cloud provider, rather than locally.</li>
<li>当你需要备份或迁移数据的时候，When you need to be able to back up, restore, or migrate data from one Docker host to another, volumes are a better choice. You can stop containers using the volume, then back up the volume’s directory (such as /var/lib/docker/volumes/<volume-name>).</volume-name></li>
</ul>
<h2 id="适合bind-mounts的场景"><a href="#适合bind-mounts的场景" class="headerlink" title="适合bind mounts的场景"></a>适合bind mounts的场景</h2><ul>
<li>宿主机和容器共享配置文件。Docker提供的DNS解决方案就是如此，将宿主机的<code>/etc/resolv.conf</code>挂载到每个容器中。</li>
<li>开发环境需要在宿主机和容器中共享代码。docker的开发就是如此，毕竟容器中一般是没有编辑器的</li>
<li>When the file or directory structure of the Docker host is guaranteed to be consistent with the bind mounts the containers require.</li>
</ul>
<h2 id="适合tmpfs-mounts的场景"><a href="#适合tmpfs-mounts的场景" class="headerlink" title="适合tmpfs mounts的场景"></a>适合tmpfs mounts的场景</h2><p><code>tmpfs mounts</code>主要用在你既不想在容器内，又不想在宿主机文件系统保存数据的时候。这可能是出于安全原因，也可能是你的应用需要写非常多的非持久化数据，<code>tmpfs mounts</code>这时候可以保证容器性能。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/16/docker-swarm部署应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/16/docker-swarm部署应用/" itemprop="url">docker swarm部署应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-16T21:42:58+08:00">
                2017-09-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><h3 id="什么是swarm"><a href="#什么是swarm" class="headerlink" title="什么是swarm"></a>什么是swarm</h3><p>一个<code>swarm</code>就是一组运行<code>Docker</code>并组成集群的机器。之后，你继续运行以前使用的<code>Docker命令</code>，但现在它们是由<code>swarm manager</code>(也是一台机器，执行<code>docker swarm init</code>的就是<code>manager</code>)在集群上执行。集群中的机器可以是物理机或虚拟机。加入集群后，它们被称为<code>节点</code>（node）。</p>
<p><code>swarm manager</code>可以使用几种策略来运行容器，例如“最空的节点”（<code>empties node</code>） - 将容器放到利用率最低的机器上。或者“全局”（<code>global</code>）模式，它确保每台机器只能获得指定容器的一个实例。你通过在<code>compose文件</code>来指示<code>swarm manager</code>使用这些策略。</p>
<p><code>swarm manager</code>是集群中唯一可以执行命令的机器，也是唯一可以授权其他机器作为<code>worker</code>加入集群的机器。<code>worker</code>只提供<code>capacity</code>，它无法告诉任何其他机器它可以做什么和不能做什么。</p>
<h3 id="什么是slack"><a href="#什么是slack" class="headerlink" title="什么是slack"></a>什么是slack</h3><p><code>stack</code>是一组相互关联的服务，可以被一起编排。<code>单个stack</code>能够定义整个应用程序的功能（尽管非常复杂的应用程序可能希望使用多个stack）。</p>
<h2 id="Set-up-your-swarm"><a href="#Set-up-your-swarm" class="headerlink" title="Set up your swarm"></a>Set up your swarm</h2><p>一个<code>swarm</code>由很多<code>node</code>组成，<code>node</code>可以是物理机或虚拟机。基本概念很简单：运行<code>docker swarm init</code>启用集群模式，使当前的机器成为<code>manager</code>，然后在其他机器上运行<code>docker swarm join</code>，使他们以<code>worker</code>身份加入集群。</p>
<h3 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h3><p>我们可以在本机创建几台虚拟机来创建我们的集群（需要安装<a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="external">VirtualBox</a>）</p>
<p>首先，使用<code>docker-machine</code>命令，通过<code>VirtualBox</code>驱动创建两台虚拟机，<code>myvm1</code>和<code>myvm2</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> docker-machine create --driver virtualbox myvm1</div><div class="line"><span class="meta">$</span> docker-machine create --driver virtualbox myvm2</div></pre></td></tr></table></figure>
<p>我们将<code>myvm1</code>用作manager，它可以执行docker命令和授权别的worker加入swarm，<code>myvm2</code>将作为worker。</p>
<p>登录<code>docker-machine</code>创建的虚拟机可以使用<code>docker-machine ssh命令</code>,下面我们设置<code>myvm1</code>为manager：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">➜  docker-machine ls</div><div class="line">NAME    ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS</div><div class="line">myvm1   -        virtualbox   Running   tcp://192.168.99.101:2376           v17.06.2-ce</div><div class="line">myvm2   -        virtualbox   Running   tcp://192.168.99.102:2376           v17.06.2-ce</div><div class="line">➜  docker-machine ssh myvm1 "docker swarm init --advertise-addr 192.168.99.101:2377"</div><div class="line"></div><div class="line">Swarm initialized: current node (u5e02o4thu4uurxm9w71kxtu5) is now a manager.</div><div class="line"></div><div class="line">To add a worker to this swarm, run the following command:</div><div class="line"></div><div class="line">    docker swarm join --token SWMTKN-1-02sp63h6alkj7sd57dkv6omkyvkb60y05delt5zvkspe0293ao-dtmm6kqjzbbe33jmo03yrml8t 192.168.99.101:2377</div><div class="line"></div><div class="line">To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.</div></pre></td></tr></table></figure>
<p>可以看到，返回值中已经有了一个配置好的<code>docker swarm join</code>命令，复制这个命令，在myvm2上执行，使myvm2加入你的swarm作为worker：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  docker-machine ssh myvm2 "docker swarm join --token SWMTKN-1-02sp63h6alkj7sd57dkv6omkyvkb60y05delt5zvkspe0293ao-dtmm6kqjzbbe33jmo03yrml8t 192.168.99.101:2377"</div><div class="line">This node joined a swarm as a worker.</div></pre></td></tr></table></figure>
<p>🎉，我们的第一个<code>swarm</code>创建成功了。</p>
<p>我们可以登上<code>myvm1</code>去看看现在的节点情况：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">➜  docker-machine ssh myvm1</div><div class="line">                        ##         .</div><div class="line">                  ## ## ##        ==</div><div class="line">               ## ## ## ## ##    ===</div><div class="line">           /"""""""""""""""""\___/ ===</div><div class="line">      ~~~ &#123;~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~</div><div class="line">           \______ o           __/</div><div class="line">             \    \         __/</div><div class="line">              \____\_______/</div><div class="line"> _                 _   ____     _            _</div><div class="line">| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __</div><div class="line">| '_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ '__|</div><div class="line">| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   &lt;  __/ |</div><div class="line">|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|</div><div class="line">Boot2Docker version 17.06.2-ce, build HEAD : ff16afa - Wed Sep  6 00:17:25 UTC 2017</div><div class="line">Docker version 17.06.2-ce, build cec0b72</div><div class="line"></div><div class="line">docker@myvm1:~$ docker node ls</div><div class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS</div><div class="line">ggr9eji9z868qrorwerufrr45     myvm2               Ready               Active</div><div class="line">u5e02o4thu4uurxm9w71kxtu5 *   myvm1               Ready               Active              Leader</div></pre></td></tr></table></figure>
<p>一目了然，现在有两个node，myvm1是作为leader存在</p>
<h2 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h2><p>我们使用<a href="https://github.com/michaelyou/docker_swarm_deploy" target="_blank" rel="external">这个</a>简单的python应用来作为部署对象，你完全可以使用自己的应用程序(但还是建议用我使用的这个程序，这个应用打印了container的hostname，这是下面负载均衡的一个测试)。</p>
<p>首先将<code>docker-compose.yml</code>拷贝到<code>myvm1</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker-machine scp docker-compose.yml myvm1:~</div></pre></td></tr></table></figure>
<p>然后就是部署了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">docker-machine ssh myvm1 "docker stack deploy -c docker-compose.yml firstswarmapp"</div><div class="line"></div><div class="line">Creating service firstswarmapp_visualizer</div><div class="line">Creating service firstswarmapp_redis</div><div class="line">Creating service firstswarmapp_web</div></pre></td></tr></table></figure>
<p>这时候部署已经完成了，我们来看看成果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">➜  docker-machine ssh myvm1 "docker stack ls"</div><div class="line">NAME                SERVICES</div><div class="line">firstswarmapp       1</div><div class="line">➜  docker-machine ssh myvm1 "docker stack ps firstswarmapp"</div><div class="line">ID                  NAME                  IMAGE                         NODE                DESIRED STATE       CURRENT STATE                  ERROR               PORTS</div><div class="line">ID                  NAME                         IMAGE                             NODE                DESIRED STATE       CURRENT STATE                 ERROR                              PORTS</div><div class="line">6lfkdnzq27yf        firstswarmapp_redis.1        redis:latest                      myvm1               Running             Running 43 seconds ago</div><div class="line">ui2tdail0fxv        firstswarmapp_visualizer.1   dockersamples/visualizer:stable   myvm1               Running             Running 2 minutes ago</div><div class="line">901cprboy06k        firstswarmapp_web.1          michaelyou/friendlyhello:v1       myvm2               Running             Running 33 minutes ago</div><div class="line">uvju8t48sc2s        firstswarmapp_web.2          michaelyou/friendlyhello:v1       myvm2               Running             Running 33 minutes ago</div><div class="line">sk2z91e4yn9x        firstswarmapp_web.3          michaelyou/friendlyhello:v1       myvm1               Running             Running 34 minutes ago</div><div class="line">tuzdxnfyofyc        firstswarmapp_web.4          michaelyou/friendlyhello:v1       myvm2               Running             Running 33 minutes ago</div><div class="line">715at7211p8k        firstswarmapp_web.5          michaelyou/friendlyhello:v1       myvm1               Running             Running 34 minutes ago</div></pre></td></tr></table></figure>
<p>可以看到，我们一共有7个<code>container</code>。<code>web</code>5个，分布在两台机器上，<code>redis</code>和<code>visualizer</code>各一个，在<code>manager节点</code>上。这和我们在<code>docker-compose.yml</code>中定义的一样。</p>
<p><code>myvm1</code>和<code>myvm2</code>的地址都可以访问我们的应用。你创建的网络在它们之间是共享，并且负载平衡的。运行<code>docker-machine ls</code>来获取你的虚拟机的IP地址，并在浏览器上访问它们，并刷新。你会看到五个可能的容器ID，它们随机循环，显示了负载平衡的存在。</p>
<p>两个IP地址都能工作的原因是群集中的节点加入了一个入口路由网格（routing mesh）。这样可以确保在集群中某个端口部署的服务始终将该端口保留给其自己，无论实际运行容器的是哪个节点。以下是在一个三节点集群的8080端口上部署的名为my-web的服务的路由网格示意图：</p>
<p><img src="/img/ingress-routing-mesh.png" alt="ingress-routing-mesh"></p>
<p>如果想要增加容器个数，只要修改<code>docker-compose.yml</code>文件中的replicas的数量，然后重新执行deploy就可以了。</p>
<p>如果要加入新的node，只要在新的机器上执行我们在<code>myvm2</code>上执行的<code>docker swarm join</code>命令就可以了，加入新的节点后，重新执行deploy，我们就能用上新的机器了（注意要重新执行deploy，不会自动deploy，这一点和elasticsearch等软件不一样）。</p>
<p>因为我们部署了visualizer，可以通过网页来看看我们集群现在的情况：</p>
<p><img src="/img/my_swarm.png" alt="my swarm"></p>
<p>跟<code>docker stack ps</code>输出是一致的。</p>
<h2 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h2><p>清理stack</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker-machine ssh myvm1 "docker stack rm firstswarmapp"</div></pre></td></tr></table></figure>
<p>这时候swarm还是在的，清理swarm：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker-machine ssh myvm1 "docker swarm leave --force"</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/12/docker源码分析1-cli/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/12/docker源码分析1-cli/" itemprop="url">docker源码分析（一）-cli</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-12T20:41:10+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Docker代码更新很快，网上各位大神的源码解析很多已经是几年前的版本了。实现上有了很大改变，加之Docker项目更名为<a href="https://github.com/moby/moby" target="_blank" rel="external">moby</a>，其中很多组件又从moby中拆分了出来，一开始看简直是一脸懵逼啊。在这里跟大家分享了一下最近看的<a href="https://github.com/docker/cli" target="_blank" rel="external">docker/cli</a>的源码，抛砖引玉，欢迎大家批评指正。</p>
<p>分析的<code>docker client</code>版本是<code>17.06.2-ce</code>。</p>
<p><code>docker client</code>是Docker的客户端程序，也就是我们敲的<code>docker * *</code> 命令，我们通过他与<code>docker deamon</code>程序进行交互。可以将他看成一个普通的客户端程序，docker的核心<code>namespace</code>和<code>cgroup</code>等技术都不在这里。</p>
<h2 id="搭建docker-client开发环境"><a href="#搭建docker-client开发环境" class="headerlink" title="搭建docker-client开发环境"></a>搭建docker-client开发环境</h2><p><code>docker_client</code>的开发环境也是在容器中，项目已经给我们做好了封装，具体可以参考项目Readme的<a href="https://github.com/docker/cli#development" target="_blank" rel="external">Development</a>章节。</p>
<p>问几个问题，大家可以思考一下：</p>
<h4 id="1-开发是在容器中，可是容器里面连编辑器都没有，怎么开发？"><a href="#1-开发是在容器中，可是容器里面连编辑器都没有，怎么开发？" class="headerlink" title="1. 开发是在容器中，可是容器里面连编辑器都没有，怎么开发？"></a>1. 开发是在容器中，可是容器里面连编辑器都没有，怎么开发？</h4><p>答： 准确来说应该是在容器中调试，开发还是在本地开发，容器中看到的目录是我们本地目录mount进去的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> docker.Makefile文件</div><div class="line"></div><div class="line">......</div><div class="line">MOUNTS = -v "$(CURDIR)":/go/src/github.com/docker/cli</div><div class="line">......</div><div class="line"><span class="meta">#</span> start container in interactive mode for in-container development</div><div class="line">.PHONY: dev</div><div class="line">dev: build_docker_image</div><div class="line">    docker run -ti --security-opt=seccomp:unconfined $(ENVVARS) $(MOUNTS) \</div><div class="line">        -v /var/run/docker.sock:/var/run/docker.sock \</div><div class="line">        $(DEV_DOCKER_IMAGE_NAME) ash</div><div class="line"></div><div class="line">shell: dev</div><div class="line">......</div></pre></td></tr></table></figure>
<p>从shell里面还是很容器看出来的，run的时候mount了<code>$(CURDIR)</code></p>
<h4 id="2-容器里面是不是还装了一个docker啊，为什么我在里面敲命令有响应？"><a href="#2-容器里面是不是还装了一个docker啊，为什么我在里面敲命令有响应？" class="headerlink" title="2. 容器里面是不是还装了一个docker啊，为什么我在里面敲命令有响应？"></a>2. 容器里面是不是还装了一个docker啊，为什么我在里面敲命令有响应？</h4><p>答：不是的，里面只有你编译生成的docker client程序，是没有docker deamon程序，至于为什么能响应，还是看上面的shell脚本，<code>-v /var/run/docker.sock:/var/run/docker.sock</code>这一行将<code>docker.sock</code>文件也mount了进去，<code>docker.sock</code>是<code>docker deamon</code>默认监听的Unix套接字（Unix domain socket），容器中的进程可以通过他与docker deamon进行通信。所以这里docker client通信的是你本机的docker daemon。</p>
<p><img src="/img/docker_deamon_socket.png" alt="docker_deamon_socket"></p>
<blockquote>
<p>Note: 关于<code>/var/run/docker.sock</code>更多内容可以看<a href="https://medium.com/lucjuggery/about-var-run-docker-sock-3bfd276e12fd" target="_blank" rel="external">这里</a></p>
</blockquote>
<p>所以我们的开发流程是：本地改代码–&gt;到container中编译–&gt;运行docker client看效果</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>是时候表演真正的技术了！</p>
<p>😆，开个玩笑，下面的分析如果有问题，还请大家不吝赐教！</p>
<p>我尽量把文件路径列出来，会贴一些代码，但主要还是路径，建议大家把代码clone下来照着看。</p>
<p>docker—client是基于<a href="https://github.com/spf13/cobra" target="_blank" rel="external">cobra</a>写的，建议大家先看一下cobra，至少写个<code>hello world</code>熟悉一下基本用法。</p>
<p>我们开始了！</p>
<p>入口文件在<code>cmd/docker/docker.go</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 日志输出采用了第三方库logrus</span></div><div class="line">    <span class="comment">// Set terminal emulation based on platform as required.</span></div><div class="line">    stdin, stdout, stderr := term.StdStreams()</div><div class="line">    logrus.SetOutput(stderr)</div><div class="line"></div><div class="line">    dockerCli := command.NewDockerCli(stdin, stdout, stderr)</div><div class="line">    </div><div class="line">    <span class="comment">// root命令，子命令都在这里面，重点看</span></div><div class="line">    cmd := newDockerCommand(dockerCli)</div><div class="line"></div><div class="line">    <span class="comment">// 命令执行	</span></div><div class="line">    <span class="keyword">if</span> err := cmd.Execute(); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">if</span> sterr, ok := err.(cli.StatusError); ok &#123;</div><div class="line">            <span class="keyword">if</span> sterr.Status != <span class="string">""</span> &#123;</div><div class="line">                fmt.Fprintln(stderr, sterr.Status)</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// StatusError should only be used for errors, and all errors should</span></div><div class="line">            <span class="comment">// have a non-zero exit status, so never exit with 0</span></div><div class="line">            <span class="keyword">if</span> sterr.StatusCode == <span class="number">0</span> &#123;</div><div class="line">                os.Exit(<span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line">            os.Exit(sterr.StatusCode)</div><div class="line">        &#125;</div><div class="line">        fmt.Fprintln(stderr, err)</div><div class="line">        os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还是这个文件，<code>newDockerCommand</code>函数调用了<code>commands.AddCommands(cmd, dockerCli)</code>来添加命令。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newDockerCommand</span><span class="params">(dockerCli *command.DockerCli)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</div><div class="line">        opts := cliflags.NewClientOptions()</div><div class="line">        <span class="keyword">var</span> flags *pflag.FlagSet</div><div class="line"></div><div class="line">        cmd := &amp;cobra.Command&#123;</div><div class="line">                Use:              <span class="string">"docker [OPTIONS] COMMAND [ARG...]"</span>,</div><div class="line">                Short:            <span class="string">"A self-sufficient runtime for containers"</span>,</div><div class="line">                SilenceUsage:     <span class="literal">true</span>,</div><div class="line">                SilenceErrors:    <span class="literal">true</span>,</div><div class="line">                TraverseChildren: <span class="literal">true</span>,</div><div class="line">                Args:             noArgs,</div><div class="line">                RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">                        <span class="keyword">if</span> opts.Version &#123;</div><div class="line">                                showVersion()</div><div class="line">                                <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">return</span> command.ShowHelp(dockerCli.Err())(cmd, args)</div><div class="line">                &#125;,</div><div class="line">                PersistentPreRunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">                        <span class="comment">// daemon command is special, we redirect directly to another binary</span></div><div class="line">                        <span class="keyword">if</span> cmd.Name() == <span class="string">"daemon"</span> &#123;</div><div class="line">                                <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// flags must be the top-level command flags, not cmd.Flags()</span></div><div class="line">                        opts.Common.SetDefaultOptions(flags)</div><div class="line">                        dockerPreRun(opts)</div><div class="line">                        <span class="keyword">if</span> err := dockerCli.Initialize(opts); err != <span class="literal">nil</span> &#123;</div><div class="line">                                <span class="keyword">return</span> err</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">return</span> isSupported(cmd, dockerCli)</div><div class="line">                &#125;,</div><div class="line">        &#125;</div><div class="line">        cli.SetupRootCommand(cmd)</div><div class="line"></div><div class="line">        flags = cmd.Flags()</div><div class="line">        flags.BoolVarP(&amp;opts.Version, <span class="string">"version"</span>, <span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"Print version information and quit"</span>)</div><div class="line">        flags.StringVar(&amp;opts.ConfigDir, <span class="string">"config"</span>, cliconfig.Dir(), <span class="string">"Location of client config files"</span>)</div><div class="line">        opts.Common.InstallFlags(flags)</div><div class="line"></div><div class="line">        setFlagErrorFunc(dockerCli, cmd, flags, opts)</div><div class="line"></div><div class="line">        setHelpFunc(dockerCli, cmd, flags, opts)</div><div class="line"></div><div class="line">        cmd.SetOutput(dockerCli.Out())</div><div class="line">        cmd.AddCommand(newDaemonCommand())</div><div class="line">        # 添加子命令，cmd里现在是root命令</div><div class="line">        commands.AddCommands(cmd, dockerCli)</div><div class="line"></div><div class="line">        setValidateArgs(dockerCli, cmd, flags, opts)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> cmd</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这行上面的<code>cmd.AddCommand(newDaemonCommand())</code>是为<code>docker daemon</code>命令进行的输出，<code>newDaemonCommand</code>定义在<code>cmd/docker/daemon_none.go</code>中，从他的<code>RunE</code>方法可以看出来，是输出了不能运行的提示，<code>runtime.GOOS</code>是输出当前系统的名称，比如mac是<code>Darwin</code>， ubuntu是<code>linux</code>，完整看来就是:</p>
<pre><code>`docker daemon` is not supported on Darwin. Please run `dockerd` directly
</code></pre><p>让我们来到<code>commands.AddCommands</code>定义的地方，<code>cli/command/commands/commands.go</code>文件，可以看到<code>cmd.AddCommand</code>的调用，这里就是在添加我们看到的二级命令，也就是紧跟着<code>docker</code>后面的命令。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddCommands</span><span class="params">(cmd *cobra.Command, dockerCli *command.DockerCli)</span></span> &#123;</div><div class="line">        cmd.AddCommand(</div><div class="line">                ......</div><div class="line"></div><div class="line">                <span class="comment">// container</span></div><div class="line">                container.NewContainerCommand(dockerCli),</div><div class="line">                container.NewRunCommand(dockerCli),</div><div class="line">                </div><div class="line">                ......</div><div class="line">                hide(container.NewPsCommand(dockerCli)),</div><div class="line">                hide(container.NewRenameCommand(dockerCli)),</div><div class="line">                ......</div></pre></td></tr></table></figure>
<p>我们从上看到下，整齐划一中发现最后好多命令被用hide包裹了。这些命令是一些旧命令，在新的版本中可以使用新的命令来代替，如果设置了环境变量<code>DOCKER_HIDE_LEGACY_COMMANDS</code>不为空，那么docker的提示将不会输出这些。</p>
<p>这里的命令太多了，我们通过<code>docker ps</code>命令来了解一下大致的执行流程。</p>
<p><code>docker ps</code>命令也是旧版的命令，<code>hide(container.NewPsCommand(dockerCli))</code>就是在处理他。在新版本中对应的是<code>docker container ls</code>命令。实现代码在<code>cli/command/container/list.go</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewPsCommand creates a new cobra.Command for `docker ps`</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPsCommand</span><span class="params">(dockerCli *command.DockerCli)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</div><div class="line">        options := psOptions&#123;filter: opts.NewFilterOpt()&#125;</div><div class="line"></div><div class="line">        cmd := &amp;cobra.Command&#123;</div><div class="line">                Use:   <span class="string">"ps [OPTIONS]"</span>,</div><div class="line">                Short: <span class="string">"List containers"</span>,</div><div class="line">                Args:  cli.NoArgs,</div><div class="line">                RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">                        <span class="keyword">return</span> runPs(dockerCli, &amp;options)</div><div class="line">                &#125;,</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        flags := cmd.Flags()</div><div class="line"></div><div class="line">        flags.BoolVarP(&amp;options.quiet, <span class="string">"quiet"</span>, <span class="string">"q"</span>, <span class="literal">false</span>, <span class="string">"Only display numeric IDs"</span>)</div><div class="line">        flags.BoolVarP(&amp;options.size, <span class="string">"size"</span>, <span class="string">"s"</span>, <span class="literal">false</span>, <span class="string">"Display total file sizes"</span>)</div><div class="line">        flags.BoolVarP(&amp;options.all, <span class="string">"all"</span>, <span class="string">"a"</span>, <span class="literal">false</span>, <span class="string">"Show all containers (default shows just running)"</span>)</div><div class="line">        flags.BoolVar(&amp;options.noTrunc, <span class="string">"no-trunc"</span>, <span class="literal">false</span>, <span class="string">"Don't truncate output"</span>)</div><div class="line">        flags.BoolVarP(&amp;options.nLatest, <span class="string">"latest"</span>, <span class="string">"l"</span>, <span class="literal">false</span>, <span class="string">"Show the latest created container (includes all states)"</span>)</div><div class="line">        flags.IntVarP(&amp;options.last, <span class="string">"last"</span>, <span class="string">"n"</span>, <span class="number">-1</span>, <span class="string">"Show n last created containers (includes all states)"</span>)</div><div class="line">        flags.StringVarP(&amp;options.format, <span class="string">"format"</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="string">"Pretty-print containers using a Go template"</span>)</div><div class="line">        flags.VarP(&amp;options.filter, <span class="string">"filter"</span>, <span class="string">"f"</span>, <span class="string">"Filter output based on conditions provided"</span>)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> cmd</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newListCommand</span><span class="params">(dockerCli *command.DockerCli)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</div><div class="line">        cmd := *NewPsCommand(dockerCli)</div><div class="line">        cmd.Aliases = []<span class="keyword">string</span>&#123;<span class="string">"ps"</span>, <span class="string">"list"</span>&#125;</div><div class="line">        cmd.Use = <span class="string">"ls [OPTIONS]"</span></div><div class="line">        <span class="keyword">return</span> &amp;cmd</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>NewPsCommand</code>对应的是<code>docker ps</code>, <code>newListCommand</code>对应的是<code>docker container ls</code>，可以看出来， <code>newListCommand</code>里的command就是<code>NewPsCommand</code>返回的，只是加了一下说明而已。</p>
<blockquote>
<p>这里还漏了一点，docker container ls是3个命令，我们知道docker是root命令，按照cobra的写法，container和ls应该是分开的。他们的关系是这样的，在<code>cli/command/commands/commands.go</code>文件中<code>container.NewContainerCommand(dockerCli)</code>加入了<code>container</code>命令，<code>NewContainerCommand</code>的实现在<code>cli/command/container/cmd.go</code>中，在<code>NewContainerCommand</code>函数中通过<code>newListCommand(dockerCli)</code>加入了ls命令，可以看到还添加了很多别的方法，那些都是<code>container</code>支持的子命令。这样就回到了我们上面提到的内容了，没有魔法</p>
</blockquote>
<p>我们继续看<code>NewPsCommand</code>:</p>
<p>里面定义了<code>docker ps</code>（下面所有的内容对<code>docker container ls</code>都适用）支持的一些选项（flag）,选项被放在了psOptions这个结构体中，最终传给runPs函数.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">runPs</span><span class="params">(dockerCli *command.DockerCli, options *psOptions)</span> <span class="title">error</span></span> &#123;</div><div class="line">        ctx := context.Background()</div><div class="line"></div><div class="line">        listOptions, err := buildContainerListOptions(options)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        containers, err := dockerCli.Client().ContainerList(ctx, *listOptions)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        format := options.format</div><div class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(format) == <span class="number">0</span> &#123;</div><div class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(dockerCli.ConfigFile().PsFormat) &gt; <span class="number">0</span> &amp;&amp; !options.quiet &#123;</div><div class="line">                        format = dockerCli.ConfigFile().PsFormat</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        format = formatter.TableFormatKey</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        containerCtx := formatter.Context&#123;</div><div class="line">                Output: dockerCli.Out(),</div><div class="line">                Format: formatter.NewContainerFormat(format, options.quiet, listOptions.Size),</div><div class="line">                Trunc:  !options.noTrunc,</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> formatter.ContainerWrite(containerCtx, containers)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>listOptions, err := buildContainerListOptions(options)</code>对选项进行了处理，重点在<code>dockerCli.Client().ContainerList(ctx, *listOptions)</code>，<code>ContainerList</code>是一个interface。</p>
<p>实现在<code>vendor/github.com/docker/docker/client/container_list.go</code>（vendor在当前目录下，我是go新手，所以担心大家不知道，高手忽略）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *Client)</span> <span class="title">ContainerList</span><span class="params">(ctx context.Context, options types.ContainerListOptions)</span> <span class="params">([]types.Container, error)</span></span> &#123;</div><div class="line">        query := url.Values&#123;&#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.All &#123;</div><div class="line">                query.Set(<span class="string">"all"</span>, <span class="string">"1"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.Limit != <span class="number">-1</span> &#123;</div><div class="line">                query.Set(<span class="string">"limit"</span>, strconv.Itoa(options.Limit))</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.Since != <span class="string">""</span> &#123;</div><div class="line">                query.Set(<span class="string">"since"</span>, options.Since)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.Before != <span class="string">""</span> &#123;</div><div class="line">                query.Set(<span class="string">"before"</span>, options.Before)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.Size &#123;</div><div class="line">                query.Set(<span class="string">"size"</span>, <span class="string">"1"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.Filters.Len() &gt; <span class="number">0</span> &#123;</div><div class="line">                filterJSON, err := filters.ToParamWithVersion(cli.version, options.Filters)</div><div class="line"></div><div class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                query.Set(<span class="string">"filters"</span>, filterJSON)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        resp, err := cli.get(ctx, <span class="string">"/containers/json"</span>, query, <span class="literal">nil</span>)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> containers []types.Container</div><div class="line">        err = json.NewDecoder(resp.body).Decode(&amp;containers)</div><div class="line">        ensureReaderClosed(resp)</div><div class="line">        <span class="keyword">return</span> containers, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前面是在拼请求的参数，<code>resp, err := cli.get(ctx, &quot;/containers/json&quot;, query, nil)</code>这里发起了请求，返回了container的列表。我们可以通过curl或nc来获得原始的数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">➜  curl -XGET --unix-socket /var/run/docker.sock http://localhost/containers/json</div><div class="line">或者</div><div class="line">➜  echo 'GET /containers/json HTTP/1.0\r\n\r\n' | nc -U /var/run/docker.sock</div><div class="line"></div><div class="line">[&#123;"Id":"c64ea306f74980555521ad2fcbb4c54e1b05e7ca0d597838557d4d613ed12039","Names":["/brave_swirles"],"Image":"docker-cli-dev","ImageID":"sha256:b123a157eaf7e4d468647b42be4c8e339e9e4b9e84058a56575dbfa7249161c9","Command":"ash","Created":1505218585,"Ports":[],"Labels":&#123;&#125;,"State":"running","Status":"Up 25 hours","HostConfig":&#123;"NetworkMode":"default"&#125;,"NetworkSettings":&#123;"Networks":&#123;"bridge":&#123;"IPAMConfig":null,"Links":null,"Aliases":null,"NetworkID":"4b149c263b9a12caef2b16482db33fded74eac5396a57da1724428948464e00f","EndpointID":"6a3fb06309f2142b23db84303cbdb5d55b3a41e91cf2468649bd5f2adee11c66","Gateway":"172.17.0.1","IPAddress":"172.17.0.2","IPPrefixLen":16,"IPv6Gateway":"","GlobalIPv6Address":"","GlobalIPv6PrefixLen":0,"MacAddress":"02:42:ac:11:00:02","DriverOpts":null&#125;&#125;&#125;,"Mounts":[&#123;"Type":"bind","Source":"/Users/youwangqiu/go_code/src/github.com/docker/cli","Destination":"/go/src/github.com/docker/cli","Mode":"","RW":true,"Propagation":"rprivate"&#125;,&#123;"Type":"bind","Source":"/var/run/docker.sock","Destination":"/var/run/docker.sock","Mode":"","RW":true,"Propagation":"rprivate"&#125;]&#125;]</div></pre></td></tr></table></figure>
<p>可以看到数据是以json格式返回的，是一个列表。</p>
<p>回到<code>cli/command/container/list.go</code>，接收到返回值之后，这时候还是上面看到的json，下面进行了格式化输出，大家应该都有做打印<code>9*9乘法表</code>的经历，这里的格式化是同样的道理，不明白的同学可以继续往挖，我偷个懒，就不继续了。</p>
<p>至此<code>docker ps</code>的流程就走完了，大家可以对源码做一些修改，然后进到容器中执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make binary</div></pre></td></tr></table></figure>
<p>就可以生产新的docker client，执行一下就能得到想要的输出啦。</p>
<p>谢谢大家，欢迎大家指正🙂</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/Moby-LinuxKit-初体验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/Moby-LinuxKit-初体验/" itemprop="url">Moby & LinuxKit 初体验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T21:14:16+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Docker的开源部分被改名成了<a href="https://github.com/moby/moby" target="_blank" rel="external">Moby</a>，同时Docker公司还开源了一个<a href="https://github.com/linuxkit/linuxkit" target="_blank" rel="external">LinuxKit</a>的项目，大家可以先去看一下readme。</p>
<p>Moby是一个组装容器系统的框架。它包含一个容器化组件库和一个将这些组件组装成独立的容器系统的框架。目前，Docker正在被拆分成模块化的组件，将来，Docker会从这些被Moby打包的组件中被组装出来。</p>
<p>LinuxKit是一个用来构造最小Linux发行版的工具集。它通过Moby来创建镜像（image），使用LinuxKit工具来运行这些镜像。</p>
<p>下面我们来体验一下，首先确保你已经安装了<a href="https://docs.Docker.com/engine/installation/linux/docker-ce/ubuntu/#recommended-extra-packages-for-trusty-1404" target="_blank" rel="external">Docker</a>和<a href="https://golang.org/doc/install" target="_blank" rel="external">Golang</a>。</p>
<h3 id="构建Moby"><a href="#构建Moby" class="headerlink" title="构建Moby"></a>构建Moby</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">➜  git clone https://github.com/linuxkit/linuxkit.git</div><div class="line">➜  cd linuxkit</div><div class="line">➜  make &amp;&amp; sudo make install</div><div class="line">➜  moby version</div><div class="line">moby version 0.0</div><div class="line">commit: 1ff0e3beeeb1e741b9c5a54574f01ac5eee525a5</div></pre></td></tr></table></figure>
<h3 id="构建linux镜像"><a href="#构建linux镜像" class="headerlink" title="构建linux镜像"></a>构建linux镜像</h3><p>构建镜像是通过yaml文件（格式可以参考官方文档 <a href="https://github.com/moby/tool/blob/master/docs/yaml.md" target="_blank" rel="external">LinuxKit YAML</a>），linuxkit目录下有一个<code>linuxkit.yml</code>可以用，examples目录下也有很多可用的yaml文件，我们可以任选一个来构建，这里直接使用<code>linuxkit.yml</code>文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">➜  linuxkit git:(master) moby build linuxkit.yml</div><div class="line">最后在当前目录下输出了3个文件</div><div class="line">Create outputs:</div><div class="line">  linuxkit-kernel linuxkit-initrd.img linuxkit-cmdline</div></pre></td></tr></table></figure>
<h3 id="运行LinuxKit镜像"><a href="#运行LinuxKit镜像" class="headerlink" title="运行LinuxKit镜像"></a>运行LinuxKit镜像</h3><p>运行通过linuxkit自带的linuxkit命令，命令在linuxkit/bin目录下，我们只是体验，也没必要写PATH，就直接写全路径吧。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">➜  linuxkit git:(master) bin/linuxkit run linuxkit</div><div class="line">...满屏满屏的输出，最后是熟悉的🐳</div><div class="line">Welcome to LinuxKit</div><div class="line"></div><div class="line">                        ##         .</div><div class="line">                  ## ## ##        ==</div><div class="line">               ## ## ## ## ##    ===</div><div class="line">           /"""""""""""""""""\___/ ===</div><div class="line">          &#123;                       /  ===-</div><div class="line">           \______ O           __/</div><div class="line">             \    \         __/</div><div class="line">              \____\_______/</div><div class="line">...</div></pre></td></tr></table></figure>
<p>现在我们就是在我们自己构建的linux最小发行版里面了，敲几个命令试试吧，退出是<code>halt</code>。</p>
<p>这个镜像只有54M，可以说是非常小了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">➜  linuxkit git:(master) ls -alh | grep linuxkit</div><div class="line">-rw-r--r--  1 vagrant vagrant   42 Sep  7 11:52 linuxkit-cmdline</div><div class="line">-rw-r--r--  1 vagrant vagrant  54M Sep  7 11:52 linuxkit-initrd.img</div><div class="line">-rw-r--r--  1 vagrant vagrant 6.3M Sep  7 11:52 linuxkit-kernel</div><div class="line">drwxr-xr-x  2 vagrant vagrant 4.0K Sep  7 12:11 linuxkit-state</div><div class="line">-rw-rw-r--  1 vagrant vagrant 1.7K Sep  7 10:33 linuxkit.yml</div></pre></td></tr></table></figure>
<p>Moby和LinuxKit是非常不错的工具，但一般来说我们是用不上的。如果你需要构建定制的linux发行版，那他们可以节约很多时间。但如果你只是想将应用放在容器里跑起来，那还是直接用Docker吧！</p>
<p>另外，Moby和LinuxKit应该还没有成熟，命令一天一个变化（夸张了），如果你发现上面的命令失效了，建议google一下，或者联系我（知乎 or whaterver）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/浙江大学SEL实验室docker系列文章目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/浙江大学SEL实验室docker系列文章目录/" itemprop="url">浙江大学SEL实验室Docker系列文章目录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T17:24:33+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.sel.zju.edu.cn/?p=112" target="_blank" rel="external">DOCKER源码分析（一）：DOCKER架构</a>-2014.12.02</p>
<p><a href="http://www.sel.zju.edu.cn/?p=147" target="_blank" rel="external">DOCKER源码分析（二）：DOCKER CLIENT创建与命令执行</a>-2014.12.02</p>
<p><a href="http://www.sel.zju.edu.cn/?p=158" target="_blank" rel="external">DOCKER源码分析（三）：DOCKER DAEMON启动</a>-2014.12.02</p>
<p><a href="http://www.sel.zju.edu.cn/?p=165" target="_blank" rel="external">DOCKER源码分析（四）：DOCKER DAEMON之NEWDAEMON实现</a>-2014.12.02</p>
<p><a href="http://www.sel.zju.edu.cn/?p=259" target="_blank" rel="external">DOCKER源码分析（五）：DOCKER SERVER的创建</a>-2014.12.09</p>
<p><a href="http://www.sel.zju.edu.cn/?p=399" target="_blank" rel="external">DOCKER源码分析（六）：DOCKER DAEMON网络</a>-2015.01.05</p>
<p><a href="http://www.sel.zju.edu.cn/?p=508" target="_blank" rel="external">DOCKER源码分析（七）：DOCKER CONTAINER网络 （上）</a>-2015.01.26</p>
<p><a href="http://www.sel.zju.edu.cn/?p=537" target="_blank" rel="external">DOCKER源码分析（八）：DOCKER CONTAINER网络（下）</a>-2015.03.12</p>
<p><a href="http://www.sel.zju.edu.cn/?p=549" target="_blank" rel="external">DOCKER源码分析（九）：DOCKER镜像</a>-2015.03.12</p>
<p><a href="http://www.sel.zju.edu.cn/?p=444" target="_blank" rel="external">DOCKER网络详解及PIPEWORK源码解读与实践</a>-2015.01.16</p>
<p><a href="http://www.sel.zju.edu.cn/?p=556" target="_blank" rel="external">DOCKER背后的内核知识——NAMESPACE资源隔离</a>-2015.03.13</p>
<p><a href="http://www.sel.zju.edu.cn/?p=573" target="_blank" rel="external">DOCKER背后的内核知识——CGROUPS资源限制</a>-2015.04.22</p>
<p><a href="http://www.sel.zju.edu.cn/?p=577" target="_blank" rel="external">DOCKER背后的容器管理——LIBCONTAINER深度解析</a>-2015.06.03</p>
<p><a href="http://www.sel.zju.edu.cn/?p=296" target="_blank" rel="external">玩转DOCKER镜像</a>-2014.12.16</p>
<p><a href="http://www.sel.zju.edu.cn/?p=467" target="_blank" rel="external">深入理解ETCD技术分享PPT</a>-2015.01.20</p>
<p><a href="http://www.sel.zju.edu.cn/?p=523" target="_blank" rel="external">ETCD：从应用场景到实现原理的全方位解读</a>-2015.02.01</p>
<p><a href="http://www.sel.zju.edu.cn/?p=283" target="_blank" rel="external">GOOGLE KUBERNETES设计文档之安全篇</a>-2014.12.11</p>
<p><a href="http://www.sel.zju.edu.cn/?p=331" target="_blank" rel="external">GOOGLE KUBERNETES设计文档之POD篇</a>-2014.12.19</p>
<p><a href="http://www.sel.zju.edu.cn/?p=360" target="_blank" rel="external">GOOGLE KUBERNETES设计文档之服务篇</a>-2014.12.23</p>
<p><a href="http://www.sel.zju.edu.cn/?p=353" target="_blank" rel="external">GOOGLE KUBERNETES设计文档之网络篇</a>-2014.12.29</p>
<p><a href="http://www.sel.zju.edu.cn/?p=394" target="_blank" rel="external">GOOGLE KUBERNETES设计文档之VOLUMES</a>-2015.01.02</p>
<p><a href="http://www.sel.zju.edu.cn/?p=417" target="_blank" rel="external">KUBERNETES MINION NODE 组件 之 KUBELET</a>-2015.01.13</p>
<p><a href="http://www.sel.zju.edu.cn/?p=484" target="_blank" rel="external">KUBERNETES代码走读之MINION NODE 组件 KUBE-PROXY</a>-2015.01.22</p>
<p><a href="http://www.sel.zju.edu.cn/?p=588" target="_blank" rel="external">4S: SERVICES ACCOUNT, SECRET, SECURITY CONTEXT AND SECURITY IN KUBERNETES</a>-2015.07.30</p>
<p><a href="http://www.sel.zju.edu.cn/?p=595" target="_blank" rel="external">KUBERNETES NODE COMPONENTS – KUBELET</a>-2015.08.07</p>
<p><a href="http://www.sel.zju.edu.cn/?p=609" target="_blank" rel="external">KUBERNETES APISERVER源码分析——API请求的认证过程</a>-2015.08.09</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/02/python字符编码和字符串/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="You Wangqiu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/lufei.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Youmai の Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/02/python字符编码和字符串/" itemprop="url">python字符编码和字符串</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-02T22:35:33+08:00">
                2017-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>背景：我司代码都是基于python2</p>
<p>今天接到一个需求，用户提交的评论字数如果大于20个字要给用户发红包。毫不迟疑，我写下了下面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> len(content) &gt; <span class="number">20</span>:</div><div class="line">	<span class="comment"># 发红包</span></div></pre></td></tr></table></figure>
<p>我转念一想，事情不大对，我这算的是字符数（这个表述是正确的，是字符）啊</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">len(<span class="string">"abcd"</span>)  <span class="comment"># 等于4</span></div><div class="line">len(<span class="string">"I love python"</span>)  <span class="comment"># 等于13</span></div></pre></td></tr></table></figure>
<p>上面的例子显而易见，小学生水平，再看下面的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">len(<span class="string">"我爱北京天安门"</span>)  <span class="comment"># 这个该是多少呢？</span></div><div class="line">len(<span class="string">u"我爱北京天安门"</span>)  <span class="comment"># 这个又该是多少呢？</span></div></pre></td></tr></table></figure>
<p>大家可以本地打开python试一下，结果是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">len(<span class="string">"我爱北京天安门"</span>)  <span class="comment"># 等于21</span></div><div class="line">len(<span class="string">u"我爱北京天安门"</span>)  <span class="comment"># 等于7</span></div></pre></td></tr></table></figure>
<p>其实我想要的是下面这个，但是我在代码里直接那么写，我操作的字符串前面到底有没有<code>u</code>呢，这个<code>u</code>我知道是<code>unicode</code>字符串，它和没有<code>u</code>的字符串到底区别在哪里？</p>
<p>几年前我曾经下决心弄懂这个问题，可能当时也确实明白了，但是现在差不多已经全忘了。我自己总结了一下，一是之前一直是用python3，python3做了一些修改。二是这个问题确实不应该交给程序员来解决（我承认我的记性确实不好）。</p>
<p>然而，旧的系统那么多，难保你下次跳槽的公司没有一些上了年纪的代码，我们还是来梳理一下吧。</p>
<h2 id="字符与字节"><a href="#字符与字节" class="headerlink" title="字符与字节"></a>字符与字节</h2><p>一个字符不等价于一个字节，字符是人类能够识别的符号，而这些符号要保存到计算机的存储中就需要用计算机能够识别的字节来表示。一个字符往往有多种表示方法，不同的表示方法会使用不同的字节数。这里所说的不同的表示方法就是指<code>字符编码</code>，比如字母A-Z都可以用<code>ASCII</code>码表示（占用一个字节），也可以用<code>UNICODE</code>表示（占两个字节），还可以用<code>UTF-8</code>表示（占用一个字节）。字符编码的作用就是将人类可识别的字符转换为机器可识别的字节码，以及反向过程。</p>
<p><strong>UNICDOE才是真正的字符串，而用ASCII、UTF-8、GBK等字符编码表示的是字节串</strong>。关于这点，我们可以在Python的官方文档中经常可以看到这样的描述<strong>“Unicode string”</strong> , <strong>“translating a Unicode string into a sequence of bytes”</strong>。（注意：英文中string是我们说的字符串，bytes是字节串）</p>
<p>我们写<code>代码</code>是写在<code>文件</code>中的，而<code>字符</code>是以<code>字节</code>形式保存在<code>文件</code>中的，因此当我们在文件中定义个<code>字符串</code>时被当做<code>字节串</code>也是可以理解的。但是，我们需要的是<code>字符串</code>，而不是<code>字节串</code>（我们写代码处理的是我们能想象的数据，也就是字符串，应该不会有人想象字节串吧）。一个优秀的编程语言，应该严格区分两者的关系并提供巧妙的完美的支持。JAVA语言就很好，我认识的JAVA程序员从来没有考虑过这些不应该由程序员来处理的问题（我一直这么认为）。遗憾的是，很多编程语言试图混淆<code>“字符串”</code>和<code>“字节串”</code>，他们<em>把字节串当做字符串来使用</em>，PHP和Python2都属于这种编程语言。最能说明这个问题的操作就是取一个包含中文字符的字符串的长度：</p>
<ul>
<li>对<code>字符串</code>取长度，结果应该是所有<code>字符</code>的个数，无论中文还是英文</li>
<li>对<code>字符串</code>对应的<code>字节串</code>取长度，就跟编码(encode)过程使用的<code>字符编码</code>有关了(比如：<code>UTF-8编码</code>，一个<code>中文字符</code>需要用<code>3个字节</code>来表示；<code>GBK编码</code>，一个<code>中文字符</code>需要<code>2个字节</code>来表示)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">7</span>]: a = <span class="string">u"中国"</span></div><div class="line"></div><div class="line">In [<span class="number">9</span>]: <span class="keyword">print</span> len(a), type(a)</div><div class="line"><span class="number">2</span> &lt;type <span class="string">'unicode'</span>&gt;</div><div class="line"></div><div class="line">In [<span class="number">10</span>]: b = a.encode(<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">In [<span class="number">11</span>]: <span class="keyword">print</span> len(b), type(b)</div><div class="line"><span class="number">6</span> &lt;type <span class="string">'str'</span>&gt;</div><div class="line"></div><div class="line">In [<span class="number">12</span>]: c = a.encode(<span class="string">'gbk'</span>)</div><div class="line"></div><div class="line">In [<span class="number">13</span>]: <span class="keyword">print</span> len(c), type(c)</div><div class="line"><span class="number">4</span> &lt;type <span class="string">'str'</span>&gt;</div></pre></td></tr></table></figure>
<h2 id="编码与解码"><a href="#编码与解码" class="headerlink" title="编码与解码"></a>编码与解码</h2><p>UNICODE字符编码，也是一张字符与数字的映射，但是这里的数字被称为代码点(code point), 实际上就是十六进制的数字。</p>
<p><a href="https://docs.python.org/2/howto/unicode.html#encodings" target="_blank" rel="external">Python官方文档</a>中对Unicode字符串、字节串与编码之间的关系有这样一段描述：</p>
<pre><code>a Unicode string is a sequence of code points, which are numbers from 0 to 0x10ffff.
This sequence needs to be represented as a set of bytes (meaning, values from 0–255) in memory.
The rules for translating a Unicode string into a sequence of bytes are called an encoding.

Unicode字符串是一个代码点（code point）序列，代码点取值范围为0到0x10FFFF（对应的十进制为1114111）。
这个代码点序列在存储（包括内存和物理磁盘）中需要被表示为一组字节(0到255之间的值)，
而将Unicode字符串转换为字节序列的规则称为编码。
</code></pre><p>这里说的编码不是指字符编码，而是指<strong>编码的过程以及这个过程中所使用到的Unicode字符的代码点与字节的映射规则</strong>。这个映射不必是简单的一对一映射，因此编码过程也不必处理每个可能的Unicode字符，例如：</p>
<p>将<code>Unicode字符串</code>转换为<code>ASCII编码</code>的规则很简单–对于每个<code>代码点</code>：</p>
<ul>
<li>如果代码点数值&lt;128，则每个<code>字节</code>与代码点的值相同</li>
<li>如果代码点数值&gt;=128，则<code>Unicode字符</code>无法在此编码中进行表示（这种情况下，Python会引发一个<code>UnicodeEncodeError</code>异常）</li>
</ul>
<p>将<code>Unicode字符串</code>转换为<code>UTF-8编码</code>使用以下规则：</p>
<ul>
<li>如果代码点数值&lt;128，则由相应的<code>字节值</code>表示（与Unicode转ASCII字节一样）</li>
<li>如果代码点数值&gt;=128，则将其转换为一个2个字节，3个字节或4个字节的序列，该序列中的每个字节都在128到255之间。</li>
</ul>
<p>简单总结：</p>
<ul>
<li>编码(<code>encode</code>)：将<code>Unicode字符串</code>（中的代码点)转换特定<code>字符编码</code>对应的<code>字节串</code>的过程和规则</li>
<li>解码(decode)：将<strong>特定字符编码的字节串</strong>转换为对应的<strong>Unicode字符串</strong>(中的代码点)的过程和规则</li>
</ul>
<p>可见，无论是编码还是解码，都需要一个重要因素，就是特定的字符编码。因为一个字符用不同的字符编码进行编码后的字节值以及字节个数大部分情况下是不同的，反之亦然。</p>
<p>而且很容易看到，编码和解码都是基于<strong>Unicode字符串</strong>，<em>没有第二种字符串掺和</em>，其他都是编码方式，一定要深刻地认识到这一点。</p>
<h2 id="Python编码"><a href="#Python编码" class="headerlink" title="Python编码"></a>Python编码</h2><h3 id="Python源代码文件的执行过程"><a href="#Python源代码文件的执行过程" class="headerlink" title="Python源代码文件的执行过程"></a>Python源代码文件的执行过程</h3><p>我们都知道，磁盘上的文件都是以<code>二进制格式</code>存放的，其中<code>文本文件</code>都是以<code>某种特定编码</code>的<code>字节</code>形式存放的。对于程序源代码文件的字符编码是由编辑器指定的，比如我们使用vim来编写Python程序时会指定文件编码为UTF-8，那么Python代码被保存到磁盘时就会被转换为UTF-8编码对应的字节（encode过程）后写入磁盘。当执行Python代码文件中的代码时，Python解释器在读取Python代码文件中的字节串之后，需要将其转换为UNICODE字符串（decode过程）之后才执行后续操作。</p>
<p>上面已经解释过，这个转换过程（decode，解码）需要我们指定文件中保存的字节使用的字符编码是什么，才能知道这些字节在UNICODE这张万国码和统一码中找到其对应的代码点是什么。这里指定字符编码的方式大家都很熟悉，一图胜千言：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div></pre></td></tr></table></figure>
<p><img src="/img/python_source_file_execute.png" alt="python源文件文件的执行过程"></p>
<h3 id="默认编码"><a href="#默认编码" class="headerlink" title="默认编码"></a>默认编码</h3><p>那么，如果我们没有在代码文件开始的部分指定字符编码，Python解释器会使用哪种字符编码把从代码文件中读取到的字节转换为<strong>UNICODE代码点</strong>呢？就像我们配置某些软件时，有很多默认选项一样，Python解释器内部设置了默认的<code>字符编码</code>。因此大家所说的Python中文字符问题就可以总结为一句话：当无法通过<strong>默认的字符编码</strong>对字节进行转换时，就会出现解码错误(UnicodeEncodeError)。</p>
<p>Python2和Python3的解释器使用的默认编码是不一样的，我们可以通过<code>sys.getdefaultencoding()</code>来获取默认编码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># python2</span></div><div class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> sys</div><div class="line"></div><div class="line">In [<span class="number">2</span>]: sys.getdefaultencoding()</div><div class="line">Out[<span class="number">3</span>]: <span class="string">'ascii'</span></div><div class="line"></div><div class="line"><span class="comment"># python3</span></div><div class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> sys</div><div class="line"></div><div class="line">In [<span class="number">2</span>]: sys.getdefaultencoding()</div><div class="line">Out[<span class="number">3</span>]: <span class="string">'utf-8'</span></div></pre></td></tr></table></figure>
<p>因此，对于Python2来讲，Python解释器在读取到中文字符的字节码尝试解码操作时，会先查看当前代码文件头部是否有指明当前代码文件中保存的字节码对应的字符编码是什么。如果没有指定则使用默认字符编码”ASCII”进行解码导致解码失败，导致如下错误：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SyntaxError: Non-ASCII character <span class="string">'\xc4'</span> <span class="keyword">in</span> file xxx.py on line <span class="number">11</span>, but no encoding declared; see http://python.org/dev/peps/pep<span class="number">-0263</span>/ <span class="keyword">for</span> details</div></pre></td></tr></table></figure>
<p>对于Python3来讲，执行过程是一样的，只是Python3的解释器以”UTF-8”作为默认编码，但是这并不表示可以完全兼容中文问题。比如我们在Windows上进行开发时，Python工程及代码文件都使用的是默认的GBK编码，也就是说Python代码文件是被转换成GBK格式的字节码保存到磁盘中的。Python3的解释器执行该代码文件时，试图用UTF-8进行解码操作时，同样会解码失败，导致如下错误：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SyntaxError: Non-UTF<span class="number">-8</span> code starting <span class="keyword">with</span> <span class="string">'\xc4'</span> <span class="keyword">in</span> file xxx.py on line <span class="number">11</span>, but no encoding declared; see http://python.org/dev/peps/pep<span class="number">-0263</span>/ <span class="keyword">for</span> details</div></pre></td></tr></table></figure>
<h2 id="再谈python2和python3中的字符串"><a href="#再谈python2和python3中的字符串" class="headerlink" title="再谈python2和python3中的字符串"></a>再谈python2和python3中的字符串</h2><p>其实Python3中对字符串支持的改进，不仅仅是更改了默认编码，而是重新进行了字符串的实现，而且它已经实现了<strong>对UNICODE的内置支持</strong>，从这方面来讲Python已经和JAVA等语言一样优秀。下面我们来看下Python2与Python3中对字符串的支持有什么区别：</p>
<h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><p>Python2中对字符串的支持由以下三个类提供</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">basestring</span><span class="params">(object)</span></span></div><div class="line"><span class="class"><span class="title">class</span> <span class="title">str</span><span class="params">(basestring)</span></span></div><div class="line"><span class="class"><span class="title">class</span> <span class="title">unicode</span><span class="params">(basestring)</span></span></div></pre></td></tr></table></figure>
<p>执行<code>help(str)</code>和<code>help(bytes)</code>会发现结果都是<code>str类</code>的定义，这也说明Python2中str就是<strong>字节串</strong>，而后来的<strong>unicode对象对应才是真正的字符串</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: a = <span class="string">"中国"</span></div><div class="line"></div><div class="line">In [<span class="number">2</span>]: b = <span class="string">u"中国"</span></div><div class="line"></div><div class="line">In [<span class="number">3</span>]: <span class="keyword">print</span> type(a), len(a)</div><div class="line">&lt;type <span class="string">'str'</span>&gt; <span class="number">6</span></div><div class="line"></div><div class="line">In [<span class="number">4</span>]: <span class="keyword">print</span> type(b), len(b)</div><div class="line">&lt;type <span class="string">'unicode'</span>&gt; <span class="number">2</span></div></pre></td></tr></table></figure>
<h3 id="python3"><a href="#python3" class="headerlink" title="python3"></a>python3</h3><p>Python3中对字符串的支持进行了实现类层次的上简化，去掉了unicode类，添加了一个bytes类。从表面上来看，可以认为Python3中的str和unicode合二为一了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">bytes</span><span class="params">(object)</span></span></div><div class="line"><span class="class"><span class="title">class</span> <span class="title">str</span><span class="params">(object)</span></span></div></pre></td></tr></table></figure>
<p>实际上，Python3中已经意识到之前的错误，开始明确的区分字符串与字节。因此Python3中的str已经是真正的字符串，而字节是用单独的bytes类来表示。也就是说，Python3默认定义的就是字符串，实现了对UNICODE的内置支持，减轻了程序员对字符串处理的负担。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: a = <span class="string">"中国"</span></div><div class="line"></div><div class="line">In [<span class="number">2</span>]: b = <span class="string">u"中国"</span></div><div class="line"></div><div class="line">In [<span class="number">3</span>]: c = a.encode(<span class="string">"gbk"</span>)</div><div class="line"></div><div class="line">In [<span class="number">4</span>]: print(type(a), len(a))</div><div class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt; 2</span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">In</span> [5]:</span> print(type(b), len(b))</div><div class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt; 2</span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">In</span> [6]:</span> print(type(c), len(c))</div><div class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">bytes</span>'&gt; 4</span></div></pre></td></tr></table></figure>
<h2 id="字符编码转换"><a href="#字符编码转换" class="headerlink" title="字符编码转换"></a>字符编码转换</h2><p>上面提到，UNICODE字符串可以与任意字符编码的字节进行相互转换，如图：</p>
<p><img src="/img/unicode_string.png" alt="unicode 字符串"></p>
<p>那么大家很容易想到一个问题，就是不同的字符编码的字节可以通过Unicode相互转换吗？答案是肯定的。</p>
<p><strong>Python2中的字符串进行字符编码转换过程是</strong>：</p>
<p>字节串–&gt;decode(‘原来的字符编码’)–&gt;Unicode字符串–&gt;encode(‘新的字符编码’)–&gt;字节串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: a = <span class="string">"中国"</span>  <span class="comment"># utf-8编码的字节串</span></div><div class="line"></div><div class="line">In [<span class="number">2</span>]: b = a.decode(<span class="string">'utf-8'</span>).encode(<span class="string">'gbk'</span>)  <span class="comment"># 先转换成unicode字符串，再进行gbk编码</span></div><div class="line"></div><div class="line">In [<span class="number">3</span>]: <span class="keyword">print</span> b.decode(<span class="string">'gbk'</span>)  <span class="comment"># 解码成unicode字符串</span></div><div class="line">中国</div></pre></td></tr></table></figure>
<p><strong>Python3中定义的字符串默认就是unicode，因此不需要先解码，可以直接编码成新的字符编码：</strong></p>
<p>字符串–&gt;encode(‘新的字符编码’)–&gt;字节串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: a = <span class="string">"中国"</span></div><div class="line"></div><div class="line">In [<span class="number">2</span>]: b = a.encode(<span class="string">"gbk"</span>)</div><div class="line"></div><div class="line">In [<span class="number">3</span>]: print(b.decode(<span class="string">"gbk"</span>))</div><div class="line">中国</div></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>python字符串编码差不多就是这些内容了，搞清楚原理其实记忆也不难。祝大家不会再掉到python字符编码的坑中，祝我司能尽快迁移到python3！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/lufei.jpeg"
               alt="You Wangqiu" />
          <p class="site-author-name" itemprop="name">You Wangqiu</p>
           
              <p class="site-description motion-element" itemprop="description">世之奇伟、瑰怪，非常之观，常在于险远，而人之所罕至焉，故非有志者不能至也</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">163</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/michaelyou" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/zhi-yu-65-2" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      知乎
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="michaelseu2011@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">You Wangqiu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
